<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpitar - Rodada</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: white; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .status-info { background: #F8F9FA; border-radius: 8px; padding: 15px; margin-bottom: 25px; border-left: 4px solid #4CAF50; }
        .jogo { background: #F8F9FA; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #E0E0E0; }
        .jogo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .times { font-size: 18px; font-weight: 600; }
        .pd-star { font-size: 28px; cursor: pointer; color: #BDC3C7; }
        .pd-selected { color: #FFD700; }
        .placar-inputs { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .input-placar { width: 70px; height: 60px; font-size: 28px; text-align: center; border: 2px solid #3498DB; border-radius: 10px; font-weight: bold; }
        .btn-acoes { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 16px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-enviar { background: #27AE60; color: white; }
        .btn-cancelar { background: #E74C3C; color: white; }
        .erro { background: #FDEDED; color: #E74C3C; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Rodada <span id="numero-rodada">0</span></h2>
        </div>
        
        <div class="status-info">
            <div id="horario-text">⏰ Carregando horário...</div>
            <div id="trunfo-text">⏳ Verificando trunfo...</div>
        </div>

        <div class="erro" id="mensagem-erro"></div>
        <div id="lista-jogos"></div>
        
        <div class="btn-acoes">
            <button class="btn btn-enviar" id="btn-enviar">✅ Enviar</button>
            <button class="btn btn-cancelar" id="btn-cancelar">❌ Sair</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let estado = { rodada: null, usuario: null, trunfo: false, pdJogoId: null, jogos: [], palpites: {} };

        // FUNÇÃO CRÍTICA: Força o fuso de Brasília indepedente do telemóvel
        function converterParaBrasilia(dataStr) {
            if (!dataStr) return null;
            let d = dataStr.replace(' ', 'T');
            if (!d.includes('-')) d += '-03:00'; // Força UTC-3
            return new Date(d);
        }

        function renderizar() {
            const container = document.getElementById('lista-jogos');
            container.innerHTML = '';
            estado.jogos.forEach(jogo => {
                const palpite = estado.palpites[jogo.id] || { mandante: '', visitante: '' };
                const div = document.createElement('div');
                div.className = 'jogo';
                div.innerHTML = `
                    <div class="jogo-header">
                        <span class="times">${jogo.mandante} x ${jogo.visitante}</span>
                        <span class="pd-star ${estado.pdJogoId == jogo.id ? 'pd-selected' : ''}" onclick="setPD(${jogo.id})">⭐</span>
                    </div>
                    <div class="placar-inputs">
                        <input type="number" class="input-placar" value="${palpite.mandante}" oninput="setPalpite(${jogo.id},'mandante',this.value)">
                        <span>X</span>
                        <input type="number" class="input-placar" value="${palpite.visitante}" oninput="setPalpite(${jogo.id},'visitante',this.value)">
                    </div>`;
                container.appendChild(div);
            });
        }

        window.setPalpite = (id, t, v) => {
            if (!estado.palpites[id]) estado.palpites[id] = { mandante:'', visitante:'', pd: false };
            estado.palpites[id][t] = v;
        };

        window.setPD = (id) => {
            estado.pdJogoId = (estado.pdJogoId == id) ? null : id;
            renderizar();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const dados = JSON.parse(atob(urlParams.get('data')));
            
            estado = { ...estado, ...dados };
            const limite = converterParaBrasilia(dados.rodada.horario_fechamento);
            const agora = new Date();

            document.getElementById('numero-rodada').textContent = dados.rodada.numero;
            document.getElementById('horario-text').textContent = "Fecha (Brasília): " + limite.toLocaleTimeString('pt-BR');
            document.getElementById('trunfo-text').textContent = dados.trunfo ? "Trunfo: ATIVO" : "Trunfo: Não";

            // Verificação de bloqueio
            if (agora > limite && !dados.trunfo) {
                document.getElementById('mensagem-erro').style.display = 'block';
                document.getElementById('mensagem-erro').textContent = "HORÁRIO ENCERRADO (Brasília)";
                document.getElementById('btn-enviar').disabled = true;
                document.getElementById('btn-enviar').style.opacity = "0.5";
            }

            renderizar();
            if (window.Telegram) Telegram.WebApp.ready();
        });

        document.getElementById('btn-enviar').onclick = () => {
            const payload = { tipo: 'enviar_palpites', usuario: estado.usuario, rodada: estado.rodada, palpites: estado.palpites, pd_jogo_id: estado.pdJogoId };
            Telegram.WebApp.sendData(JSON.stringify(payload));
        };
        
        document.getElementById('btn-cancelar').onclick = () => Telegram.WebApp.close();
    </script>
</body>
</html>
