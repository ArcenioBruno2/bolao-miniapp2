<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpitar - Rodada</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .titulo-rodada {
            color: #2C3E50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .subtitulo {
            color: #7F8C8D;
            font-size: 16px;
        }
        
        .status-info {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            border-left: 4px solid #4CAF50;
        }
        
        .trunfo-status {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2C3E50;
        }
        
        .pd-status {
            font-weight: 600;
            color: #2C3E50;
        }
        
        .pd-usada {
            color: #E74C3C;
        }
        
        .pd-disponivel {
            color: #27AE60;
        }
        
        .lista-jogos {
            margin-bottom: 30px;
        }
        
        .jogo {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #E0E0E0;
        }
        
        .jogo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .times {
            font-size: 18px;
            font-weight: 600;
            color: #2C3E50;
        }
        
        .pd-star {
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            color: #FFD700;
        }
        
        .pd-star:hover {
            transform: scale(1.2);
        }
        
        .pd-selected {
            color: #FFD700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        .pd-disabled {
            color: #BDC3C7;
            cursor: not-allowed;
        }
        
        .placar-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .time-input {
            text-align: center;
        }
        
        .time-nome {
            font-size: 14px;
            color: #7F8C8D;
            margin-bottom: 5px;
        }
        
        .input-placar {
            width: 60px;
            height: 50px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #3498DB;
            border-radius: 8px;
            outline: none;
        }
        
        .input-placar:focus {
            border-color: #2980B9;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .vs {
            font-size: 20px;
            font-weight: 600;
            color: #2C3E50;
        }
        
        .botoes-numeros {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn-numero {
            width: 40px;
            height: 40px;
            border: 2px solid #3498DB;
            background: white;
            color: #3498DB;
            border-radius: 50%;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-numero:hover {
            background: #3498DB;
            color: white;
        }
        
        .btn-numero-selected {
            background: #3498DB;
            color: white;
        }
        
        .btn-acoes {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn-enviar {
            background: #27AE60;
            color: white;
        }
        
        .btn-enviar:hover {
            background: #219653;
        }
        
        .btn-enviar:disabled {
            background: #BDC3C7;
            cursor: not-allowed;
        }
        
        .btn-cancelar {
            background: #E74C3C;
            color: white;
        }
        
        .btn-cancelar:hover {
            background: #C0392B;
        }
        
        .instrucoes {
            margin-top: 25px;
            padding: 15px;
            background: #E8F4FC;
            border-radius: 8px;
            border-left: 4px solid #3498DB;
        }
        
        .instrucoes h3 {
            color: #2C3E50;
            margin-bottom: 10px;
        }
        
        .instrucoes ul {
            padding-left: 20px;
        }
        
        .instrucoes li {
            margin-bottom: 8px;
            color: #34495E;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7F8C8D;
        }
        
        .erro {
            background: #FDEDED;
            color: #E74C3C;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #E74C3C;
            display: none;
        }
        
        .sucesso {
            background: #EDF7ED;
            color: #27AE60;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #27AE60;
            display: none;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .placar-inputs {
                gap: 10px;
            }
            
            .input-placar {
                width: 50px;
                height: 45px;
                font-size: 20px;
            }
            
            .btn-acoes {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="titulo-rodada">Rodada <span id="numero-rodada">0</span></h1>
            <p class="subtitulo">Preencha seus palpites abaixo</p>
        </div>
        
        <div class="status-info">
            <div class="trunfo-status" id="trunfo-status">‚è≥ Verificando trunfo...</div>
            <div class="pd-status" id="pd-status">‚è≥ Verificando pontua√ß√£o dobrada...</div>
        </div>
        
        <div class="erro" id="mensagem-erro"></div>
        <div class="sucesso" id="mensagem-sucesso"></div>
        
        <div class="lista-jogos" id="lista-jogos">
            <div class="loading">Carregando jogos...</div>
        </div>
        
        <div class="btn-acoes">
            <button class="btn btn-enviar" id="btn-enviar">‚úÖ Confirmar Palpites</button>
            <button class="btn btn-cancelar" id="btn-cancelar">‚ùå Cancelar</button>
        </div>
        
        <div class="instrucoes">
            <h3>üìù Instru√ß√µes:</h3>
            <ul>
                <li>Selecione os placares usando os bot√µes ou digite diretamente</li>
                <li><span style="color: #FFD700; font-weight: bold;">‚≠ê Estrela</span> = Pontua√ß√£o Dobrada (apenas 1 por rodada)</li>
                <li>Se j√° usou a pontua√ß√£o dobrada, a estrela ficar√° desabilitada</li>
                <li>Voc√™ pode editar seus palpites at√© o hor√°rio limite</li>
            </ul>
        </div>
    </div>

    <script>
        // Par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const rodadaId = urlParams.get('rodada');
        const usuarioId = urlParams.get('usuario');
        const token = urlParams.get('token');
        
        // Estado da aplica√ß√£o
        let estado = {
            rodada: null,
            usuario: null,
            trunfo: false,
            pdDisponivel: false,
            pdJogoId: null,
            jogos: [],
            palpites: {},
            carregando: true
        };
        
        // Elementos DOM
        const listaJogos = document.getElementById('lista-jogos');
        const trunfoStatus = document.getElementById('trunfo-status');
        const pdStatus = document.getElementById('pd-status');
        const btnEnviar = document.getElementById('btn-enviar');
        const btnCancelar = document.getElementById('btn-cancelar');
        const mensagemErro = document.getElementById('mensagem-erro');
        const mensagemSucesso = document.getElementById('mensagem-sucesso');
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            if (!rodadaId || !usuarioId || !token) {
                mostrarErro('‚ùå Par√¢metros inv√°lidos na URL. Tente abrir a rodada novamente.');
                return;
            }
            
            await carregarDados();
            renderizarJogos();
        });
        
        // Fun√ß√£o para carregar dados da rodada do backend
        async function carregarDados() {
            try {
                // Aqui voc√™ faria uma requisi√ß√£o para o backend
                // Por enquanto, simulamos com dados fixos
                
                // Simula√ß√£o: carrega dados da rodada
                estado.rodada = {
                    id: parseInt(rodadaId),
                    numero: parseInt(rodadaId),
                    horario_fechamento: '2024-12-25 20:00:00'
                };
                
                // Simula√ß√£o: verifica trunfo
                estado.trunfo = false;
                
                // Simula√ß√£o: verifica PD dispon√≠vel
                estado.pdDisponivel = true;
                
                // Simula√ß√£o: carrega jogos (apenas futuros)
                estado.jogos = [
                    { id: 1, mandante: 'Cruzeiro', visitante: 'Mirassol' },
                    { id: 2, mandante: 'Atl√©tico-MG', visitante: 'Cebolinha' },
                    { id: 3, mandante: 'Botafogo', visitante: 'Flamengo' }
                ];
                
                // Simula√ß√£o: carrega palpites anteriores (se existirem)
                estado.palpites = {};
                estado.jogos.forEach(jogo => {
                    estado.palpites[jogo.id] = { mandante: '', visitante: '', pd: false };
                });
                
                atualizarStatus();
                estado.carregando = false;
                
            } catch (error) {
                mostrarErro('‚ùå Erro ao carregar dados: ' + error.message);
            }
        }
        
        // Atualiza informa√ß√µes de status
        function atualizarStatus() {
            // Atualiza status do trunfo
            if (estado.trunfo) {
                trunfoStatus.innerHTML = '‚úÖ <strong>VOC√ä TEM TRUNFO</strong> - Tempo extra para palpitar';
            } else {
                trunfoStatus.innerHTML = '‚ùå <strong>SEM TRUNFO</strong> - Hor√°rio normal';
            }
            
            // Atualiza status da PD
            if (estado.pdJogoId) {
                pdStatus.innerHTML = '‚≠ê <strong>PONTUA√á√ÉO DOBRADA USADA</strong> neste jogo';
                estado.pdDisponivel = false;
            } else if (estado.pdDisponivel) {
                pdStatus.innerHTML = '‚≠ê <strong>PONTUA√á√ÉO DOBRADA DISPON√çVEL</strong> (clique na estrela)';
            } else {
                pdStatus.innerHTML = '‚ùå <strong>SEM PONTUA√á√ÉO DOBRADA</strong> para esta rodada';
            }
            
            // Atualiza t√≠tulo
            document.getElementById('numero-rodada').textContent = estado.rodada.numero;
        }
        
        // Renderiza a lista de jogos
        function renderizarJogos() {
            if (estado.carregando) return;
            
            listaJogos.innerHTML = '';
            
            estado.jogos.forEach(jogo => {
                const jogoElement = document.createElement('div');
                jogoElement.className = 'jogo';
                jogoElement.dataset.jogoId = jogo.id;
                
                const palpiteAtual = estado.palpites[jogo.id] || { mandante: '', visitante: '', pd: false };
                const temPD = estado.pdJogoId === jogo.id;
                const podeUsarPD = estado.pdDisponivel && !estado.pdJogoId;
                
                jogoElement.innerHTML = `
                    <div class="jogo-header">
                        <div class="times">${jogo.mandante} x ${jogo.visitante}</div>
                        <div class="pd-star ${temPD ? 'pd-selected' : ''} ${!podeUsarPD ? 'pd-disabled' : ''}" 
                             onclick="${podeUsarPD ? `selecionarPD(${jogo.id})` : ''}">
                            ${temPD ? '‚≠ê' : (podeUsarPD ? '‚òÜ' : '‚≠ê')}
                        </div>
                    </div>
                    
                    <div class="placar-inputs">
                        <div class="time-input">
                            <div class="time-nome">${jogo.mandante}</div>
                            <input type="number" min="0" max="9" 
                                   class="input-placar mandante" 
                                   value="${palpiteAtual.mandante || ''}"
                                   onchange="atualizarPalpite(${jogo.id}, 'mandante', this.value)"
                                   placeholder="0">
                        </div>
                        
                        <div class="vs">X</div>
                        
                        <div class="time-input">
                            <div class="time-nome">${jogo.visitante}</div>
                            <input type="number" min="0" max="9" 
                                   class="input-placar visitante" 
                                   value="${palpiteAtual.visitante || ''}"
                                   onchange="atualizarPalpite(${jogo.id}, 'visitante', this.value)"
                                   placeholder="0">
                        </div>
                    </div>
                    
                    <div class="botoes-numeros">
                        ${[0,1,2,3,4,5].map(num => `
                            <button class="btn-numero ${palpiteAtual.mandante == num ? 'btn-numero-selected' : ''}"
                                    onclick="selecionarPlacar(${jogo.id}, 'mandante', ${num})">
                                ${num}
                            </button>
                        `).join('')}
                        
                        <div style="width: 20px;"></div>
                        
                        ${[0,1,2,3,4,5].map(num => `
                            <button class="btn-numero ${palpiteAtual.visitante == num ? 'btn-numero-selected' : ''}"
                                    onclick="selecionarPlacar(${jogo.id}, 'visitante', ${num})">
                                ${num}
                            </button>
                        `).join('')}
                    </div>
                `;
                
                listaJogos.appendChild(jogoElement);
            });
        }
        
        // Fun√ß√µes para manipular palpites
        window.selecionarPlacar = function(jogoId, tipo, valor) {
            const jogoElement = document.querySelector(`[data-jogo-id="${jogoId}"]`);
            const botoes = jogoElement.querySelectorAll(`.btn-numero`);
            botoes.forEach(btn => btn.classList.remove('btn-numero-selected'));
            
            const btnClicado = jogoElement.querySelector(`.btn-numero[onclick*="'${tipo}', ${valor}"]`);
            if (btnClicado) {
                btnClicado.classList.add('btn-numero-selected');
            }
            
            const input = jogoElement.querySelector(`.input-placar.${tipo}`);
            input.value = valor;
            
            atualizarPalpite(jogoId, tipo, valor);
        };
        
        window.atualizarPalpite = function(jogoId, tipo, valor) {
            if (!estado.palpites[jogoId]) {
                estado.palpites[jogoId] = { mandante: '', visitante: '', pd: false };
            }
            
            estado.palpites[jogoId][tipo] = valor === '' ? '' : parseInt(valor);
            
            if (valor !== '') {
                const jogoElement = document.querySelector(`[data-jogo-id="${jogoId}"]`);
                const botoes = jogoElement.querySelectorAll(`.btn-numero`);
                botoes.forEach(btn => btn.classList.remove('btn-numero-selected'));
                
                const btnParaSelecionar = jogoElement.querySelector(`.btn-numero[onclick*="'${tipo}', ${parseInt(valor)}"]`);
                if (btnParaSelecionar) {
                    btnParaSelecionar.classList.add('btn-numero-selected');
                }
            }
        };
        
        window.selecionarPD = function(jogoId) {
            if (!estado.pdDisponivel || estado.pdJogoId) return;
            
            // Remove PD anterior (se houver)
            if (estado.pdJogoId) {
                const estrelaAnterior = document.querySelector(`[data-jogo-id="${estado.pdJogoId}"] .pd-star`);
                if (estrelaAnterior) {
                    estrelaAnterior.classList.remove('pd-selected');
                    estado.palpites[estado.pdJogoId].pd = false;
                }
            }
            
            // Adiciona PD ao jogo selecionado
            estado.pdJogoId = jogoId;
            estado.palpites[jogoId].pd = true;
            
            const estrela = document.querySelector(`[data-jogo-id="${jogoId}"] .pd-star`);
            estrela.classList.add('pd-selected');
            estrela.innerHTML = '‚≠ê';
            
            // Desabilita PD em outros jogos
            document.querySelectorAll('.pd-star').forEach(star => {
                if (!star.classList.contains('pd-selected')) {
                    star.classList.add('pd-disabled');
                    star.onclick = null;
                    star.style.cursor = 'not-allowed';
                    star.innerHTML = '‚≠ê';
                }
            });
            
            estado.pdDisponivel = false;
            atualizarStatus();
        };
        
        // Enviar palpites
        btnEnviar.addEventListener('click', async () => {
            try {
                // Valida√ß√£o b√°sica
                for (const jogo of estado.jogos) {
                    const palpite = estado.palpites[jogo.id];
                    if (!palpite || palpite.mandante === '' || palpite.visitante === '') {
                        mostrarErro(`‚ùå Preencha o placar completo para: ${jogo.mandante} x ${jogo.visitante}`);
                        return;
                    }
                }
                
                btnEnviar.disabled = true;
                btnEnviar.innerHTML = '‚è≥ Enviando...';
                
                // Prepara dados para enviar ao bot
                const dados = {
                    rodada_id: estado.rodada.id,
                    usuario_id: usuarioId,
                    token: token,
                    palpites: estado.palpites
                };
                
                console.log('Dados a enviar:', dados);
                
                // Envia dados ao bot via Telegram Web App
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.sendData(JSON.stringify(dados));
                    
                    // Aguarda um pouco e fecha
                    setTimeout(() => {
                        window.Telegram.WebApp.close();
                    }, 1500);
                } else {
                    // Fallback se n√£o estiver no Telegram
                    mostrarSucesso('‚úÖ Palpites confirmados! Feche a janela.');
                    setTimeout(() => {
                        window.close();
                    }, 2000);
                }
                
            } catch (error) {
                mostrarErro('‚ùå Erro ao enviar palpites: ' + error.message);
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '‚úÖ Confirmar Palpites';
            }
        });
        
        // Cancelar
        btnCancelar.addEventListener('click', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                window.close();
            }
        });
        
        // Fun√ß√µes auxiliares
        function mostrarErro(mensagem) {
            mensagemErro.textContent = mensagem;
            mensagemErro.style.display = 'block';
            mensagemSucesso.style.display = 'none';
        }
        
        function mostrarSucesso(mensagem) {
            mensagemSucesso.textContent = mensagem;
            mensagemSucesso.style.display = 'block';
            mensagemErro.style.display = 'none';
        }
        
        // Integra√ß√£o com Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();
        }
    </script>
</body>
</html>
