<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bol√£o - Palpites</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; color: #333; padding: 15px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .status-card { background: #e8f5e9; border-radius: 10px; padding: 12px; margin-bottom: 20px; font-size: 14px; border-left: 5px solid #4CAF50; }
        
        .jogo-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .jogo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .times-nomes { font-weight: bold; font-size: 16px; color: #2c3e50; flex: 1; }
        
        /* Estrelas do PD */
        .pd-wrapper { cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .star-icon { font-size: 28px; color: #ccc; transition: all 0.3s; filter: grayscale(1); }
        .star-icon.active { color: #ffc107; filter: grayscale(0); transform: scale(1.2); text-shadow: 0 0 10px rgba(255, 193, 7, 0.6); }
        .pd-label { font-size: 9px; font-weight: bold; margin-top: 2px; color: #999; }
        .star-icon.active + .pd-label { color: #ffc107; }

        .placar-container { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .input-placar { width: 65px; height: 55px; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 24px; font-weight: bold; outline: none; transition: border-color 0.3s; }
        .input-placar:focus { border-color: #4CAF50; background: #f9fff9; }
        .vs-text { font-weight: bold; color: #999; font-size: 18px; }

        .footer-btns { display: flex; gap: 10px; margin-top: 25px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn-send { background: #4CAF50; color: white; }
        .btn-send:disabled { background: #cccccc; color: #666; cursor: not-allowed; }
        .btn-cancel { background: #f44336; color: white; }
        .btn:active { opacity: 0.8; }
        
        .error-msg { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; text-align: center; font-weight: bold; }
        
        .info-pd { background: #fff8e1; border: 1px solid #ffd54f; border-radius: 8px; padding: 10px; margin-bottom: 15px; font-size: 13px; color: #5d4037; }
        
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            ‚è≥ Carregando rodada...
        </div>
        
        <div id="content" style="display: none;">
            <div class="header">
                <h3>Rodada <span id="rodada-num">--</span></h3>
            </div>

            <div id="error-box" class="error-msg"></div>

            <div class="status-card">
                <div id="txt-horario">‚è∞ Carregando hor√°rio...</div>
                <div id="txt-trunfo">üÉè Verificando trunfo...</div>
            </div>

            <div id="info-pd-usada" class="info-pd" style="display: none;">
                ‚≠ê <strong>PD j√° usada</strong> em: <span id="pd-jogo-info"></span>
            </div>

            <div id="lista-jogos"></div>

            <div class="footer-btns">
                <button class="btn btn-cancel" id="btn-sair">Sair</button>
                <button class="btn btn-send" id="btn-confirmar">Enviar Palpites</button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let tg = window.Telegram.WebApp;
        let dadosOriginais = {};
        let pdSelecionado = null;
        let palpites = {};
        let totalJogos = 0;

        // Fun√ß√£o para parsear datas do Brasil
        function parseDataBrasilia(str) {
            if (!str) return null;
            
            try {
                // Se j√° √© uma string ISO com timezone
                if (str.includes('T') && (str.includes('+') || str.includes('Z'))) {
                    return new Date(str);
                }
                
                // Se √© uma string sem timezone, adiciona -03:00 (Bras√≠lia)
                if (str.includes('T')) {
                    return new Date(str + '-03:00');
                }
                
                // Se √© uma string no formato do banco (YYYY-MM-DD HH:MM:SS)
                return new Date(str.replace(' ', 'T') + '-03:00');
                
            } catch (e) {
                console.error('Erro ao parsear data:', str, e);
                return null;
            }
        }

        function togglePD(jogoId) {
            // Se j√° tem PD selecionada, desmarca
            if (pdSelecionado === jogoId) {
                pdSelecionado = null;
            } else {
                // Se j√° tem PD em outro jogo, pergunta se quer trocar
                if (pdSelecionado !== null) {
                    if (confirm("Voc√™ j√° tem uma PD selecionada em outro jogo. Deseja trocar?")) {
                        pdSelecionado = jogoId;
                    }
                } else {
                    // Se PD j√° foi usada, pergunta se quer mudar
                    if (dadosOriginais.pd_jogo_id && dadosOriginais.pd_jogo_id !== jogoId) {
                        if (confirm("Voc√™ j√° usou PD em outro jogo. Deseja mudar?")) {
                            pdSelecionado = jogoId;
                        }
                    } else {
                        pdSelecionado = jogoId;
                    }
                }
            }
            render();
            verificarEAtualizar();
        }

        function salvarPlacar(jogoId, time, valor) {
            if (!palpites[jogoId]) {
                palpites[jogoId] = { m: '', v: '' };
            }
            
            // Remove caracteres n√£o num√©ricos
            valor = valor.replace(/\D/g, '');
            
            // Limita a 2 d√≠gitos
            valor = valor.slice(0, 2);
            
            // Converte para n√∫mero inteiro
            const valorNum = valor === '' ? '' : parseInt(valor) || 0;
            
            // Valida se √© n√∫mero v√°lido
            if (valorNum !== '' && (valorNum < 0 || valorNum > 99)) {
                valor = '';
                palpites[jogoId][time] = '';
            } else {
                palpites[jogoId][time] = valorNum;
            }
            
            // Atualiza o input
            const inputs = document.querySelectorAll(`.input-placar[oninput*="${jogoId}"]`);
            inputs.forEach(input => {
                if (input.oninput.toString().includes(`'${time}'`)) {
                    input.value = valor;
                }
            });
            
            verificarEAtualizar();
        }

        function render() {
            const container = document.getElementById('lista-jogos');
            container.innerHTML = '';
            
            if (!dadosOriginais.jogos || dadosOriginais.jogos.length === 0) {
                container.innerHTML = '<div class="jogo-card"><p style="text-align: center; color: #666;">Nenhum jogo dispon√≠vel para palpites.</p></div>';
                return;
            }
            
            dadosOriginais.jogos.forEach(jogo => {
                const palpiteAtual = palpites[jogo.id] || { m: '', v: '' };
                const isPD = pdSelecionado == jogo.id;
                
                // Verifica se PD j√° foi usada neste jogo
                const pdJaUsadaNesteJogo = dadosOriginais.pd_jogo_id == jogo.id;
                
                const div = document.createElement('div');
                div.className = 'jogo-card';
                div.innerHTML = `
                    <div class="jogo-header">
                        <div class="times-nomes">${jogo.mandante} x ${jogo.visitante}</div>
                        <div class="pd-wrapper" onclick="${pdJaUsadaNesteJogo ? '' : `togglePD(${jogo.id})`}">
                            <span class="star-icon ${isPD || pdJaUsadaNesteJogo ? 'active' : ''}" 
                                  style="${pdJaUsadaNesteJogo ? 'cursor: not-allowed; opacity: 0.7;' : ''}">
                                ‚≠ê
                            </span>
                            <span class="pd-label">
                                ${pdJaUsadaNesteJogo ? 'PD USADA' : (isPD ? 'PD ATIVO' : 'DOBRAR')}
                            </span>
                        </div>
                    </div>
                    <div class="placar-container">
                        <input type="number" min="0" max="99" class="input-placar" 
                               value="${palpiteAtual.m === '' ? '' : palpiteAtual.m}" 
                               oninput="salvarPlacar(${jogo.id}, 'm', this.value)" 
                               placeholder="0"
                               ${pdJaUsadaNesteJogo && !palpiteAtual.m ? 'required' : ''}>
                        <span class="vs-text">X</span>
                        <input type="number" min="0" max="99" class="input-placar" 
                               value="${palpiteAtual.v === '' ? '' : palpiteAtual.v}" 
                               oninput="salvarPlacar(${jogo.id}, 'v', this.value)" 
                               placeholder="0"
                               ${pdJaUsadaNesteJogo && !palpiteAtual.v ? 'required' : ''}>
                    </div>
                    ${pdJaUsadaNesteJogo ? '<div style="text-align: center; font-size: 11px; color: #ff9800; margin-top: 5px;">‚≠ê PD j√° usada neste jogo</div>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function verificarPalpitesCompletos() {
            let preenchidos = 0;
            
            for (const jogoId in palpites) {
                const palpite = palpites[jogoId];
                if (palpite.m !== '' && palpite.v !== '') {
                    preenchidos++;
                }
            }
            
            console.log(`Palpites: ${preenchidos}/${totalJogos} preenchidos`);
            return preenchidos === totalJogos;
        }

        function verificarEAtualizar() {
            const completo = verificarPalpitesCompletos();
            const btnConfirmar = document.getElementById('btn-confirmar');
            
            console.log(`Bot√£o confirmar: ${completo ? 'HABILITADO' : 'DESABILITADO'}`);
            btnConfirmar.disabled = !completo;
            
            // Se est√° completo, rola para o bot√£o
            if (completo) {
                setTimeout(() => {
                    btnConfirmar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            tg.expand();
            
            console.log("Iniciando carregamento do web app...");

            try {
                // Pega dados da URL
                const urlParams = new URLSearchParams(window.location.search);
                const dadosBase64 = urlParams.get('data');
                
                if (!dadosBase64) {
                    throw new Error("Dados n√£o encontrados na URL");
                }
                
                // Decodifica dados
                const dadosJson = atob(dadosBase64);
                dadosOriginais = JSON.parse(dadosJson);
                
                console.log("Dados recebidos do bot:", dadosOriginais);
                
                // Atualiza interface
                document.getElementById('rodada-num').textContent = dadosOriginais.rodada.numero;
                
                // Configura PD
                if (dadosOriginais.pd_jogo_id) {
                    pdSelecionado = dadosOriginais.pd_jogo_id;
                    
                    // Mostra info da PD j√° usada
                    if (dadosOriginais.pd_jogo_info) {
                        document.getElementById('info-pd-usada').style.display = 'block';
                        document.getElementById('pd-jogo-info').textContent = 
                            `${dadosOriginais.pd_jogo_info.mandante} x ${dadosOriginais.pd_jogo_info.visitante}`;
                    }
                }
                
                // Inicializa palpites
                palpites = {};
                totalJogos = dadosOriginais.jogos ? dadosOriginais.jogos.length : 0;
                
                // Restaura palpites existentes
                if (dadosOriginais.palpites && Object.keys(dadosOriginais.palpites).length > 0) {
                    console.log("Restaurando palpites existentes:", dadosOriginais.palpites);
                    
                    for (const [jogoId, palpite] of Object.entries(dadosOriginais.palpites)) {
                        palpites[jogoId] = {
                            m: palpite.mandante !== null && palpite.mandante !== undefined ? palpite.mandante : '',
                            v: palpite.visitante !== null && palpite.visitante !== undefined ? palpite.visitante : ''
                        };
                    }
                }
                
                // Formata hor√°rio
                const limite = parseDataBrasilia(dadosOriginais.rodada.horario_fechamento);
                const agora = new Date();
                
                if (limite) {
                    const formatoData = limite.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    const formatoHora = limite.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    document.getElementById('txt-horario').textContent = 
                        `‚è∞ Fecha: ${formatoData} √†s ${formatoHora} (Bras√≠lia)`;
                    
                    // Calcula quanto tempo falta
                    const diffMs = limite - agora;
                    if (diffMs > 0) {
                        const diffHoras = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMinutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        
                        if (diffHoras > 0) {
                            document.getElementById('txt-horario').textContent += ` | Faltam ${diffHoras}h${diffMinutos}m`;
                        } else if (diffMinutos > 0) {
                            document.getElementById('txt-horario').textContent += ` | Faltam ${diffMinutos} minutos`;
                        }
                    }
                }
                
                // Configura trunfo
                document.getElementById('txt-trunfo').textContent = 
                    dadosOriginais.trunfo ? "üÉè TRUNFO: ATIVADO (pode palpitar ap√≥s o hor√°rio)" : "üÉè TRUNFO: N√£o dispon√≠vel";
                
                // Verifica hor√°rio limite
                if (limite && agora > limite && !dadosOriginais.trunfo) {
                    const err = document.getElementById('error-box');
                    err.style.display = 'block';
                    err.textContent = "‚ö†Ô∏è HOR√ÅRIO DE PALPITES ENCERRADO!";
                    document.getElementById('btn-confirmar').disabled = true;
                    document.getElementById('btn-confirmar').textContent = "Hor√°rio Encerrado";
                }
                
                // Mostra conte√∫do e esconde loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Renderiza jogos
                render();
                
                // Verifica se j√° tem palpites completos
                setTimeout(() => {
                    verificarEAtualizar();
                }, 500);
                
            } catch (e) {
                console.error("Erro ao carregar dados", e);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #d32f2f; text-align: center; padding: 20px;">‚ùå Erro ao carregar dados da rodada.<br><br>' + e.message + '</div>';
            }
        });

        document.getElementById('btn-confirmar').onclick = () => {
            console.log("Bot√£o 'Enviar Palpites' clicado");
            
            // Verifica se todos os jogos foram preenchidos
            if (!verificarPalpitesCompletos()) {
                alert("‚ö†Ô∏è Preencha todos os palpites antes de enviar!\n\nClique em cada jogo e digite os placares.");
                return;
            }
            
            // Verifica hor√°rio limite novamente
            const limite = parseDataBrasilia(dadosOriginais.rodada.horario_fechamento);
            const agora = new Date();
            
            if (limite && agora > limite && !dadosOriginais.trunfo) {
                alert("‚ùå Hor√°rio limite expirado! Voc√™ n√£o pode mais enviar palpites.");
                return;
            }
            
            // Prepara dados para enviar - FORMATO CORRETO para o bot
            const dataToBot = {
                tipo: 'enviar_palpites',  // Isso diferencia do web app de cria√ß√£o de rodada
                usuario: {
                    id: dadosOriginais.usuario.id,
                    nome: dadosOriginais.usuario.nome,
                    telegram_id: dadosOriginais.usuario.telegram_id
                },
                rodada: {
                    id: dadosOriginais.rodada.id,
                    numero: dadosOriginais.rodada.numero
                },
                palpites: {},
                pd_jogo_id: pdSelecionado
            };
            
            // Converte palpites para o formato correto
            for (const jogoId in palpites) {
                const palpite = palpites[jogoId];
                if (palpite.m !== '' && palpite.v !== '') {
                    dataToBot.palpites[jogoId] = {
                        mandante: parseInt(palpite.m) || 0,
                        visitante: parseInt(palpite.v) || 0,
                        pd: pdSelecionado == jogoId
                    };
                }
            }
            
            console.log("Enviando dados para o bot:", dataToBot);
            
            // Verifica se h√° palpites para enviar
            if (Object.keys(dataToBot.palpites).length === 0) {
                alert("‚ùå Nenhum palpite preenchido!");
                return;
            }
            
            // Mostra feedback
            document.getElementById('btn-confirmar').textContent = "‚è≥ Enviando...";
            document.getElementById('btn-confirmar').disabled = true;
            
            // Envia para o bot
            tg.sendData(JSON.stringify(dataToBot));
            
            // Fecha o web app ap√≥s 1 segundo
            setTimeout(() => {
                tg.close();
            }, 1000);
        };

        document.getElementById('btn-sair').onclick = () => {
            if (Object.keys(palpites).length > 0 && !verificarPalpitesCompletos()) {
                if (confirm("Tem certeza que deseja sair? Seus palpites n√£o salvos ser√£o perdidos.")) {
                    tg.close();
                }
            } else {
                tg.close();
            }
        };
    </script>
</body>
</html>
