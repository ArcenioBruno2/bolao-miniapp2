<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>‚öΩ Palpites</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            color: #333;
            padding-bottom: 80px; /* Espa√ßo para bot√µes fixos */
        }
        
        /* ===== HEADER COM TIMER ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .timer {
            font-size: 32px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .timer-status {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ===== STATUS DA PD ===== */
        .pd-status {
            background: white;
            margin: 10px;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #4CAF50;
        }
        
        .pd-status.blocked {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .pd-status.used {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        /* ===== LISTA DE JOGOS ===== */
        .game-list {
            padding: 10px;
        }
        
        .game-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        /* NOMES DOS TIMES (MESMA LINHA) */
        .team-names {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .team-home {
            text-align: left;
            flex: 1;
            padding-right: 10px;
        }
        
        .vs {
            color: #666;
            font-size: 14px;
            font-weight: normal;
            margin: 0 5px;
        }
        
        .team-away {
            text-align: right;
            flex: 1;
            padding-left: 10px;
        }
        
        /* INPUTS DE PLACAR (CENTRALIZADOS) */
        .score-inputs {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .score-input {
            width: 60px;
            height: 50px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        .score-input:focus {
            border-color: #667eea;
            background: white;
            outline: none;
        }
        
        .score-separator {
            margin: 0 15px;
            font-size: 20px;
            font-weight: bold;
            color: #666;
        }
        
        /* CHECKBOX PD (ESTRELA) */
        .pd-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        
        .pd-checkbox {
            display: none;
        }
        
        .pd-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f2f5;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .pd-label:hover {
            background: #e4e6e9;
        }
        
        .pd-checkbox:checked + .pd-label {
            background: #fff3e0;
            color: #ff9800;
            font-weight: 600;
        }
        
        .pd-icon {
            font-size: 18px;
        }
        
        /* ===== BOT√ïES FIXOS ===== */
        .footer-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn-save {
            background: #4CAF50;
            color: white;
        }
        
        .btn-save:hover {
            background: #45a049;
        }
        
        .btn-save:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-clear {
            background: #f44336;
            color: white;
        }
        
        .btn-clear:hover {
            background: #d32f2f;
        }
        
        /* ===== RESPONSIVO ===== */
        @media (max-width: 360px) {
            .team-names {
                font-size: 14px;
            }
            
            .score-input {
                width: 50px;
                height: 45px;
                font-size: 20px;
            }
            
            .btn {
                font-size: 14px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER COM TIMER -->
    <div class="header">
        <div class="timer" id="timer">--:--</div>
        <div class="timer-status" id="timerStatus">Carregando...</div>
    </div>
    
    <!-- STATUS DA PD -->
    <div class="pd-status" id="pdStatus">
        ‚≠ê PD Dispon√≠vel - Selecione UM jogo para dobrar pontos
    </div>
    
    <!-- LISTA DE JOGOS -->
    <div class="game-list" id="gameList">
        <!-- Jogos ser√£o gerados aqui -->
    </div>
    
    <!-- BOT√ïES FIXOS -->
    <div class="footer-buttons">
        <button class="btn btn-save" id="btnSave">
            üíæ Salvar Palpites
        </button>
        <button class="btn btn-clear" id="btnClear">
            üóëÔ∏è Limpar
        </button>
    </div>

    <script>
        // ===== VARI√ÅVEIS GLOBAIS =====
        let dados = {};
        let countdownInterval;
        
        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. EXPANDE O WEB APP PARA TELA CHEIA
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                
                // 2. CARREGA DADOS DA URL
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    showError('Dados n√£o encontrados!');
                    return;
                }
                
                // 3. DECODIFICA DADOS (Base64 ‚Üí JSON)
                dados = JSON.parse(atob(dataParam));
                console.log('Dados recebidos:', dados);
                
                // 4. CONFIGURA INTERFACE
                setupTimer();
                updatePDStatus();
                renderGames();
                setupEventListeners();
                
                // 5. AJUSTA TEMA DO TELEGRAM
                Telegram.WebApp.setHeaderColor('#667eea');
                Telegram.WebApp.setBackgroundColor('#f0f2f5');
                
            } catch (error) {
                console.error('Erro:', error);
                showError('Erro ao carregar dados: ' + error.message);
            }
        });
        
        // ===== TIMER REGRESSIVO =====
        function setupTimer() {
            if (!dados.rodada || !dados.rodada.horario_fechamento) {
                document.getElementById('timer').textContent = '--:--';
                document.getElementById('timerStatus').textContent = 'Hor√°rio n√£o definido';
                return;
            }
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            const horarioFechamento = new Date(dados.rodada.horario_fechamento);
            const agora = new Date();
            let diferenca = horarioFechamento - agora;
            
            // AJUSTE PARA TRUNFO (+30 minutos)
            if (dados.trunfo) {
                diferenca += 30 * 60 * 1000;
            }
            
            if (diferenca <= 0) {
                // TEMPO ESGOTADO
                clearInterval(countdownInterval);
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('timerStatus').textContent = '‚ùå TEMPO ESGOTADO';
                document.getElementById('btnSave').disabled = true;
                document.getElementById('btnSave').textContent = '‚è∞ Tempo Esgotado';
                return;
            }
            
            // CALCULA HORAS, MINUTOS, SEGUNDOS
            const horas = Math.floor(diferenca / (1000 * 60 * 60));
            const minutos = Math.floor((diferenca % (1000 * 60 * 60)) / (1000 * 60));
            const segundos = Math.floor((diferenca % (1000 * 60)) / 1000);
            
            // FORMATA
            let texto = '';
            if (horas > 0) {
                texto = `${horas.toString().padStart(2, '0')}:`;
            }
            texto += `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            
            // ATUALIZA DISPLAY
            document.getElementById('timer').textContent = texto;
            
            // ATUALIZA STATUS
            const status = dados.trunfo ? 'üÉè COM TRUNFO (+30min)' : '‚è∞ TEMPO NORMAL';
            document.getElementById('timerStatus').textContent = status;
            
            // MUDA COR CONFORME TEMPO
            const timerEl = document.getElementById('timer');
            if (diferenca < 10 * 60 * 1000) { // < 10 minutos
                timerEl.style.color = '#ff4444';
            } else if (diferenca < 30 * 60 * 1000) { // < 30 minutos
                timerEl.style.color = '#ffaa00';
            } else {
                timerEl.style.color = '#ffffff';
            }
        }
        
        // ===== STATUS DA PD =====
        function updatePDStatus() {
            const pdStatusEl = document.getElementById('pdStatus');
            
            if (dados.pd_bloqueada_adm || dados.pd_administrativa) {
                pdStatusEl.innerHTML = 'üîí PD BLOQUEADA (Administrador)';
                pdStatusEl.className = 'pd-status blocked';
            } else if (dados.pd_ja_usou_anteriormente) {
                pdStatusEl.innerHTML = 'üö´ PD J√Å USADA EM RODADA ANTERIOR';
                pdStatusEl.className = 'pd-status used';
            } else if (dados.pd_ja_usada && dados.pd_jogo_info) {
                pdStatusEl.innerHTML = `‚≠ê PD EM USO: ${dados.pd_jogo_info.mandante} x ${dados.pd_jogo_info.visitante}`;
                pdStatusEl.className = 'pd-status active';
            } else if (dados.pd_disponivel) {
                pdStatusEl.innerHTML = '‚≠ê PD DISPON√çVEL - Selecione UM jogo para dobrar pontos';
                pdStatusEl.className = 'pd-status available';
            } else {
                pdStatusEl.innerHTML = 'üìù SEM PD DISPON√çVEL';
                pdStatusEl.className = 'pd-status';
            }
        }
        
        // ===== RENDERIZA JOGOS =====
        function renderGames() {
            const gameListEl = document.getElementById('gameList');
            
            if (!dados.jogos || dados.jogos.length === 0) {
                gameListEl.innerHTML = '<div class="game-card">Nenhum jogo dispon√≠vel</div>';
                return;
            }
            
            let html = '';
            
            dados.jogos.forEach((jogo, index) => {
                // BUSCA PALPITE EXISTENTE (se for edi√ß√£o)
                const palpiteExistente = dados.palpites_existentes ? 
                    dados.palpites_existentes[jogo.id.toString()] : null;
                
                const palpiteM = palpiteExistente ? palpiteExistente.mandante : '';
                const palpiteV = palpiteExistente ? palpiteExistente.visitante : '';
                const pdChecked = palpiteExistente ? palpiteExistente.pd : false;
                
                // VERIFICA SE PD J√Å EST√Å USADA NESTE JOGO
                const isPDUsedHere = dados.pd_ja_usada && dados.pd_jogo_id === jogo.id;
                
                html += `
                <div class="game-card" data-jogo-id="${jogo.id}">
                    <!-- NOMES DOS TIMES (MESMA LINHA) -->
                    <div class="team-names">
                        <div class="team-home">${jogo.mandante}</div>
                        <div class="vs">x</div>
                        <div class="team-away">${jogo.visitante}</div>
                    </div>
                    
                    <!-- INPUTS DE PLACAR (ALINHADOS COM OS "x") -->
                    <div class="score-inputs">
                        <input type="number" 
                               class="score-input input-mandante"
                               min="0" 
                               max="99"
                               value="${palpiteM}"
                               placeholder="0"
                               ${!dados.usuario_pode_palpitar ? 'disabled' : ''}>
                        
                        <div class="score-separator">x</div>
                        
                        <input type="number" 
                               class="score-input input-visitante"
                               min="0" 
                               max="99"
                               value="${palpiteV}"
                               placeholder="0"
                               ${!dados.usuario_pode_palpitar ? 'disabled' : ''}>
                    </div>
                    
                    <!-- CHECKBOX PD (ESTRELA) -->
                    <div class="pd-container">
                        <input type="checkbox" 
                               class="pd-checkbox"
                               id="pd-${jogo.id}"
                               ${pdChecked || isPDUsedHere ? 'checked' : ''}
                               ${!dados.pd_disponivel || dados.pd_bloqueada_adm || !dados.usuario_pode_palpitar ? 'disabled' : ''}>
                        
                        <label class="pd-label" for="pd-${jogo.id}">
                            <span class="pd-icon">${isPDUsedHere ? '‚≠ê' : '‚òÜ'}</span>
                            <span>${isPDUsedHere ? 'PD EM USO' : 'USAR PD AQUI'}</span>
                        </label>
                    </div>
                </div>
                `;
            });
            
            gameListEl.innerHTML = html;
            
            // CONFIGURA CHECKBOXES DE PD (sele√ß√£o √∫nica)
            document.querySelectorAll('.pd-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        // DESMARCA TODOS OS OUTROS
                        document.querySelectorAll('.pd-checkbox').forEach(cb => {
                            if (cb !== this) cb.checked = false;
                        });
                    }
                });
            });
            
            // VALIDA√á√ÉO EM TEMPO REAL DOS INPUTS
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                });
                
                input.addEventListener('blur', function() {
                    if (this.value === '') this.value = '0';
                });
            });
        }
        
        // ===== VALIDA√á√ÉO DE INPUTS =====
        function validateInput(input) {
            const value = parseInt(input.value);
            
            if (input.value === '') {
                input.style.borderColor = '#ddd';
                return true;
            }
            
            if (isNaN(value) || value < 0 || value > 99) {
                input.style.borderColor = '#f44336';
                return false;
            }
            
            input.value = value; // Remove zeros √† esquerda
            input.style.borderColor = '#4CAF50';
            return true;
        }
        
        function validateAllInputs() {
            let isValid = true;
            
            document.querySelectorAll('.score-input').forEach(input => {
                if (!validateInput(input)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
        
        // ===== SALVAR PALPITES =====
        async function savePalpites() {
            try {
                // 1. VALIDA INPUTS
                if (!validateAllInputs()) {
                    showError('Corrija os valores inv√°lidos! (0-99)');
                    return;
                }
                
                // 2. PREPARA DADOS
                const palpites = {};
                let pdJogoId = null;
                let hasPalpites = false;
                
                document.querySelectorAll('.game-card').forEach(card => {
                    const jogoId = card.dataset.jogoId;
                    const inputM = card.querySelector('.input-mandante');
                    const inputV = card.querySelector('.input-visitante');
                    const checkboxPD = card.querySelector('.pd-checkbox');
                    
                    const mandante = parseInt(inputM.value) || 0;
                    const visitante = parseInt(inputV.value) || 0;
                    const pd = checkboxPD ? checkboxPD.checked : false;
                    
                    // S√≥ inclui se pelo menos um placar for diferente de 0
                    if (mandante > 0 || visitante > 0 || pd) {
                        palpites[jogoId] = {
                            mandante: mandante,
                            visitante: visitante,
                            pd: pd
                        };
                        hasPalpites = true;
                        
                        if (pd) {
                            pdJogoId = jogoId;
                        }
                    }
                });
                
                // 3. VERIFICA SE TEM PALPITES
                if (!hasPalpites && Object.keys(palpites).length === 0) {
                    showError('Digite pelo menos um palpite!');
                    return;
                }
                
                // 4. PREPARA DADOS PARA ENVIO
                const dadosEnvio = {
                    tipo: 'enviar_palpites',
                    usuario: {
                        id: dados.usuario.id,
                        telegram_id: dados.usuario.telegram_id
                    },
                    rodada: {
                        id: dados.rodada.id,
                        numero: dados.rodada.numero
                    },
                    palpites: palpites,
                    pd_jogo_id: pdJogoId
                };
                
                console.log('Enviando:', dadosEnvio);
                
                // 5. MOSTRA LOADING
                const btnSave = document.getElementById('btnSave');
                const originalText = btnSave.innerHTML;
                btnSave.innerHTML = '‚è≥ Enviando...';
                btnSave.disabled = true;
                
                // 6. ENVIA PARA O BOT
                Telegram.WebApp.sendData(JSON.stringify(dadosEnvio));
                
                // 7. FECHA WEB APP AP√ìS 1 SEGUNDO
                setTimeout(() => {
                    Telegram.WebApp.close();
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showError('Erro: ' + error.message);
                
                // RESTAURA BOT√ÉO
                const btnSave = document.getElementById('btnSave');
                btnSave.innerHTML = 'üíæ Salvar Palpites';
                btnSave.disabled = false;
            }
        }
        
        // ===== LIMPAR TODOS =====
        function clearAll() {
            if (!confirm('Limpar TODOS os palpites?')) return;
            
            document.querySelectorAll('.score-input').forEach(input => {
                input.value = '';
                input.style.borderColor = '#ddd';
            });
            
            document.querySelectorAll('.pd-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // FOCO NO PRIMEIRO INPUT
            const firstInput = document.querySelector('.score-input');
            if (firstInput) firstInput.focus();
        }
        
        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('btnSave').addEventListener('click', savePalpites);
            document.getElementById('btnClear').addEventListener('click', clearAll);
            
            // NAVEGA√á√ÉO COM TECLADO ENTRE INPUTS
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const active = document.activeElement;
                    if (active.classList.contains('score-input')) {
                        e.preventDefault();
                        const inputs = Array.from(document.querySelectorAll('.score-input'));
                        const index = inputs.indexOf(active);
                        if (index !== -1 && index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                    }
                }
            });
        }
        
        // ===== UTILIT√ÅRIOS =====
        function showError(message) {
            Telegram.WebApp.showPopup({
                title: '‚ùå Erro',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }
        
        function showSuccess(message) {
            Telegram.WebApp.showPopup({
                title: '‚úÖ Sucesso',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }
    </script>
</body>
</html>
