<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpitar - Rodada</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: white; color: #333; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #4CAF50; }
        .titulo-rodada { color: #2C3E50; font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .subtitulo { color: #7F8C8D; font-size: 16px; }
        .status-info { background: #F8F9FA; border-radius: 8px; padding: 15px; margin-bottom: 25px; border-left: 4px solid #4CAF50; }
        .status-item { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .status-icon { font-size: 18px; }
        .status-text { font-weight: 600; color: #2C3E50; }
        .lista-jogos { margin-bottom: 30px; }
        .jogo { background: #F8F9FA; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #E0E0E0; transition: all 0.3s ease; }
        .jogo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .times { font-size: 18px; font-weight: 600; color: #2C3E50; }
        .pd-star { font-size: 28px; cursor: pointer; transition: transform 0.2s, color 0.2s; color: #BDC3C7; }
        .pd-selected { color: #FFD700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.7); }
        .placar-inputs { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px; }
        .input-placar { width: 70px; height: 60px; font-size: 28px; text-align: center; border: 2px solid #3498DB; border-radius: 10px; outline: none; font-weight: bold; background: white; }
        .vs { font-size: 24px; font-weight: 700; color: #2C3E50; }
        .btn-acoes { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-enviar { background: #27AE60; color: white; }
        .btn-cancelar { background: #E74C3C; color: white; }
        .erro { background: #FDEDED; color: #E74C3C; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #E74C3C; display: none; }
        .sucesso { background: #EDF7ED; color: #27AE60; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #27AE60; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="titulo-rodada">Rodada <span id="numero-rodada">0</span></h1>
            <p class="subtitulo">Preencha seus palpites abaixo</p>
        </div>
        
        <div class="status-info">
            <div class="status-item"><span class="status-icon" id="trunfo-icon">‚è≥</span><span id="trunfo-text" class="status-text">Verificando...</span></div>
            <div class="status-item"><span class="status-icon">‚≠ê</span><span id="pd-text" class="status-text">Pontua√ß√£o Dobrada: Dispon√≠vel</span></div>
            <div class="status-item"><span class="status-icon">üìÖ</span><span id="horario-text" class="status-text">Carregando hor√°rio...</span></div>
        </div>

        <div class="erro" id="mensagem-erro"></div>
        <div class="sucesso" id="mensagem-sucesso"></div>
        <div class="lista-jogos" id="lista-jogos"></div>
        
        <div class="btn-acoes">
            <button class="btn btn-enviar" id="btn-enviar"><span>‚úÖ</span><span>Enviar Palpites</span></button>
            <button class="btn btn-cancelar" id="btn-cancelar"><span>‚ùå</span><span>Cancelar</span></button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let estado = { rodada: null, usuario: null, trunfo: false, pdDisponivel: false, pdJogoId: null, jogos: [], palpites: {}, horarioLimite: null, horarioPassou: false };

        // CORRE√á√ÉO DE FUSO: For√ßa interpreta√ß√£o como Hor√°rio de Bras√≠lia (-03:00)
        function parseDataBR(dataStr) {
            if (!dataStr) return null;
            let formatada = dataStr.replace(' ', 'T');
            if (!formatada.includes('-') && !formatada.includes('Z')) formatada += '-03:00';
            return new Date(formatada);
        }

        function getBase64Data() {
            const urlParams = new URLSearchParams(window.location.search);
            const base64Data = urlParams.get('data');
            if (!base64Data) return null;
            return JSON.parse(atob(base64Data));
        }

        function atualizarPalpite(id, tipo, val) {
            if (!estado.palpites[id]) estado.palpites[id] = { mandante: '', visitante: '', pd: (estado.pdJogoId == id) };
            estado.palpites[id][tipo] = val === '' ? '' : parseInt(val);
        }

        function selecionarPD(id) {
            if (estado.pdJogoId && estado.pdJogoId !== id) return;
            estado.pdJogoId = (estado.pdJogoId === id) ? null : id;
            Object.keys(estado.palpites).forEach(key => estado.palpites[key].pd = (key == estado.pdJogoId));
            renderizarJogos();
        }

        function renderizarJogos() {
            const container = document.getElementById('lista-jogos');
            container.innerHTML = '';
            const agora = new Date();

            estado.jogos.forEach(jogo => {
                const dataJogo = parseDataBR(jogo.data_horario);
                if (dataJogo && agora > dataJogo) return; // Oculta jogos que j√° come√ßaram

                const palpite = estado.palpites[jogo.id] || { mandante: '', visitante: '' };
                const isPD = estado.pdJogoId === jogo.id;
                
                const div = document.createElement('div');
                div.className = 'jogo';
                div.innerHTML = `
                    <div class="jogo-header">
                        <div class="times">${jogo.mandante} x ${jogo.visitante}</div>
                        <div class="pd-star ${isPD ? 'pd-selected' : ''}" onclick="selecionarPD(${jogo.id})">‚≠ê</div>
                    </div>
                    <div class="placar-inputs">
                        <input type="number" class="input-placar" value="${palpite.mandante}" oninput="atualizarPalpite(${jogo.id}, 'mandante', this.value)" placeholder="0">
                        <div class="vs">X</div>
                        <input type="number" class="input-placar" value="${palpite.visitante}" oninput="atualizarPalpite(${jogo.id}, 'visitante', this.value)" placeholder="0">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dados = getBase64Data();
            if (!dados) return;

            estado.usuario = dados.usuario;
            estado.rodada = dados.rodada;
            estado.jogos = dados.jogos;
            estado.palpites = dados.palpites || {};
            estado.trunfo = dados.trunfo || false;
            estado.pdJogoId = dados.pd_jogo_id || null;
            estado.horarioLimite = parseDataBR(dados.rodada.horario_fechamento);
            
            document.getElementById('numero-rodada').textContent = estado.rodada.numero;
            document.getElementById('horario-text').textContent = "Fecha em: " + estado.horarioLimite.toLocaleString('pt-BR');
            document.getElementById('trunfo-text').textContent = estado.trunfo ? "Trunfo Ativo" : "Sem Trunfo";

            const agora = new Date();
            if (agora > estado.horarioLimite && !estado.trunfo) {
                estado.horarioPassou = true;
                document.getElementById('mensagem-erro').textContent = "Hor√°rio de palpites encerrado!";
                document.getElementById('mensagem-erro').style.display = 'block';
                document.getElementById('btn-enviar').disabled = true;
            }

            renderizarJogos();
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }
        });

        document.getElementById('btn-enviar').addEventListener('click', () => {
            const dadosEnvio = { tipo: 'enviar_palpites', usuario: estado.usuario, rodada: estado.rodada, palpites: estado.palpites, pd_jogo_id: estado.pdJogoId };
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.sendData(JSON.stringify(dadosEnvio));
                Telegram.WebApp.close();
            }
        });

        document.getElementById('btn-cancelar').addEventListener('click', () => {
            if (window.Telegram && window.Telegram.WebApp) Telegram.WebApp.close();
        });
    </script>
</body>
</html>
