<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0a1c2e 0%, #152a38 100%);
            min-height: 100vh;
            padding: 16px;
            color: white;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 26px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .erro-box {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid #f44336;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-top: 30px;
        }

        .erro-titulo {
            color: #ff8a80;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .erro-detalhe {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
        }

        .prazo-box {
            background: rgba(255,215,0,0.12);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .progresso {
            background: rgba(0,0,0,0.25);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .progresso-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progresso-contador {
            color: #FFD700;
            font-weight: bold;
            font-size: 20px;
        }

        .barra-progresso {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .barra-preenchimento {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }

        .categoria-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .categoria-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .categoria-icone {
            font-size: 28px;
            margin-right: 12px;
        }

        .categoria-nome {
            font-size: 16px;
            font-weight: 600;
        }

        .categoria-pontos {
            font-size: 13px;
            color: #FFD700;
            background: rgba(255,215,0,0.15);
            padding: 3px 10px;
            border-radius: 20px;
            margin-left: 10px;
        }

        .select-wrapper {
            position: relative;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 14px;
            color: white;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
        }

        select option {
            background: #1e3a4a;
            color: white;
            padding: 12px;
        }

        .select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #FFD700;
            pointer-events: none;
        }

        .escolha-atual {
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(255,215,0,0.1);
            border-radius: 12px;
            font-size: 14px;
            color: #FFD700;
        }

        .btn-salvar {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 30px;
            color: #0a1c2e;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            margin-top: 20px;
            margin-bottom: 30px;
            transition: transform 0.2s;
        }

        .btn-salvar:active {
            transform: scale(0.98);
        }

        .btn-salvar:disabled {
            opacity: 0.5;
            transform: none;
        }

        .debug-info {
            margin-top: 30px;
            padding: 16px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            font-size: 12px;
            color: #aaa;
            word-break: break-all;
        }
    </style>
    
    <!-- Carregar bibliotecas necess√°rias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="app">
            <!-- Tela de Loading -->
            <div id="tela-loading" class="loading">
                <div class="spinner"></div>
                <h3>‚≠ê Carregando Pontos Extras...</h3>
                <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-top: 10px;" id="status-loading">Decodificando dados...</p>
            </div>

            <!-- Tela de Erro (inicialmente escondida) -->
            <div id="tela-erro" style="display: none;">
                <div class="erro-box">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                    <div class="erro-titulo" id="erro-titulo">Erro ao carregar dados</div>
                    <p id="erro-mensagem" style="color: rgba(255,255,255,0.8);">N√£o foi poss√≠vel carregar as informa√ß√µes.</p>
                    <div id="erro-detalhe" class="erro-detalhe"></div>
                    <button onclick="window.location.reload()" style="margin-top: 24px; padding: 12px 30px; background: #FFD700; border: none; border-radius: 30px; color: #0a1c2e; font-weight: bold; cursor: pointer;">
                        üîÑ TENTAR NOVAMENTE
                    </button>
                </div>
            </div>

            <!-- Tela Principal (inicialmente escondida) -->
            <div id="tela-principal" style="display: none;">
                <div class="header">
                    <h1>‚≠ê PONTOS EXTRAS 2026</h1>
                </div>

                <!-- Prazo ser√° inserido aqui via JS -->
                <div id="prazo-container"></div>

                <!-- Progresso -->
                <div class="progresso">
                    <div class="progresso-header">
                        <span>üéØ Seus palpites</span>
                        <span class="progresso-contador" id="contador">0/0</span>
                    </div>
                    <div class="barra-progresso">
                        <div class="barra-preenchimento" id="barra-progresso" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Lista de Categorias -->
                <div id="categorias-container"></div>

                <!-- Bot√£o Salvar -->
                <button class="btn-salvar" id="btn-salvar">
                    üíæ SALVAR PALPITES
                </button>

                <!-- Debug (opcional, pode remover em produ√ß√£o) -->
                <div id="debug-info" class="debug-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DECODIFICA√á√ÉO - VERS√ÉO SIMPLIFICADA E ROBUSTA
        // ============================================
        
        console.log('üöÄ Iniciando WebApp...');
        
        const Telegram = window.Telegram?.WebApp;
        if (Telegram) {
            Telegram.expand();
            Telegram.ready();
            console.log('‚úÖ Telegram WebApp inicializado');
        }

        // Elementos da UI
        const telaLoading = document.getElementById('tela-loading');
        const telaErro = document.getElementById('tela-erro');
        const telaPrincipal = document.getElementById('tela-principal');
        const statusLoading = document.getElementById('status-loading');

        function mostrarErro(titulo, mensagem, detalhe = '') {
            console.error('‚ùå Erro:', titulo, mensagem, detalhe);
            telaLoading.style.display = 'none';
            telaErro.style.display = 'block';
            telaPrincipal.style.display = 'none';
            
            document.getElementById('erro-titulo').textContent = titulo || 'Erro ao carregar dados';
            document.getElementById('erro-mensagem').textContent = mensagem || 'Tente novamente mais tarde.';
            
            const elDetalhe = document.getElementById('erro-detalhe');
            if (detalhe) {
                elDetalhe.textContent = detalhe;
                elDetalhe.style.display = 'block';
            } else {
                elDetalhe.style.display = 'none';
            }
        }

        // ============ FUN√á√ÉO PRINCIPAL DE DECODIFICA√á√ÉO ============
        function decodificarDados() {
            try {
                statusLoading.textContent = 'üì¶ Lendo dados da URL...';
                
                // Pega o hash da URL (tudo depois de #)
                const hash = window.location.hash.substring(1);
                
                if (!hash) {
                    throw new Error('Nenhum dado encontrado na URL');
                }
                
                console.log('üîç Hash encontrado (primeiros 50 chars):', hash.substring(0, 50) + '...');
                console.log('üìè Tamanho do hash:', hash.length, 'caracteres');
                
                statusLoading.textContent = `üîß Decodificando Base64 (${hash.length} chars)...`;
                
                // 1. Converter base64url para base64 padr√£o
                let base64 = hash.replace(/-/g, '+').replace(/_/g, '/');
                
                // 2. Adicionar padding se necess√°rio
                while (base64.length % 4) {
                    base64 += '=';
                }
                
                console.log('üìè Base64 ap√≥s padding:', base64.length, 'chars');
                
                // 3. Decodificar base64 para bytes
                let bytesComprimidos;
                try {
                    bytesComprimidos = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    console.log('üì¶ Bytes comprimidos:', bytesComprimidos.length, 'bytes');
                } catch (e) {
                    throw new Error('Falha na decodifica√ß√£o Base64: ' + e.message);
                }
                
                statusLoading.textContent = `üîì Descomprimindo GZIP (${bytesComprimidos.length} bytes)...`;
                
                // 4. Descomprimir com pako
                let bytesDescomprimidos;
                try {
                    bytesDescomprimidos = pako.ungzip(bytesComprimidos);
                    console.log('üì¶ Bytes descomprimidos:', bytesDescomprimidos.length, 'bytes');
                    console.log('üìä Taxa de compress√£o:', ((bytesComprimidos.length / bytesDescomprimidos.length) * 100).toFixed(1) + '%');
                } catch (e) {
                    throw new Error('Falha na descompress√£o GZIP: ' + e.message);
                }
                
                statusLoading.textContent = 'üìÑ Parseando JSON...';
                
                // 5. Converter bytes para string JSON
                let jsonStr;
                try {
                    jsonStr = new TextDecoder('utf-8').decode(bytesDescomprimidos);
                    console.log('üìÑ JSON string (primeiros 100 chars):', jsonStr.substring(0, 100) + '...');
                } catch (e) {
                    throw new Error('Falha na decodifica√ß√£o UTF-8: ' + e.message);
                }
                
                // 6. Parse JSON
                let dados;
                try {
                    dados = JSON.parse(jsonStr);
                    console.log('‚úÖ JSON parseado com sucesso!');
                } catch (e) {
                    throw new Error('Falha no parse do JSON: ' + e.message);
                }
                
                return dados;
                
            } catch (error) {
                console.error('‚ùå Erro na decodifica√ß√£o:', error);
                throw error;
            }
        }

        // ============ RENDERIZA√á√ÉO DA INTERFACE ============
        function renderizarInterface(dados) {
            console.log('üé® Renderizando interface...', dados);
            
            // Validar dados
            if (!dados) {
                throw new Error('Dados inv√°lidos');
            }
            
            const times = dados.times || [];
            const categorias = dados.categorias || [];
            const escolhas = dados.escolhas || {};
            const prazo = dados.prazo || '';
            const usuario = dados.usuario || { nome: 'Usu√°rio' };
            
            console.log(`üìä Times: ${times.length} | Categorias: ${categorias.length} | Escolhas: ${Object.keys(escolhas).length}`);
            
            if (times.length === 0) {
                throw new Error('Nenhum time importado');
            }
            
            if (categorias.length === 0) {
                throw new Error('Nenhuma categoria encontrada');
            }
            
            // Esconder loading, mostrar tela principal
            telaLoading.style.display = 'none';
            telaPrincipal.style.display = 'block';
            
            // ============ PRAZO ============
            const prazoContainer = document.getElementById('prazo-container');
            if (prazo) {
                const [data, hora] = prazo.split(' ');
                const [ano, mes, dia] = data.split('-');
                const dataFormatada = `${dia}/${mes}/${ano} √†s ${hora}`;
                
                prazoContainer.innerHTML = `
                    <div class="prazo-box">
                        <span style="font-size: 24px;">‚è∞</span>
                        <span style="font-weight: 600; color: #FFD700;">Encerra: ${dataFormatada}</span>
                        <span style="background: #FFD700; color: #0a1c2e; padding: 4px 12px; border-radius: 30px; font-size: 13px; font-weight: bold;">
                            HOR√ÅRIO DE BRAS√çLIA
                        </span>
                    </div>
                `;
            }
            
            // ============ CATEGORIAS ============
            const categoriasContainer = document.getElementById('categorias-container');
            categoriasContainer.innerHTML = '';
            
            // Contador de preenchidos
            let preenchidos = 0;
            
            // Ordenar categorias por ordem (j√° devem vir ordenadas, mas garantimos)
            const categoriasOrdenadas = [...categorias].sort((a, b) => {
                const ordemA = dados.ordens?.[a.item] || 0;
                const ordemB = dados.ordens?.[b.item] || 0;
                return ordemA - ordemB;
            });
            
            categoriasOrdenadas.forEach(cat => {
                const codigo = cat.item;
                const nome = cat.nome;
                const icone = cat.icone || '‚öΩ';
                const pontos = cat.pontos || 0;
                
                const escolhaAtual = escolhas[codigo] || '';
                const temEscolha = !!escolhaAtual;
                
                if (temEscolha) preenchidos++;
                
                // Criar card da categoria
                const card = document.createElement('div');
                card.className = `categoria-card ${temEscolha ? 'preenchida' : ''}`;
                card.setAttribute('data-codigo', codigo);
                
                // Header
                const header = document.createElement('div');
                header.className = 'categoria-header';
                header.innerHTML = `
                    <span class="categoria-icone">${icone}</span>
                    <span class="categoria-nome">${nome}</span>
                    <span class="categoria-pontos">${pontos} pts</span>
                `;
                
                // Select wrapper
                const selectWrapper = document.createElement('div');
                selectWrapper.className = 'select-wrapper';
                
                // Criar select
                const select = document.createElement('select');
                select.setAttribute('data-codigo', codigo);
                
                // Op√ß√£o vazia
                const optionVazia = document.createElement('option');
                optionVazia.value = '';
                optionVazia.textContent = 'üîΩ Selecione um time...';
                select.appendChild(optionVazia);
                
                // Op√ß√µes dos times
                times.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = `‚öΩ ${time}`;
                    if (time === escolhaAtual) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Arrow do select
                const arrow = document.createElement('span');
                arrow.className = 'select-arrow';
                arrow.textContent = '‚ñº';
                
                selectWrapper.appendChild(select);
                selectWrapper.appendChild(arrow);
                
                card.appendChild(header);
                card.appendChild(selectWrapper);
                
                // Mostrar escolha atual se houver
                if (temEscolha) {
                    const escolhaDiv = document.createElement('div');
                    escolhaDiv.className = 'escolha-atual';
                    escolhaDiv.innerHTML = `
                        <span>‚úÖ Escolhido:</span>
                        <strong style="margin-left: 8px;">${escolhaAtual}</strong>
                    `;
                    card.appendChild(escolhaDiv);
                }
                
                categoriasContainer.appendChild(card);
                
                // Adicionar evento de mudan√ßa
                select.addEventListener('change', function(e) {
                    const cod = this.dataset.codigo;
                    const valor = this.value;
                    
                    // Atualizar contador
                    atualizarContador();
                    
                    // Mostrar/esconder badge de escolha atual
                    const escolhaDiv = card.querySelector('.escolha-atual');
                    if (valor) {
                        if (escolhaDiv) {
                            escolhaDiv.innerHTML = `
                                <span>‚úÖ Escolhido:</span>
                                <strong style="margin-left: 8px;">${valor}</strong>
                            `;
                        } else {
                            const novaEscolhaDiv = document.createElement('div');
                            novaEscolhaDiv.className = 'escolha-atual';
                            novaEscolhaDiv.innerHTML = `
                                <span>‚úÖ Escolhido:</span>
                                <strong style="margin-left: 8px;">${valor}</strong>
                            `;
                            card.appendChild(novaEscolhaDiv);
                        }
                        
                        // Marcar como preenchida
                        card.classList.add('preenchida');
                    } else {
                        if (escolhaDiv) {
                            escolhaDiv.remove();
                        }
                        card.classList.remove('preenchida');
                    }
                    
                    // Marcar que houve altera√ß√£o
                    window.escolhasAlteradas = true;
                });
            });
            
            // ============ CONTADOR INICIAL ============
            const contadorEl = document.getElementById('contador');
            const barraEl = document.getElementById('barra-progresso');
            
            function atualizarContador() {
                const selects = document.querySelectorAll('select[data-codigo]');
                let preenchidosAgora = 0;
                
                selects.forEach(select => {
                    if (select.value) preenchidosAgora++;
                });
                
                contadorEl.textContent = `${preenchidosAgora}/${categorias.length}`;
                const percentual = (preenchidosAgora / categorias.length) * 100;
                barraEl.style.width = percentual + '%';
            }
            
            // Inicializar contador
            atualizarContador();
            
            // ============ BOT√ÉO SALVAR ============
            const btnSalvar = document.getElementById('btn-salvar');
            
            btnSalvar.onclick = function() {
                // Coletar todas as escolhas
                const selects = document.querySelectorAll('select[data-codigo]');
                const escolhasArray = [];
                
                selects.forEach(select => {
                    const item = select.dataset.codigo;
                    const time = select.value;
                    
                    if (time && time.trim() !== '') {
                        escolhasArray.push({
                            item: item,
                            time: time.trim()
                        });
                    }
                });
                
                console.log('üì§ Enviando escolhas:', escolhasArray);
                
                // Enviar para o bot
                if (Telegram) {
                    Telegram.sendData(JSON.stringify({
                        escolhas: escolhasArray
                    }));
                    
                    // Feedback
                    Telegram.showAlert(`‚úÖ ${escolhasArray.length} palpites salvos com sucesso!`);
                } else {
                    alert('Fora do Telegram. Escolhas: ' + JSON.stringify(escolhasArray));
                }
            };
            
            // Debug (opcional)
            if (window.location.hash.includes('debug')) {
                const debugEl = document.getElementById('debug-info');
                debugEl.style.display = 'block';
                debugEl.innerHTML = `
                    <strong>üîç DEBUG INFO</strong><br>
                    Times: ${times.length}<br>
                    Categorias: ${categorias.length}<br>
                    Escolhas carregadas: ${Object.keys(escolhas).length}<br>
                    Usu√°rio: ${usuario.nome || 'N/A'}<br>
                    Prazo: ${prazo || 'N/A'}<br>
                    Hash length: ${window.location.hash.length}
                `;
            }
        }

        // ============ EXECU√á√ÉO PRINCIPAL ============
        try {
            // Tentar decodificar os dados
            const dados = decodificarDados();
            
            // Se chegou aqui, sucesso!
            console.log('‚úÖ Dados decodificados:', dados);
            
            // Renderizar interface
            renderizarInterface(dados);
            
        } catch (error) {
            console.error('‚ùå Erro fatal:', error);
            
            // Mostrar erro detalhado
            mostrarErro(
                'Falha na decodifica√ß√£o',
                'N√£o foi poss√≠vel carregar os dados do bol√£o.',
                error.message + '\n\nHash: ' + window.location.hash.substring(0, 100) + '...'
            );
            
            // Tentar mostrar o hash para debug
            const hash = window.location.hash.substring(1);
            if (hash) {
                console.log('Hash completo:', hash);
            }
        }

        // Verificar se pako foi carregado
        if (typeof pako === 'undefined') {
            mostrarErro(
                'Biblioteca n√£o carregada',
                'Erro ao carregar pako.min.js. Verifique sua conex√£o.',
                'Tente recarregar a p√°gina.'
            );
        }
    </script>
</body>
</html>
