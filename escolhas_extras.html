<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0a1c2a;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 26px;
            color: #FFD700;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prazo-box {
            background: rgba(255,215,0,0.1);
            border: 1px solid #FFD700;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progresso {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .progresso-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .contador {
            color: #FFD700;
            font-weight: bold;
            font-size: 22px;
        }

        .barra-container {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .barra {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }

        .categoria {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .categoria.preenchida {
            border-color: #4CAF50;
            background: rgba(76,175,80,0.1);
        }

        .categoria-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .icone {
            font-size: 28px;
            margin-right: 12px;
        }

        .info {
            flex: 1;
        }

        .nome {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pontos {
            font-size: 13px;
            color: #FFD700;
            background: rgba(255,215,0,0.1);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
        }

        select option {
            background: #0a1c2a;
            color: white;
        }

        .escolha-atual {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(255,215,0,0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-salvar {
            width: 100%;
            padding: 18px;
            background: #FFD700;
            border: none;
            border-radius: 30px;
            color: #0a1c2a;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            margin: 24px 0 40px;
            transition: opacity 0.2s;
        }

        .btn-salvar:active {
            opacity: 0.8;
        }

        .error-box {
            background: rgba(244,67,54,0.1);
            border: 1px solid #f44336;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }

        .debug-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            font-size: 12px;
            font-family: monospace;
            word-break: break-all;
            color: #aaa;
        }

        .telegram-button {
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            margin-top: 24px;
            width: 100%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2 style="color: #FFD700;">Carregando Pontos Extras</h2>
            <p id="loading-status" style="color: #aaa;">Processando dados...</p>
        </div>

        <!-- MAIN CONTENT -->
        <div id="main" style="display: none;">
            <div class="header">
                <h1>‚≠ê PONTOS EXTRAS 2026</h1>
            </div>

            <div id="prazo-container"></div>

            <div class="progresso">
                <div class="progresso-header">
                    <span>üéØ Seus palpites</span>
                    <span class="contador" id="contador">0/15</span>
                </div>
                <div class="barra-container">
                    <div class="barra" id="barra-progresso"></div>
                </div>
            </div>

            <div id="categorias-container"></div>

            <button class="btn-salvar" id="btn-salvar">
                üíæ SALVAR ESCOLHAS
            </button>
        </div>

        <!-- ERROR -->
        <div id="error" style="display: none;">
            <div class="error-box">
                <h3 style="color: #ff8a80; margin-bottom: 16px;">üîß Configura√ß√£o Necess√°ria</h3>
                <p style="margin-bottom: 20px;" id="error-message"></p>
                <div id="error-details" class="debug-box"></div>
                <button class="telegram-button" id="force-send-button" onclick="forcarEnvioTelegram()">
                    üì§ TESTAR ENVIO AO TELEGRAM
                </button>
                <button class="btn-salvar" onclick="window.location.reload()" style="margin-top: 16px; background: #333; color: white;">
                    üîÑ Tentar Novamente
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== MODO FOR√áADO ====================
        // Ignorar detec√ß√£o do Telegram e for√ßar funcionamento
        
        console.log('üöÄ Iniciando WebApp em modo for√ßado...');
        
        const loadingEl = document.getElementById('loading');
        const mainEl = document.getElementById('main');
        const errorEl = document.getElementById('error');
        const loadingStatus = document.getElementById('loading-status');

        // ==================== FUN√á√ÉO DE DECODIFICA√á√ÉO MANUAL ====================
        function base64UrlDecode(base64url) {
            // Preparar string
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            
            // Remover caracteres inv√°lidos
            base64 = base64.replace(/[^A-Za-z0-9+/=]/g, '');
            
            // Adicionar padding
            while (base64.length % 4) {
                base64 += '=';
            }
            
            // Decodifica√ß√£o manual (mais compat√≠vel)
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
            let output = [];
            let buffer = 0;
            let bits = 0;
            
            for (let i = 0; i < base64.length; i++) {
                if (base64[i] === '=') break;
                
                const val = chars.indexOf(base64[i]);
                if (val === -1) continue;
                
                buffer = (buffer << 6) | val;
                bits += 6;
                
                if (bits >= 8) {
                    bits -= 8;
                    output.push((buffer >> bits) & 0xFF);
                }
            }
            
            return new Uint8Array(output);
        }

        // ==================== PEGAR HASH DE V√ÅRIAS FORMAS ====================
        function obterHash() {
            // M√©todo 1: window.location.hash
            let hash = window.location.hash.substring(1);
            
            // M√©todo 2: regex na URL completa
            if (!hash || hash.length < 100) {
                const match = window.location.href.match(/#(.*)$/);
                if (match) hash = match[1];
            }
            
            // M√©todo 3: decodeURIComponent
            if (!hash || hash.length < 100) {
                try {
                    hash = decodeURIComponent(window.location.hash.substring(1));
                } catch (e) {}
            }
            
            return hash;
        }

        // ==================== FOR√áAR ENVIO AO TELEGRAM ====================
        window.forcarEnvioTelegram = function() {
            // Tentar diferentes formas de enviar ao Telegram
            
            // Forma 1: Telegram.WebApp
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify({ teste: "ok" }));
                window.Telegram.WebApp.showAlert("‚úÖ Enviado via Telegram.WebApp");
                return;
            }
            
            // Forma 2: parent.Telegram
            if (parent?.Telegram?.WebApp) {
                parent.Telegram.WebApp.sendData(JSON.stringify({ teste: "ok" }));
                parent.Telegram.WebApp.showAlert("‚úÖ Enviado via parent.Telegram");
                return;
            }
            
            // Forma 3: window.parent.Telegram
            if (window.parent?.Telegram?.WebApp) {
                window.parent.Telegram.WebApp.sendData(JSON.stringify({ teste: "ok" }));
                window.parent.Telegram.WebApp.showAlert("‚úÖ Enviado via window.parent.Telegram");
                return;
            }
            
            alert("‚ùå N√£o foi poss√≠vel encontrar o objeto Telegram.WebApp");
        };

        // ==================== TENTAR DECODIFICAR ====================
        try {
            const hash = obterHash();
            
            console.log('üì¶ Hash obtido:', hash.substring(0, 50) + '...');
            console.log('üì¶ Tamanho:', hash.length);
            
            if (!hash || hash.length < 100) {
                throw new Error('Dados n√£o encontrados na URL. Use o bot do Telegram para abrir este link.');
            }
            
            loadingStatus.textContent = `üì¶ Decodificando Base64 (${hash.length} chars)...`;
            
            // Decodificar Base64URL
            const compressed = base64UrlDecode(hash);
            console.log('üì¶ Bytes comprimidos:', compressed.length);
            
            loadingStatus.textContent = `üîì Descomprimindo GZIP (${compressed.length} bytes)...`;
            
            // Descomprimir com pako
            if (typeof pako === 'undefined') {
                throw new Error('Biblioteca pako n√£o carregada');
            }
            
            let decompressed;
            try {
                decompressed = pako.ungzip(compressed);
            } catch (e) {
                // Tentar inflate como fallback
                decompressed = pako.inflate(compressed);
            }
            
            console.log('üì¶ Bytes descomprimidos:', decompressed.length);
            
            loadingStatus.textContent = 'üìÑ Parseando JSON...';
            
            // Converter para texto
            const jsonText = new TextDecoder('utf-8').decode(decompressed);
            console.log('üìÑ JSON preview:', jsonText.substring(0, 200));
            
            // Parse JSON
            const data = JSON.parse(jsonText);
            
            console.log('‚úÖ Dados carregados!');
            console.log('üìä Times:', data.times?.length);
            console.log('üìä Categorias:', data.categorias?.length);
            console.log('üìä Escolhas:', Object.keys(data.escolhas || {}).length);
            
            // ==================== RENDERIZAR INTERFACE ====================
            loadingEl.style.display = 'none';
            mainEl.style.display = 'block';
            
            const times = data.times || [];
            const categorias = data.categorias || [];
            const escolhas = data.escolhas || {};
            const prazo = data.prazo || '';
            
            // Prazo
            if (prazo) {
                const [dataPart, horaPart] = prazo.split(' ');
                const [ano, mes, dia] = dataPart.split('-');
                const dataFormatada = `${dia}/${mes}/${ano} √†s ${horaPart}`;
                
                document.getElementById('prazo-container').innerHTML = `
                    <div class="prazo-box">
                        <span style="font-size: 28px;">‚è∞</span>
                        <div>
                            <div style="font-size: 13px; color: #aaa;">ENCERRAMENTO</div>
                            <div style="font-size: 18px; font-weight: bold; color: #FFD700;">${dataFormatada}</div>
                            <div style="font-size: 12px; color: #888;">Hor√°rio de Bras√≠lia</div>
                        </div>
                    </div>
                `;
            }
            
            // Categorias
            const container = document.getElementById('categorias-container');
            container.innerHTML = '';
            
            categorias.forEach(cat => {
                const codigo = cat.item || cat.codigo;
                const nome = cat.nome;
                const icone = cat.icone || '‚öΩ';
                const pontos = cat.pontos || 0;
                const escolhaAtual = escolhas[codigo] || '';
                
                const card = document.createElement('div');
                card.className = `categoria ${escolhaAtual ? 'preenchida' : ''}`;
                
                // Criar select
                let selectHtml = `<select data-codigo="${codigo}"><option value="">üîΩ Selecione um time...</option>`;
                times.forEach(time => {
                    selectHtml += `<option value="${time}" ${time === escolhaAtual ? 'selected' : ''}>‚öΩ ${time}</option>`;
                });
                selectHtml += '</select>';
                
                card.innerHTML = `
                    <div class="categoria-header">
                        <span class="icone">${icone}</span>
                        <div class="info">
                            <div class="nome">${nome}</div>
                            <span class="pontos">${pontos} pts</span>
                        </div>
                    </div>
                    ${selectHtml}
                    ${escolhaAtual ? `<div class="escolha-atual"><span>‚úÖ</span><span>${escolhaAtual}</span></div>` : ''}
                `;
                
                container.appendChild(card);
                
                // Event listener
                const select = card.querySelector('select');
                select.addEventListener('change', function() {
                    const valor = this.value;
                    const cod = this.dataset.codigo;
                    
                    if (valor) {
                        card.classList.add('preenchida');
                        let div = card.querySelector('.escolha-atual');
                        if (div) {
                            div.innerHTML = `<span>‚úÖ</span><span>${valor}</span>`;
                        } else {
                            const nova = document.createElement('div');
                            nova.className = 'escolha-atual';
                            nova.innerHTML = `<span>‚úÖ</span><span>${valor}</span>`;
                            card.appendChild(nova);
                        }
                    } else {
                        card.classList.remove('preenchida');
                        const div = card.querySelector('.escolha-atual');
                        if (div) div.remove();
                    }
                    atualizarContador();
                });
            });
            
            // Contador
            function atualizarContador() {
                const selects = document.querySelectorAll('select[data-codigo]');
                let count = 0;
                selects.forEach(s => { if (s.value) count++; });
                document.getElementById('contador').textContent = `${count}/${categorias.length}`;
                document.getElementById('barra-progresso').style.width = (count / categorias.length * 100) + '%';
            }
            atualizarContador();
            
            // Bot√£o salvar - VERS√ÉO FOR√áADA
            document.getElementById('btn-salvar').onclick = function() {
                const selects = document.querySelectorAll('select[data-codigo]');
                const escolhasArray = [];
                selects.forEach(s => {
                    if (s.value) {
                        escolhasArray.push({
                            item: s.dataset.codigo,
                            time: s.value
                        });
                    }
                });
                
                const payload = JSON.stringify({ escolhas: escolhasArray });
                console.log('üì§ Payload:', payload);
                
                // TENTAR TODAS AS FORMAS DE ENVIAR
                let enviado = false;
                
                // Forma 1
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.sendData(payload);
                    enviado = true;
                }
                
                // Forma 2
                if (parent?.Telegram?.WebApp) {
                    parent.Telegram.WebApp.sendData(payload);
                    enviado = true;
                }
                
                // Forma 3
                if (window.parent?.Telegram?.WebApp) {
                    window.parent.Telegram.WebApp.sendData(payload);
                    enviado = true;
                }
                
                if (enviado) {
                    alert(`‚úÖ ${escolhasArray.length} palpites salvos!`);
                } else {
                    // Fallback: mostrar no console
                    console.log('Escolhas:', escolhasArray);
                    alert(`üì¶ Escolhas prontas! (${escolhasArray.length} itens)\nVerifique o console.`);
                }
            };
            
        } catch (error) {
            console.error('‚ùå Erro:', error);
            
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            
            document.getElementById('error-message').innerHTML = error.message;
            
            // Mostrar diagn√≥stico
            const hash = obterHash();
            document.getElementById('error-details').innerHTML = `
                <strong>üîç DIAGN√ìSTICO:</strong><br><br>
                üìå URL: ${window.location.href.substring(0, 100)}...<br>
                üì¶ Hash: ${hash.substring(0, 100)}...<br>
                üì¶ Hash length: ${hash.length}<br>
                üì± Telegram.WebApp: ${window.Telegram?.WebApp ? '‚úÖ' : '‚ùå'}<br>
                üì± parent.Telegram: ${parent?.Telegram?.WebApp ? '‚úÖ' : '‚ùå'}<br>
                üîß Pako: ${typeof pako !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>
                <br>
                <strong>‚úÖ SOLU√á√ÉO:</strong><br>
                1. Clique no bot√£o azul "TESTAR ENVIO AO TELEGRAM"<br>
                2. Se funcionar, o bot receber√° um teste<br>
                3. Fa√ßa suas escolhas e tente salvar novamente
            `;
        }
    </script>
</body>
</html>
