<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontos Extras</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .timer { text-align: center; font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: #e74c3c; background: var(--tg-theme-secondary-bg-color); padding: 10px; border-radius: 8px; }
        .error-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 8px 4px; border-bottom: 1px solid rgba(128,128,128,0.2); font-size: 0.9em; }
        select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .btn-container { margin-top: 20px; display: flex; gap: 10px; position: sticky; bottom: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-send { background-color: #2ecc71; color: white; }
        .btn-send:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-cancel { background-color: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="timer" id="countdown">Carregando...</div>
    <div id="error-container" style="display: none;"></div>
    
    <form id="extrasForm">
        <table>
            <tbody id="itemsTable"></tbody>
        </table>
        <div class="btn-container">
            <button type="button" class="btn-cancel" onclick="window.Telegram.WebApp.close()">Cancelar</button>
            <button type="submit" class="btn-send">Confirmar Escolhas</button>
        </div>
    </form>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const itens = [
            "Campe√£o Geral", "Campe√£o 1¬∫ Turno", "Campe√£o 2¬∫ Turno", "Melhor Visitante",
            "Melhor Mandante", "Melhor Ataque", "Melhor Defesa", "2¬∫ Colocado Final",
            "3¬∫ Colocado Final", "4¬∫ Colocado Final", "17¬∫ Colocado Final", "18¬∫ Colocado Final",
            "19¬∫ Colocado Final", "20¬∫ Colocado Final", "Time Estrela"
        ];

        let times = [];
        let escolhasAnteriores = {};
        let prazoFinal = 0;

        // CORRE√á√ÉO: Fun√ß√£o segura para decodificar Base64
        function safeBase64Decode(str) {
            try {
                // Remover caracteres inv√°lidos para Base64
                let base64 = str.replace(/[^A-Za-z0-9+/=]/g, '');
                // Adicionar padding se necess√°rio
                while (base64.length % 4) {
                    base64 += '=';
                }
                return atob(base64);
            } catch (e) {
                console.error('Erro no Base64:', e);
                return null;
            }
        }

        // CORRE√á√ÉO: Decodificar dados da URL de forma robusta
        function loadDataFromHash() {
            try {
                const hash = window.location.hash;
                if (!hash) {
                    throw new Error('No hash data');
                }
                
                // Extrair o Base64
                let base64Data = '';
                if (hash.includes('data=')) {
                    base64Data = hash.split('data=')[1];
                } else {
                    base64Data = hash.substring(1); // Remover o '#'
                }
                
                // Decodificar
                const decodedStr = safeBase64Decode(base64Data);
                if (!decodedStr) {
                    throw new Error('Failed to decode Base64');
                }
                
                const data = JSON.parse(decodedStr);
                
                times = data.times || [];
                escolhasAnteriores = data.escolhas || {};
                
                // CORRE√á√ÉO: Converter prazo para timestamp de forma segura
                if (data.prazo) {
                    // Se vier no formato "YYYY-MM-DD HH:MM:SS"
                    if (typeof data.prazo === 'string') {
                        const [date, time] = data.prazo.split(' ');
                        const [year, month, day] = date.split('-').map(Number);
                        const [hour, minute] = time.split(':').map(Number);
                        
                        // Criar data em Bras√≠lia (UTC-3)
                        const prazoDate = new Date(Date.UTC(year, month-1, day, hour, minute, 0));
                        prazoDate.setHours(prazoDate.getHours() - 3); // Ajustar UTC-3
                        prazoFinal = prazoDate.getTime();
                    } else {
                        prazoFinal = new Date(data.prazo).getTime();
                    }
                }
                
                return true;
            } catch (e) {
                console.error('Erro ao carregar dados:', e);
                showError('Erro ao carregar dados. Por favor, tente novamente.');
                return false;
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `<div class="error-box"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
            errorContainer.style.display = 'block';
        }

        function renderForm() {
            if (times.length === 0) {
                showError('Nenhum time dispon√≠vel para sele√ß√£o.');
                return;
            }
            
            const table = document.getElementById('itemsTable');
            table.innerHTML = ''; // Limpar tabela
            
            itens.forEach(item => {
                const tr = document.createElement('tr');
                const valorAtual = escolhasAnteriores[item] || "";
                
                tr.innerHTML = `
                    <td><strong>${item}</strong></td>
                    <td>
                        <select name="${item}" required>
                            <option value="">Selecione...</option>
                            ${times.map(t => `<option value="${t.replace(/"/g, '&quot;')}" ${t === valorAtual ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </td>
                `;
                table.appendChild(tr);
            });
        }

        function startTimer() {
            if (!prazoFinal) {
                document.getElementById('countdown').innerHTML = "‚è≥ Prazo n√£o definido";
                return;
            }
            
            const timerEl = document.getElementById('countdown');
            
            function updateTimer() {
                const now = new Date().getTime();
                const diff = prazoFinal - now;
                
                if (diff < 0) {
                    timerEl.innerHTML = "üèÅ PRAZO ENCERRADO";
                    const btnSend = document.querySelector('.btn-send');
                    if (btnSend) {
                        btnSend.disabled = true;
                        btnSend.title = "Prazo encerrado";
                    }
                    return;
                }
                
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                
                let timerText = '‚è≥ Encerra em: ';
                if (d > 0) timerText += `${d}d `;
                timerText += `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
                
                timerEl.innerHTML = timerText;
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        document.getElementById('extrasForm').onsubmit = (e) => {
            e.preventDefault();
            
            const btnSend = document.querySelector('.btn-send');
            if (btnSend.disabled) {
                tg.showAlert('Prazo j√° encerrado!');
                return;
            }
            
            const formData = new FormData(e.target);
            const escolhas = [];
            
            // Validar se todas as op√ß√µes foram selecionadas
            let todasPreenchidas = true;
            itens.forEach(item => {
                const value = formData.get(item);
                if (!value) {
                    todasPreenchidas = false;
                }
            });
            
            if (!todasPreenchidas) {
                tg.showAlert('‚ùå Selecione um time para todas as categorias!');
                return;
            }
            
            formData.forEach((value, key) => {
                escolhas.push({ item: key, time: value });
            });
            
            // Enviar para o bot
            tg.sendData(JSON.stringify({ escolhas: escolhas }));
        };

        // Inicializar
        if (loadDataFromHash()) {
            renderForm();
            startTimer();
        } else {
            showError('N√£o foi poss√≠vel carregar os dados. Reinicie pelo bot.');
        }
    </script>
</body>
</html>
