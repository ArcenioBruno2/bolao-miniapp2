<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0f2128;
            color: white;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-top: 16px;
        }

        .header h1 {
            font-size: 26px;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prazo-box {
            background: #1a2f3a;
            border-left: 4px solid #FFD700;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progresso {
            background: #1a2f3a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .progresso-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .contador {
            color: #FFD700;
            font-weight: bold;
            font-size: 22px;
        }

        .barra-container {
            width: 100%;
            height: 10px;
            background: #2a404a;
            border-radius: 5px;
            overflow: hidden;
        }

        .barra {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }

        .categoria {
            background: #1a2f3a;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #2a404a;
        }

        .categoria.preenchida {
            border-color: #4CAF50;
            background: #1a3a3a;
        }

        .categoria-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .icone {
            font-size: 28px;
            margin-right: 12px;
        }

        .info {
            flex: 1;
        }

        .nome {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pontos {
            font-size: 13px;
            color: #FFD700;
            background: rgba(255,215,0,0.1);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: #0f2128;
            border: 1px solid #2a404a;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #FFD700;
        }

        select option {
            background: #0f2128;
            color: white;
            padding: 12px;
        }

        .escolha-atual {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(255,215,0,0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-salvar {
            width: 100%;
            padding: 18px;
            background: #FFD700;
            border: none;
            border-radius: 30px;
            color: #0f2128;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            margin: 24px 0 40px;
            transition: opacity 0.2s;
        }

        .btn-salvar:active {
            opacity: 0.8;
        }

        .btn-salvar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .erro {
            background: #442222;
            border-left: 4px solid #ff4444;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            color: #ff8888;
        }

        .init-data {
            background: #1a2f3a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            word-break: break-word;
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            border: 1px solid #FFD700;
        }

        .telegram-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
        }
    </style>
    
    <!-- Pako para descompress√£o GZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="app">
            <!-- Loading Screen -->
            <div id="loading-screen" class="loading">
                <div class="spinner"></div>
                <h2 style="color: #FFD700;">Carregando Pontos Extras</h2>
                <p id="loading-status" style="color: #aaa;">Aguardando dados do Telegram...</p>
            </div>

            <!-- Error Screen -->
            <div id="error-screen" style="display: none;">
                <div class="erro">
                    <h3 style="color: #ff8888; margin-bottom: 16px;">‚ùå Erro de Conex√£o</h3>
                    <p id="error-message" style="margin-bottom: 16px;"></p>
                    <div id="error-help" style="background: #331111; padding: 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                        ‚ö†Ô∏è Este WebApp s√≥ funciona dentro do Telegram, acessando pelo bot.
                    </div>
                    <button onclick="window.location.reload()" style="padding: 12px 30px; background: #FFD700; border: none; border-radius: 30px; color: #0f2128; font-weight: bold; cursor: pointer;">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-screen" style="display: none;">
                <div class="header">
                    <h1>‚≠ê PONTOS EXTRAS 2026</h1>
                </div>

                <!-- Prazo -->
                <div id="prazo-container"></div>

                <!-- Progresso -->
                <div class="progresso">
                    <div class="progresso-header">
                        <span>üéØ Seus palpites</span>
                        <span class="contador" id="contador">0/15</span>
                    </div>
                    <div class="barra-container">
                        <div class="barra" id="barra-progresso"></div>
                    </div>
                </div>

                <!-- Categorias -->
                <div id="categorias-container"></div>

                <!-- Bot√£o Salvar -->
                <button class="btn-salvar" id="btn-salvar">
                    üíæ SALVAR ESCOLHAS
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== TELEGRAM WEBAPP ====================
        console.log('üöÄ Iniciando WebApp de Pontos Extras...');
        
        // Inicializar Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        if (!tg) {
            // N√£o est√° no Telegram
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            document.getElementById('error-message').innerHTML = 'Este aplicativo s√≥ funciona dentro do Telegram.';
            document.getElementById('error-help').style.display = 'block';
            throw new Error('Fora do Telegram');
        }

        // Expandir e preparar
        tg.expand();
        tg.ready();
        tg.enableClosingConfirmation();
        
        console.log('‚úÖ Telegram WebApp inicializado');
        console.log('üìç Platform:', tg.platform);
        console.log('üìç Version:', tg.version);

        // ==================== ELEMENTOS DA UI ====================
        const loadingScreen = document.getElementById('loading-screen');
        const errorScreen = document.getElementById('error-screen');
        const mainScreen = document.getElementById('main-screen');
        const loadingStatus = document.getElementById('loading-status');

        // ==================== FUN√á√ÉO DE DECODIFICA√á√ÉO ====================
        function decodeDataFromHash() {
            try {
                // 1. Pegar o hash da URL
                const hash = window.location.hash.substring(1);
                
                if (!hash) {
                    throw new Error('Nenhum dado encontrado na URL');
                }

                console.log('üì¶ Hash encontrado:', hash.substring(0, 30) + '...');
                console.log('üì¶ Tamanho do hash:', hash.length, 'caracteres');
                
                loadingStatus.textContent = `üì¶ Dados recebidos (${hash.length} chars)`;

                // 2. Converter base64url para base64
                let base64 = hash.replace(/-/g, '+').replace(/_/g, '/');
                
                // 3. Adicionar padding
                while (base64.length % 4) {
                    base64 += '=';
                }
                
                console.log('üì¶ Base64 ap√≥s padding:', base64.length, 'caracteres');

                // 4. Decodificar Base64
                let compressed;
                try {
                    compressed = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    console.log('üì¶ Bytes comprimidos:', compressed.length, 'bytes');
                } catch (e) {
                    throw new Error('Erro na decodifica√ß√£o Base64: ' + e.message);
                }

                // 5. Descomprimir GZIP
                loadingStatus.textContent = `üîì Descomprimindo (${compressed.length} bytes)...`;
                
                let decompressed;
                try {
                    decompressed = pako.ungzip(compressed);
                    console.log('üì¶ Bytes descomprimidos:', decompressed.length, 'bytes');
                } catch (e) {
                    throw new Error('Erro na descompress√£o GZIP: ' + e.message);
                }

                // 6. Converter para texto
                loadingStatus.textContent = 'üìÑ Parseando JSON...';
                
                const jsonText = new TextDecoder('utf-8').decode(decompressed);
                console.log('üìÑ JSON (primeiros 100 chars):', jsonText.substring(0, 100) + '...');

                // 7. Parse JSON
                const data = JSON.parse(jsonText);
                console.log('‚úÖ Dados decodificados com sucesso!');
                
                return data;

            } catch (error) {
                console.error('‚ùå Erro na decodifica√ß√£o:', error);
                throw error;
            }
        }

        // ==================== RENDERIZAR INTERFACE ====================
        function renderizarInterface(data) {
            if (!data) throw new Error('Dados inv√°lidos');
            
            const times = data.times || [];
            const categorias = data.categorias || [];
            const escolhasSalvas = data.escolhas || {};
            const prazo = data.prazo || '';
            
            console.log(`üìä Times: ${times.length}`);
            console.log(`üìä Categorias: ${categorias.length}`);
            console.log(`üìä Escolhas salvas: ${Object.keys(escolhasSalvas).length}`);
            
            if (times.length === 0) {
                throw new Error('Nenhum time importado');
            }
            
            if (categorias.length === 0) {
                throw new Error('Nenhuma categoria encontrada');
            }

            // Mostrar tela principal
            loadingScreen.style.display = 'none';
            mainScreen.style.display = 'block';

            // ============ PRAZO ============
            const prazoContainer = document.getElementById('prazo-container');
            if (prazo) {
                const [dataPart, horaPart] = prazo.split(' ');
                const [ano, mes, dia] = dataPart.split('-');
                const dataFormatada = `${dia}/${mes}/${ano} √†s ${horaPart}`;
                
                prazoContainer.innerHTML = `
                    <div class="prazo-box">
                        <span style="font-size: 28px;">‚è∞</span>
                        <div>
                            <div style="font-size: 13px; color: #aaa;">ENCERRAMENTO</div>
                            <div style="font-size: 16px; font-weight: bold; color: #FFD700;">${dataFormatada}</div>
                            <div style="font-size: 12px; color: #888;">Hor√°rio de Bras√≠lia</div>
                        </div>
                    </div>
                `;
            }

            // ============ CATEGORIAS ============
            const container = document.getElementById('categorias-container');
            container.innerHTML = '';

            // Armazenar estado
            window.escolhasAtuais = { ...escolhasSalvas };
            window.escolhasTemp = { ...escolhasSalvas };

            // Ordenar categorias
            const categoriasOrdenadas = [...categorias].sort((a, b) => {
                const ordemA = a.ordem || 0;
                const ordemB = b.ordem || 0;
                return ordemA - ordemB;
            });

            categoriasOrdenadas.forEach(cat => {
                const codigo = cat.item || cat.codigo;
                const nome = cat.nome;
                const icone = cat.icone || '‚öΩ';
                const pontos = cat.pontos || 0;
                
                const escolhaAtual = escolhasSalvas[codigo] || '';
                const temEscolha = !!escolhaAtual;

                // Criar card
                const card = document.createElement('div');
                card.className = `categoria ${temEscolha ? 'preenchida' : ''}`;
                card.dataset.codigo = codigo;

                // Header
                const header = document.createElement('div');
                header.className = 'categoria-header';
                header.innerHTML = `
                    <span class="icone">${icone}</span>
                    <div class="info">
                        <div class="nome">${nome}</div>
                        <span class="pontos">${pontos} pontos</span>
                    </div>
                `;

                // Select
                const select = document.createElement('select');
                select.dataset.codigo = codigo;
                
                // Op√ß√£o vazia
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'üîΩ Selecione um time...';
                select.appendChild(emptyOption);
                
                // Op√ß√µes dos times
                times.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = `‚öΩ ${time}`;
                    if (time === escolhaAtual) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                card.appendChild(header);
                card.appendChild(select);

                // Escolha atual
                if (temEscolha) {
                    const escolhaDiv = document.createElement('div');
                    escolhaDiv.className = 'escolha-atual';
                    escolhaDiv.innerHTML = `
                        <span>‚úÖ</span>
                        <span>${escolhaAtual}</span>
                    `;
                    card.appendChild(escolhaDiv);
                }

                container.appendChild(card);

                // Evento de mudan√ßa
                select.addEventListener('change', function() {
                    const cod = this.dataset.codigo;
                    const valor = this.value;
                    
                    window.escolhasTemp[cod] = valor;
                    
                    // Atualizar visual
                    if (valor) {
                        card.classList.add('preenchida');
                        
                        let escolhaDiv = card.querySelector('.escolha-atual');
                        if (escolhaDiv) {
                            escolhaDiv.innerHTML = `<span>‚úÖ</span><span>${valor}</span>`;
                        } else {
                            const novaDiv = document.createElement('div');
                            novaDiv.className = 'escolha-atual';
                            novaDiv.innerHTML = `<span>‚úÖ</span><span>${valor}</span>`;
                            card.appendChild(novaDiv);
                        }
                    } else {
                        card.classList.remove('preenchida');
                        const escolhaDiv = card.querySelector('.escolha-atual');
                        if (escolhaDiv) escolhaDiv.remove();
                    }
                    
                    atualizarContador();
                });
            });

            // ============ CONTADOR ============
            function atualizarContador() {
                const selects = document.querySelectorAll('select[data-codigo]');
                let count = 0;
                selects.forEach(select => {
                    if (select.value) count++;
                });
                
                document.getElementById('contador').textContent = `${count}/${categorias.length}`;
                const percent = (count / categorias.length) * 100;
                document.getElementById('barra-progresso').style.width = percent + '%';
            }
            
            atualizarContador();

            // ============ BOT√ÉO SALVAR ============
            const btnSalvar = document.getElementById('btn-salvar');
            
            btnSalvar.onclick = function() {
                const selects = document.querySelectorAll('select[data-codigo]');
                const escolhasArray = [];
                
                selects.forEach(select => {
                    const item = select.dataset.codigo;
                    const time = select.value;
                    
                    if (time && time.trim() !== '') {
                        escolhasArray.push({
                            item: item,
                            time: time.trim()
                        });
                    }
                });
                
                console.log('üì§ Enviando escolhas:', escolhasArray.length);
                
                // Enviar para o bot
                tg.sendData(JSON.stringify({
                    escolhas: escolhasArray
                }));
                
                // Feedback
                tg.showAlert(`‚úÖ ${escolhasArray.length} palpites salvos!`);
            };
        }

        // ==================== INICIALIZA√á√ÉO ====================
        try {
            // Verificar pako
            if (typeof pako === 'undefined') {
                throw new Error('Biblioteca pako n√£o carregada');
            }
            
            // Verificar hash
            if (!window.location.hash || window.location.hash.length < 10) {
                loadingStatus.textContent = '‚è≥ Aguardando dados do Telegram...';
                
                // Se n√£o tem hash, aguardar initData
                if (tg.initData) {
                    console.log('üì¶ initData encontrado:', tg.initData.substring(0, 50) + '...');
                    loadingStatus.textContent = 'üì¶ Processando initData...';
                    
                    // Tenta decodificar o initData como base64?
                    try {
                        // For√ßar recarregamento com hash? N√£o, melhor usar o initData
                        console.warn('Usando initData como fallback');
                    } catch(e) {
                        console.warn('Fallback falhou');
                    }
                }
                
                // Aguardar 2 segundos e tentar de qualquer jeito
                setTimeout(() => {
                    if (!window.location.hash || window.location.hash.length < 10) {
                        mostrarErro('Dados n√£o encontrados', 
                            'Este link precisa ser aberto pelo bot do Telegram.',
                            'Use /escolha_extra no bot para acessar corretamente.');
                    }
                }, 2000);
            }
            
            // Decodificar dados
            const dados = decodeDataFromHash();
            
            // Renderizar
            renderizarInterface(dados);
            
        } catch (error) {
            console.error('‚ùå Erro fatal:', error);
            
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'block';
            
            document.getElementById('error-message').innerHTML = error.message;
            
            // Mostrar ajuda baseada no erro
            const helpEl = document.getElementById('error-help');
            if (error.message.includes('Base64')) {
                helpEl.innerHTML = 'üîß Erro na decodifica√ß√£o. Tente abrir novamente pelo bot.';
            } else if (error.message.includes('GZIP')) {
                helpEl.innerHTML = 'üîß Erro na descompress√£o. Verifique sua conex√£o.';
            } else if (error.message.includes('JSON')) {
                helpEl.innerHTML = 'üîß Erro no formato dos dados. Contate o administrador.';
            }
        }
    </script>
</body>
</html>
