<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontos Extras</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .timer { text-align: center; font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: #e74c3c; background: var(--tg-theme-secondary-bg-color); padding: 10px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 8px 4px; border-bottom: 1px solid rgba(128,128,128,0.2); font-size: 0.9em; }
        select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .btn-container { margin-top: 20px; display: flex; gap: 10px; position: sticky; bottom: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-send { background-color: #2ecc71; color: white; }
        .btn-cancel { background-color: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="timer" id="countdown">Carregando...</div>
    
    <form id="extrasForm">
        <table>
            <tbody id="itemsTable"></tbody>
        </table>
        <div class="btn-container">
            <button type="button" class="btn-cancel" onclick="window.Telegram.WebApp.close()">Cancelar</button>
            <button type="submit" class="btn-send">Confirmar Escolhas</button>
        </div>
    </form>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const itens = [
            "CampeÃ£o Geral", "CampeÃ£o 1Âº Turno", "CampeÃ£o 2Âº Turno", "Melhor Visitante",
            "Melhor Mandante", "Melhor Ataque", "Melhor Defesa", "2Âº Colocado Final",
            "3Âº Colocado Final", "4Âº Colocado Final", "17Âº Colocado Final", "18Âº Colocado Final",
            "19Âº Colocado Final", "20Âº Colocado Final", "Time Estrela"
        ];

        let times = [];
        let escolhasAnteriores = {};
        let prazoFinal = 0;

        // === CORREÃ‡ÃƒO: DecodificaÃ§Ã£o robusta com suporte a UTF-8 ===
        try {
            // Pega tudo apÃ³s #data=
            const rawHash = window.location.hash.split('data=')[1];
            
            if (rawHash) {
                // 1. Decodifica caracteres de URL (ex: %3D vira =, %2F vira /)
                const base64Clean = decodeURIComponent(rawHash);
                
                // 2. Decodifica Base64 para string binÃ¡ria (Latin-1)
                const binaryString = atob(base64Clean);

                // 3. Converte de Latin-1 para UTF-8 corretamente
                const jsonString = decodeURIComponent(Array.prototype.map.call(binaryString, function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                const decoded = JSON.parse(jsonString);
                
                times = decoded.times || [];
                escolhasAnteriores = decoded.escolhas || {};
                
                // CorreÃ§Ã£o para data (compatibilidade Safari/iOS)
                let dateStr = decoded.prazo;
                if(dateStr && dateStr.includes(" ")) {
                    dateStr = dateStr.replace(" ", "T");
                }
                prazoFinal = new Date(dateStr).getTime();
            }
        } catch (e) {
            console.error("Erro ao carregar dados:", e);
            alert("Erro ao ler dados. Tente abrir o link novamente.");
        }
        // === FIM DA CORREÃ‡ÃƒO ===

        function renderForm() {
            const table = document.getElementById('itemsTable');
            itens.forEach(item => {
                const tr = document.createElement('tr');
                const valorAtual = escolhasAnteriores[item] || "";
                tr.innerHTML = `
                    <td><strong>${item}</strong></td>
                    <td>
                        <select name="${item}" required>
                            <option value="">Selecione...</option>
                            ${times.map(t => `<option value="${t}" ${t === valorAtual ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </td>
                `;
                table.appendChild(tr);
            });
        }

        function startTimer() {
            if (!prazoFinal) return;
            const timerEl = document.getElementById('countdown');
            setInterval(() => {
                const now = new Date().getTime();
                const diff = prazoFinal - now;
                if (diff < 0) {
                    timerEl.innerHTML = "ðŸ PRAZO ENCERRADO";
                    document.querySelector('.btn-send').disabled = true;
                    return;
                }
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                timerEl.innerHTML = `â³ Encerra em: ${d}d ${h}h ${m}m ${s}s`;
            }, 1000);
        }

        document.getElementById('extrasForm').onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const escolhas = [];
            formData.forEach((value, key) => {
                escolhas.push({ item: key, time: value });
            });
            tg.sendData(JSON.stringify({ escolhas }));
        };

        renderForm();
        startTimer();
    </script>
</body>
</html>
