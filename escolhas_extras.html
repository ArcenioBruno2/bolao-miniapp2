<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0b1a2e 0%, #1a2f3f 100%);
            min-height: 100vh;
            padding: 20px 16px;
            color: white;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 28px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .prazo-box {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 16px;
            padding: 14px 18px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .prazo-icone {
            font-size: 24px;
        }

        .prazo-texto {
            font-weight: 600;
            color: #ffd700;
        }

        .progresso {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .progresso-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progresso-titulo {
            font-size: 16px;
            color: #a0c0d0;
        }

        .progresso-contador {
            font-size: 24px;
            font-weight: 700;
            color: #4caf50;
        }

        .barra-progresso {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .barra-preenchimento {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .categorias-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 30px;
        }

        .categoria-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .categoria-card.preenchida {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
        }

        .categoria-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .categoria-icone {
            font-size: 28px;
            margin-right: 12px;
        }

        .categoria-info {
            flex: 1;
        }

        .categoria-nome {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .categoria-pontos {
            font-size: 13px;
            color: #ffd700;
            background: rgba(255,215,0,0.1);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .status-preenchido {
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .select-wrapper {
            position: relative;
            margin-top: 8px;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 14px;
            color: white;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(0,0,0,0.5);
        }

        select option {
            background: #1a2f3f;
            color: white;
            padding: 12px;
        }

        .select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #ffd700;
            pointer-events: none;
            font-size: 14px;
        }

        .escolha-atual {
            margin-top: 8px;
            padding: 10px 14px;
            background: rgba(255,215,0,0.1);
            border-radius: 12px;
            font-size: 14px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .acoes {
            position: sticky;
            bottom: 20px;
            background: rgba(11, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 30px;
            border: 1px solid rgba(255,215,0,0.3);
            margin-top: 20px;
        }

        .btn-salvar {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            border: none;
            border-radius: 30px;
            color: #0b1a2e;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(255,215,0,0.3);
        }

        .btn-salvar:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(255,215,0,0.2);
        }

        .btn-salvar:disabled {
            opacity: 0.5;
            transform: none;
            box-shadow: none;
        }

        .alerta {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 20px;
            color: #ff8a80;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            font-size: 18px;
            color: #ffd700;
        }

        .badge {
            background: #ffd700;
            color: #0b1a2e;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            body { padding: 16px 12px; }
            .categoria-card { padding: 14px; }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Loading -->
        <div v-if="loading" class="loading">
            <span>‚≠ê Carregando Pontos Extras...</span>
        </div>

        <!-- Conte√∫do Principal -->
        <div v-else>
            <div class="header">
                <h1>‚≠ê PONTOS EXTRAS 2026</h1>
            </div>

            <!-- Prazo -->
            <div class="prazo-box" v-if="prazo">
                <span class="prazo-icone">‚è∞</span>
                <span class="prazo-texto">Encerra: {{ formatarData(prazo) }}</span>
                <span class="badge">{{ tempoRestante }}</span>
            </div>

            <!-- Progresso -->
            <div class="progresso">
                <div class="progresso-header">
                    <span class="progresso-titulo">üéØ Seus palpites</span>
                    <span class="progresso-contador">{{ categoriasPreenchidas }}/{{ categorias.length }}</span>
                </div>
                <div class="barra-progresso">
                    <div class="barra-preenchimento" :style="{ width: percentualPreenchido + '%' }"></div>
                </div>
            </div>

            <!-- Alerta de altera√ß√µes -->
            <div class="alerta" v-if="temAlteracoes">
                ‚ö†Ô∏è Voc√™ tem altera√ß√µes n√£o salvas!
            </div>

            <!-- Lista de Categorias -->
            <div class="categorias-grid">
                <div v-for="cat in categorias" :key="cat.item" 
                     class="categoria-card" 
                     :class="{ 'preenchida': escolhas[cat.item] }">
                    
                    <div class="categoria-header">
                        <span class="categoria-icone">{{ cat.icone }}</span>
                        <div class="categoria-info">
                            <div class="categoria-nome">{{ cat.nome }}</div>
                            <span class="categoria-pontos">{{ cat.pontos }} pontos</span>
                        </div>
                        <div v-if="escolhas[cat.item]" class="status-preenchido">
                            ‚úÖ
                        </div>
                    </div>

                    <div class="select-wrapper">
                        <select v-model="escolhasTemp[cat.item]" @change="marcarAlteracao(cat.item)">
                            <option value="">üîΩ Selecione um time...</option>
                            <option v-for="time in times" :key="time" :value="time">
                                ‚öΩ {{ time }}
                            </option>
                        </select>
                        <span class="select-arrow">‚ñº</span>
                    </div>

                    <div v-if="escolhasTemp[cat.item]" class="escolha-atual">
                        <span>‚úÖ Escolhido:</span>
                        <strong>{{ escolhasTemp[cat.item] }}</strong>
                    </div>
                </div>
            </div>

            <!-- Bot√£o Salvar -->
            <div class="acoes">
                <button class="btn-salvar" @click="salvarEscolhas" :disabled="salvando || !temAlteracoes">
                    <span v-if="!salvando">üíæ SALVAR PALPITES ({{ categoriasPreenchidasTemp }}/{{ categorias.length }})</span>
                    <span v-else>‚è≥ SALVANDO...</span>
                </button>
                <p style="text-align: center; margin-top: 12px; color: #a0c0d0; font-size: 12px;">
                    Voc√™ pode editar at√© o prazo final
                </p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/gzip-js@0.3.2/lib/gzip.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

        const app = createApp({
            setup() {
                // ============ ESTADOS ============
                const loading = ref(true);
                const salvando = ref(false);
                
                // Dados recebidos do Telegram
                const times = ref([]);
                const categorias = ref([]);
                const prazo = ref(null);
                const usuario = ref({});
                
                // Escolhas carregadas do servidor
                const escolhas = ref({});
                
                // Escolhas tempor√°rias (durante edi√ß√£o)
                const escolhasTemp = ref({});
                
                // Controle de altera√ß√µes
                const alteracoes = ref(new Set());
                
                // Telegram WebApp
                const tg = window.Telegram?.WebApp;
                
                // ============ FUN√á√ÉO DECODIFICAR DADOS ============
                // EXATAMENTE como o bot codificou:
                // JSON -> gzip -> base64url -> URL#base64
                function decodificarDadosDaURL() {
                    try {
                        console.log('üîç Decodificando dados da URL...');
                        
                        // Pega o hash da URL (tudo ap√≥s #)
                        const hash = window.location.hash.substring(1);
                        
                        if (!hash) {
                            console.error('‚ùå Nenhum dado encontrado na URL');
                            return null;
                        }
                        
                        console.log(`üì¶ Hash encontrado: ${hash.length} caracteres`);
                        
                        // 1. Base64 URL-SAFE -> bytes
                        let base64 = hash.replace(/-/g, '+').replace(/_/g, '/');
                        while (base64.length % 4) {
                            base64 += '=';
                        }
                        
                        console.log(`üì¶ Base64 convertido: ${base64.length} caracteres`);
                        
                        const bytesComprimidos = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                        console.log(`üì¶ Bytes comprimidos: ${bytesComprimidos.length} bytes`);
                        
                        // 2. Descomprimir GZIP
                        try {
                            // Usar biblioteca pako para descompress√£o gzip
                            const bytesDescomprimidos = pako.ungzip(bytesComprimidos);
                            console.log(`üì¶ Bytes descomprimidos: ${bytesDescomprimidos.length} bytes`);
                            
                            // 3. JSON
                            const jsonStr = new TextDecoder('utf-8').decode(bytesDescomprimidos);
                            console.log(`üì¶ JSON: ${jsonStr.length} caracteres`);
                            
                            // 4. Parse
                            const dados = JSON.parse(jsonStr);
                            console.log('‚úÖ Dados decodificados com sucesso!');
                            
                            return dados;
                        } catch (e) {
                            console.error('‚ùå Erro na descompress√£o:', e);
                            return null;
                        }
                    } catch (e) {
                        console.error('‚ùå Erro ao decodificar:', e);
                        return null;
                    }
                }

                // ============ DADOS COMPUTADOS ============
                const categoriasPreenchidas = computed(() => {
                    return Object.values(escolhas.value).filter(Boolean).length;
                });

                const categoriasPreenchidasTemp = computed(() => {
                    return Object.values(escolhasTemp.value).filter(Boolean).length;
                });

                const percentualPreenchido = computed(() => {
                    return (categoriasPreenchidas.value / categorias.value.length) * 100;
                });

                const temAlteracoes = computed(() => {
                    return alteracoes.value.size > 0;
                });

                const tempoRestante = computed(() => {
                    if (!prazo.value) return '';
                    
                    const agora = new Date();
                    const prazoDate = new Date(prazo.value.replace(' ', 'T') + '-03:00');
                    const diff = prazoDate - agora;
                    
                    if (diff <= 0) return 'ENCERRADO';
                    
                    const horas = Math.floor(diff / (1000 * 60 * 60));
                    const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (horas > 24) {
                        const dias = Math.floor(horas / 24);
                        return `${dias}d ${horas % 24}h`;
                    }
                    return `${horas}h ${minutos}m`;
                });

                // ============ M√âTODOS ============
                function marcarAlteracao(item) {
                    alteracoes.value.add(item);
                    
                    // Se selecionou vazio, remove
                    if (!escolhasTemp.value[item]) {
                        alteracoes.value.delete(item);
                    }
                    
                    // Auto-sync com escolhas originais
                    if (escolhasTemp.value[item] === escolhas.value[item]) {
                        alteracoes.value.delete(item);
                    }
                }

                function formatarData(dataStr) {
                    if (!dataStr) return '';
                    const [data, hora] = dataStr.split(' ');
                    const [ano, mes, dia] = data.split('-');
                    return `${dia}/${mes}/${ano} √†s ${hora}`;
                }

                function inicializarEscolhasTemp() {
                    // Come√ßa com as escolhas carregadas
                    escolhasTemp.value = { ...escolhas.value };
                    
                    // Garante que todas categorias existam
                    categorias.value.forEach(cat => {
                        if (!escolhasTemp.value[cat.item]) {
                            escolhasTemp.value[cat.item] = '';
                        }
                    });
                    
                    alteracoes.value.clear();
                }

                async function salvarEscolhas() {
                    if (salvando.value) return;
                    
                    salvando.value = true;
                    
                    try {
                        // Monta array de escolhas APENAS com os itens preenchidos
                        const escolhasArray = [];
                        
                        Object.entries(escolhasTemp.value).forEach(([item, time]) => {
                            if (time && time.trim() !== '') {
                                escolhasArray.push({
                                    item: item,
                                    time: time.trim()
                                });
                            }
                        });
                        
                        // Dados para enviar ao bot
                        const dados = {
                            escolhas: escolhasArray
                        };
                        
                        console.log(`üì§ Enviando ${escolhasArray.length} escolhas...`);
                        
                        // Enviar via WebApp
                        tg.sendData(JSON.stringify(dados));
                        
                        // Atualizar estado local
                        escolhas.value = { ...escolhasTemp.value };
                        alteracoes.value.clear();
                        
                        // Feedback visual
                        tg.showAlert(`‚úÖ ${escolhasArray.length} palpites salvos com sucesso!`);
                        
                    } catch (e) {
                        console.error('‚ùå Erro ao salvar:', e);
                        tg.showAlert('‚ùå Erro ao salvar. Tente novamente.');
                    } finally {
                        salvando.value = false;
                    }
                }

                // ============ INICIALIZA√á√ÉO ============
                onMounted(() => {
                    console.log('üöÄ Inicializando WebApp Pontos Extras...');
                    
                    // Expandir Telegram WebApp
                    if (tg) {
                        tg.expand();
                        tg.ready();
                        tg.enableClosingConfirmation();
                        console.log('‚úÖ Telegram WebApp inicializado');
                    }
                    
                    // Decodificar dados da URL
                    const dados = decodificarDadosDaURL();
                    
                    if (dados) {
                        console.log('üìä Dados recebidos:', {
                            times: dados.times?.length || 0,
                            categorias: dados.categorias?.length || 0,
                            escolhas: Object.keys(dados.escolhas || {}).length,
                            usuario: dados.usuario?.nome
                        });
                        
                        // Carregar dados
                        times.value = dados.times || [];
                        categorias.value = dados.categorias || [];
                        prazo.value = dados.prazo || null;
                        usuario.value = dados.usuario || {};
                        escolhas.value = dados.escolhas || {};
                        
                        // Inicializar escolhas tempor√°rias
                        inicializarEscolhasTemp();
                        
                        loading.value = false;
                    } else {
                        console.error('‚ùå Falha ao carregar dados');
                        loading.value = false;
                        
                        if (tg) {
                            tg.showAlert('‚ùå Erro ao carregar dados. Volte e tente novamente.');
                        }
                    }
                });

                return {
                    loading,
                    salvando,
                    times,
                    categorias,
                    prazo,
                    usuario,
                    escolhas,
                    escolhasTemp,
                    alteracoes,
                    categoriasPreenchidas,
                    categoriasPreenchidasTemp,
                    percentualPreenchido,
                    temAlteracoes,
                    tempoRestante,
                    formatarData,
                    marcarAlteracao,
                    salvarEscolhas
                };
            }
        });

        // Incluir biblioteca pako para descompress√£o gzip
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js';
        script.onload = () => {
            console.log('‚úÖ Pako carregado - pronto para descompress√£o');
        };
        document.head.appendChild(script);

        app.mount('#app');
    </script>
</body>
</html>
