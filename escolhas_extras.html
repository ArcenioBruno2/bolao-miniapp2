<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0a1c2a;
            color: white;
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 26px;
            color: #FFD700;
        }

        .loading, .error-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 20px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prazo-box {
            background: rgba(255,215,0,0.1);
            border: 1px solid #FFD700;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progresso {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .progresso-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .contador {
            color: #FFD700;
            font-weight: bold;
            font-size: 22px;
        }

        .barra-container {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .barra {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }

        .categoria {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .categoria.preenchida {
            border-color: #4CAF50;
            background: rgba(76,175,80,0.1);
        }

        .categoria-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .icone {
            font-size: 28px;
            margin-right: 12px;
        }

        .info {
            flex: 1;
        }

        .nome {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pontos {
            font-size: 13px;
            color: #FFD700;
            background: rgba(255,215,0,0.1);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
        }

        select option {
            background: #0a1c2a;
            color: white;
        }

        .escolha-atual {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(255,215,0,0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-salvar {
            width: 100%;
            padding: 18px;
            background: #FFD700;
            border: none;
            border-radius: 30px;
            color: #0a1c2a;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            margin: 24px 0 40px;
            transition: opacity 0.2s;
        }

        .btn-salvar:active {
            opacity: 0.8;
        }

        .error-details {
            background: rgba(244,67,54,0.1);
            border: 1px solid #f44336;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            word-break: break-all;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2 style="color: #FFD700;">Carregando Pontos Extras</h2>
            <p id="loading-status" style="color: #aaa;">Preparando...</p>
        </div>

        <!-- ERROR -->
        <div id="error" style="display: none;">
            <div class="error-details">
                <h3 style="color: #ff8a80; margin-bottom: 16px;">‚ùå Erro ao carregar</h3>
                <p id="error-message" style="margin-bottom: 16px;"></p>
                <div id="error-hash" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; font-size: 11px; margin-bottom: 20px;"></div>
                <button onclick="window.location.reload()" style="padding: 12px 30px; background: #FFD700; border: none; border-radius: 30px; color: #0a1c2a; font-weight: bold; cursor: pointer;">
                    üîÑ Tentar Novamente
                </button>
            </div>
        </div>

        <!-- MAIN -->
        <div id="main" style="display: none;">
            <div class="header">
                <h1>‚≠ê PONTOS EXTRAS 2026</h1>
            </div>

            <div id="prazo-container"></div>

            <div class="progresso">
                <div class="progresso-header">
                    <span>üéØ Seus palpites</span>
                    <span class="contador" id="contador">0/15</span>
                </div>
                <div class="barra-container">
                    <div class="barra" id="barra-progresso"></div>
                </div>
            </div>

            <div id="categorias-container"></div>

            <button class="btn-salvar" id="btn-salvar">
                üíæ SALVAR ESCOLHAS
            </button>
        </div>
    </div>

    <script>
        // ==================== SOLU√á√ÉO DEFINITIVA - DECODIFICA√á√ÉO MANUAL ====================
        
        console.log('üöÄ Iniciando WebApp...');
        
        // Elementos
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const mainEl = document.getElementById('main');
        const loadingStatus = document.getElementById('loading-status');

        // ==================== FUN√á√ÉO BASE64URL PARA UINT8Array ====================
        function base64UrlToUint8Array(base64url) {
            // 1. Substituir caracteres URL-safe
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            
            // 2. Remover QUALQUER caractere que n√£o seja Base64 v√°lido
            base64 = base64.replace(/[^A-Za-z0-9+/]/g, '');
            
            // 3. Adicionar padding
            while (base64.length % 4) {
                base64 += '=';
            }
            
            console.log('üì¶ Base64 limpo:', base64.substring(0, 50) + '...');
            console.log('üì¶ Tamanho Base64:', base64.length);
            
            // 4. Decodificar manualmente (fallback se atob falhar)
            try {
                // Tentar com atob primeiro
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes;
            } catch (e) {
                console.warn('atob falhou, tentando decodifica√ß√£o manual:', e);
                
                // Decodifica√ß√£o manual Base64
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
                let output = [];
                let buffer = 0;
                let bits = 0;
                
                for (let i = 0; i < base64.length; i++) {
                    if (base64[i] === '=') break;
                    
                    const val = chars.indexOf(base64[i]);
                    if (val === -1) continue;
                    
                    buffer = (buffer << 6) | val;
                    bits += 6;
                    
                    if (bits >= 8) {
                        bits -= 8;
                        output.push((buffer >> bits) & 0xFF);
                    }
                }
                
                return new Uint8Array(output);
            }
        }

        // ==================== DECODIFICAR GZIP MANUAL ====================
        function decompressGzip(bytes) {
            try {
                // Tentar com pako primeiro
                return pako.ungzip(bytes);
            } catch (e) {
                console.error('Pako falhou:', e);
                throw new Error('N√£o foi poss√≠vel descomprimir os dados');
            }
        }

        // ==================== FUN√á√ÉO PRINCIPAL ====================
        function decodeData() {
            try {
                // PASSO 1: Pegar a URL completa
                const url = window.location.href;
                console.log('üìå URL:', url);
                
                // PASSO 2: Encontrar o hash (tudo depois do #)
                const hashIndex = url.indexOf('#');
                if (hashIndex === -1) {
                    throw new Error('Nenhum dado encontrado na URL');
                }
                
                // PASSO 3: Pegar o hash BRUTO
                let hash = url.substring(hashIndex + 1);
                console.log('üì¶ Hash bruto (in√≠cio):', hash.substring(0, 100));
                console.log('üì¶ Tamanho do hash:', hash.length);
                
                loadingStatus.textContent = `üì¶ Dados recebidos (${hash.length} chars)`;
                
                // PASSO 4: O hash come√ßa com 'H4sI' que √© o cabe√ßalho GZIP
                // N√ÉO PRECISA REMOVER NADA, √© parte do Base64 v√°lido
                
                // PASSO 5: Converter Base64URL para bytes
                const compressedBytes = base64UrlToUint8Array(hash);
                console.log('üì¶ Bytes comprimidos:', compressedBytes.length);
                
                loadingStatus.textContent = `üîì Descomprimindo (${compressedBytes.length} bytes)...`;
                
                // PASSO 6: Descomprimir
                const decompressedBytes = decompressGzip(compressedBytes);
                console.log('üì¶ Bytes descomprimidos:', decompressedBytes.length);
                
                // PASSO 7: Converter para texto
                const jsonText = new TextDecoder('utf-8').decode(decompressedBytes);
                console.log('üìÑ JSON (in√≠cio):', jsonText.substring(0, 200));
                
                // PASSO 8: Parse JSON
                const data = JSON.parse(jsonText);
                console.log('‚úÖ Dados carregados!');
                console.log('   Times:', data.times?.length);
                console.log('   Categorias:', data.categorias?.length);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                throw error;
            }
        }

        // ==================== RENDERIZAR ====================
        function renderizar(data) {
            if (!data) throw new Error('Dados inv√°lidos');
            
            const times = data.times || [];
            const categorias = data.categorias || [];
            const escolhas = data.escolhas || {};
            const prazo = data.prazo || '';
            
            // Mostrar main
            loadingEl.style.display = 'none';
            mainEl.style.display = 'block';
            
            // Prazo
            if (prazo) {
                const [dataPart, horaPart] = prazo.split(' ');
                const [ano, mes, dia] = dataPart.split('-');
                const dataFormatada = `${dia}/${mes}/${ano} √†s ${horaPart}`;
                
                document.getElementById('prazo-container').innerHTML = `
                    <div class="prazo-box">
                        <span style="font-size: 28px;">‚è∞</span>
                        <div>
                            <div style="font-size: 13px; color: #aaa;">ENCERRAMENTO</div>
                            <div style="font-size: 18px; font-weight: bold; color: #FFD700;">${dataFormatada}</div>
                        </div>
                    </div>
                `;
            }
            
            // Categorias
            const container = document.getElementById('categorias-container');
            container.innerHTML = '';
            
            categorias.forEach(cat => {
                const codigo = cat.item || cat.codigo;
                const nome = cat.nome;
                const icone = cat.icone || '‚öΩ';
                const pontos = cat.pontos || 0;
                const escolhaAtual = escolhas[codigo] || '';
                
                const card = document.createElement('div');
                card.className = `categoria ${escolhaAtual ? 'preenchida' : ''}`;
                
                // Criar select
                let selectHtml = `<select data-codigo="${codigo}"><option value="">üîΩ Selecione um time...</option>`;
                times.forEach(time => {
                    selectHtml += `<option value="${time}" ${time === escolhaAtual ? 'selected' : ''}>‚öΩ ${time}</option>`;
                });
                selectHtml += '</select>';
                
                card.innerHTML = `
                    <div class="categoria-header">
                        <span class="icone">${icone}</span>
                        <div class="info">
                            <div class="nome">${nome}</div>
                            <span class="pontos">${pontos} pts</span>
                        </div>
                    </div>
                    ${selectHtml}
                    ${escolhaAtual ? `<div class="escolha-atual"><span>‚úÖ</span><span>${escolhaAtual}</span></div>` : ''}
                `;
                
                container.appendChild(card);
                
                // Event listener
                const select = card.querySelector('select');
                select.addEventListener('change', function() {
                    const valor = this.value;
                    if (valor) {
                        card.classList.add('preenchida');
                        let div = card.querySelector('.escolha-atual');
                        if (div) {
                            div.innerHTML = `<span>‚úÖ</span><span>${valor}</span>`;
                        } else {
                            const nova = document.createElement('div');
                            nova.className = 'escolha-atual';
                            nova.innerHTML = `<span>‚úÖ</span><span>${valor}</span>`;
                            card.appendChild(nova);
                        }
                    } else {
                        card.classList.remove('preenchida');
                        const div = card.querySelector('.escolha-atual');
                        if (div) div.remove();
                    }
                    atualizarContador();
                });
            });
            
            // Contador
            function atualizarContador() {
                const selects = document.querySelectorAll('select[data-codigo]');
                let count = 0;
                selects.forEach(s => { if (s.value) count++; });
                document.getElementById('contador').textContent = `${count}/${categorias.length}`;
                document.getElementById('barra-progresso').style.width = (count / categorias.length * 100) + '%';
            }
            atualizarContador();
            
            // Bot√£o salvar
            document.getElementById('btn-salvar').onclick = function() {
                const selects = document.querySelectorAll('select[data-codigo]');
                const escolhasArray = [];
                selects.forEach(s => {
                    if (s.value) {
                        escolhasArray.push({
                            item: s.dataset.codigo,
                            time: s.value
                        });
                    }
                });
                
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.sendData(JSON.stringify({ escolhas: escolhasArray }));
                    window.Telegram.WebApp.showAlert(`‚úÖ ${escolhasArray.length} palpites salvos!`);
                }
            };
        }

        // ==================== EXECUTAR ====================
        try {
            // Verificar se tem hash
            if (!window.location.hash || window.location.hash.length < 50) {
                throw new Error('URL sem dados. Use o bot do Telegram.');
            }
            
            // Decodificar
            const dados = decodeData();
            
            // Renderizar
            renderizar(dados);
            
        } catch (error) {
            console.error('‚ùå ERRO FATAL:', error);
            
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            
            document.getElementById('error-message').innerHTML = error.message;
            document.getElementById('error-hash').innerHTML = `
                <strong>Hash bruto:</strong><br>
                ${window.location.hash.substring(0, 200)}...<br><br>
                <strong>Length:</strong> ${window.location.hash.length}<br>
                <strong>Pako:</strong> ${typeof pako !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>
                <strong>Plataforma:</strong> ${navigator.platform}
            `;
        }
    </script>
</body>
</html>
