<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0f2128;
            color: white;
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 26px;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prazo-box {
            background: #1a2f3a;
            border-left: 4px solid #FFD700;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progresso {
            background: #1a2f3a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .progresso-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .contador {
            color: #FFD700;
            font-weight: bold;
            font-size: 22px;
        }

        .barra-container {
            width: 100%;
            height: 10px;
            background: #2a404a;
            border-radius: 5px;
            overflow: hidden;
        }

        .barra {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }

        .categoria {
            background: #1a2f3a;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #2a404a;
        }

        .categoria.preenchida {
            border-color: #4CAF50;
            background: #1a3a3a;
        }

        .categoria-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .icone {
            font-size: 28px;
            margin-right: 12px;
        }

        .info {
            flex: 1;
        }

        .nome {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pontos {
            font-size: 13px;
            color: #FFD700;
            background: rgba(255,215,0,0.1);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        select {
            width: 100%;
            padding: 14px 16px;
            background: #0f2128;
            border: 1px solid #2a404a;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #FFD700;
        }

        select option {
            background: #0f2128;
            color: white;
            padding: 12px;
        }

        .escolha-atual {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(255,215,0,0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-salvar {
            width: 100%;
            padding: 18px;
            background: #FFD700;
            border: none;
            border-radius: 30px;
            color: #0f2128;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            margin: 24px 0 40px;
            transition: opacity 0.2s;
        }

        .btn-salvar:active {
            opacity: 0.8;
        }

        .btn-salvar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .erro {
            background: #442222;
            border-left: 4px solid #ff4444;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            color: #ff8888;
        }

        .hash-info {
            background: #0a1a1a;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            word-break: break-all;
            margin-top: 20px;
            color: #aaa;
        }
    </style>
    
    <!-- Pako para descompress√£o GZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="app">
            <!-- Loading -->
            <div id="loading-screen" class="loading">
                <div class="spinner"></div>
                <h2 style="color: #FFD700;">Carregando...</h2>
                <p id="loading-status" style="color: #aaa;">Decodificando dados</p>
            </div>

            <!-- Erro -->
            <div id="error-screen" style="display: none;">
                <div class="erro">
                    <h3 style="color: #ff8888; margin-bottom: 12px;">‚ùå Erro ao carregar</h3>
                    <p id="error-message"></p>
                    <div id="error-details" style="margin-top: 16px; font-size: 12px; background: #331111; padding: 12px; border-radius: 6px;"></div>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 12px 30px; background: #FFD700; border: none; border-radius: 30px; color: #0f2128; font-weight: bold; cursor: pointer;">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            </div>

            <!-- Conte√∫do Principal -->
            <div id="main-screen" style="display: none;">
                <div class="header">
                    <h1>‚≠ê PONTOS EXTRAS 2026</h1>
                </div>

                <!-- Prazo -->
                <div id="prazo-container"></div>

                <!-- Progresso -->
                <div class="progresso">
                    <div class="progresso-header">
                        <span>üéØ Seus palpites</span>
                        <span class="contador" id="contador">0/15</span>
                    </div>
                    <div class="barra-container">
                        <div class="barra" id="barra-progresso"></div>
                    </div>
                </div>

                <!-- Categorias -->
                <div id="categorias-container"></div>

                <!-- Bot√£o Salvar -->
                <button class="btn-salvar" id="btn-salvar">
                    üíæ SALVAR ESCOLHAS
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DECODIFICADOR SIMPLIFICADO ====================
        // Baseado no log: JSON 1640 bytes -> GZIP 633 bytes -> Base64 844 chars
        
        console.log('üöÄ Iniciando WebApp...');
        
        const Telegram = window.Telegram?.WebApp;
        if (Telegram) {
            Telegram.expand();
            Telegram.ready();
            console.log('‚úÖ Telegram WebApp ready');
        }

        // Elementos da UI
        const loadingScreen = document.getElementById('loading-screen');
        const errorScreen = document.getElementById('error-screen');
        const mainScreen = document.getElementById('main-screen');
        const loadingStatus = document.getElementById('loading-status');

        // ==================== FUN√á√ÉO DE DECODIFICA√á√ÉO ====================
        function decodeDataFromHash() {
            try {
                // 1. Pegar o hash da URL (tudo ap√≥s #)
                const hash = window.location.hash.substring(1);
                
                if (!hash) {
                    throw new Error('‚ùå Nenhum dado encontrado na URL');
                }

                console.log('üì¶ Hash length:', hash.length);
                console.log('üì¶ Hash preview:', hash.substring(0, 50) + '...');
                
                loadingStatus.textContent = `üì¶ Dados: ${hash.length} caracteres`;

                // 2. Converter base64url -> base64
                let base64 = hash.replace(/-/g, '+').replace(/_/g, '/');
                
                // 3. Adicionar padding
                while (base64.length % 4) {
                    base64 += '=';
                }
                
                console.log('üì¶ Base64 length:', base64.length);
                loadingStatus.textContent = 'üîì Decodificando Base64...';

                // 4. Decodificar base64
                let compressed;
                try {
                    compressed = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    console.log('üì¶ Compressed size:', compressed.length, 'bytes');
                } catch (e) {
                    throw new Error('Erro na decodifica√ß√£o Base64: ' + e.message);
                }

                // 5. Descomprimir GZIP
                loadingStatus.textContent = `üì¶ Descomprimindo (${compressed.length} bytes)...`;
                
                let decompressed;
                try {
                    decompressed = pako.ungzip(compressed);
                    console.log('üì¶ Decompressed size:', decompressed.length, 'bytes');
                } catch (e) {
                    console.error('Erro pako:', e);
                    throw new Error('Erro na descompress√£o GZIP: ' + e.message);
                }

                // 6. Converter para texto
                loadingStatus.textContent = 'üìÑ Parseando JSON...';
                
                const jsonText = new TextDecoder('utf-8').decode(decompressed);
                console.log('üìÑ JSON preview:', jsonText.substring(0, 200) + '...');

                // 7. Parse JSON
                const data = JSON.parse(jsonText);
                console.log('‚úÖ Dados carregados:', data);
                
                return data;

            } catch (error) {
                console.error('‚ùå Erro na decodifica√ß√£o:', error);
                throw error;
            }
        }

        // ==================== RENDERIZAR INTERFACE ====================
        function renderizarDados(data) {
            if (!data) throw new Error('Dados vazios');
            
            // Extrair dados
            const times = data.times || [];
            const categorias = data.categorias || [];
            const escolhasSalvas = data.escolhas || {};
            const prazo = data.prazo || '';
            const usuario = data.usuario || {};
            
            console.log(`üìä Times: ${times.length}, Categorias: ${categorias.length}, Escolhas: ${Object.keys(escolhasSalvas).length}`);
            
            if (times.length === 0) {
                throw new Error('Nenhum time carregado');
            }
            
            if (categorias.length === 0) {
                throw new Error('Nenhuma categoria carregada');
            }

            // Esconder loading, mostrar main
            loadingScreen.style.display = 'none';
            mainScreen.style.display = 'block';

            // ============ PRAZO ============
            const prazoContainer = document.getElementById('prazo-container');
            if (prazo) {
                const [dataPart, horaPart] = prazo.split(' ');
                const [ano, mes, dia] = dataPart.split('-');
                const dataFormatada = `${dia}/${mes}/${ano} √†s ${horaPart}`;
                
                prazoContainer.innerHTML = `
                    <div class="prazo-box">
                        <span style="font-size: 24px;">‚è∞</span>
                        <div>
                            <div style="font-weight: bold; color: #FFD700;">Encerramento</div>
                            <div style="font-size: 15px;">${dataFormatada} (Bras√≠lia)</div>
                        </div>
                    </div>
                `;
            }

            // ============ CATEGORIAS ============
            const container = document.getElementById('categorias-container');
            container.innerHTML = '';

            // Guardar escolhas atuais para refer√™ncia
            window.escolhasAtuais = { ...escolhasSalvas };
            window.escolhasTemp = { ...escolhasSalvas };

            // Renderizar cada categoria
            categorias.forEach((cat, index) => {
                const codigo = cat.item || cat.codigo;
                const nome = cat.nome;
                const icone = cat.icone || '‚öΩ';
                const pontos = cat.pontos || 0;
                
                const escolhaAtual = escolhasSalvas[codigo] || '';
                const temEscolha = !!escolhaAtual;

                const card = document.createElement('div');
                card.className = `categoria ${temEscolha ? 'preenchida' : ''}`;
                card.dataset.codigo = codigo;

                // Header
                const header = document.createElement('div');
                header.className = 'categoria-header';
                header.innerHTML = `
                    <span class="icone">${icone}</span>
                    <div class="info">
                        <div class="nome">${nome}</div>
                        <span class="pontos">${pontos} pontos</span>
                    </div>
                `;

                // Select
                const select = document.createElement('select');
                select.dataset.codigo = codigo;
                
                // Op√ß√£o vazia
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'üîΩ Escolha um time...';
                select.appendChild(emptyOption);
                
                // Op√ß√µes dos times
                times.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = `‚öΩ ${time}`;
                    if (time === escolhaAtual) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                card.appendChild(header);
                card.appendChild(select);

                // Mostrar escolha atual
                if (temEscolha) {
                    const escolhaDiv = document.createElement('div');
                    escolhaDiv.className = 'escolha-atual';
                    escolhaDiv.innerHTML = `
                        <span>‚úÖ</span>
                        <span style="font-weight: 600;">${escolhaAtual}</span>
                    `;
                    card.appendChild(escolhaDiv);
                }

                container.appendChild(card);

                // Evento de mudan√ßa
                select.addEventListener('change', function(e) {
                    const cod = this.dataset.codigo;
                    const valor = this.value;
                    
                    window.escolhasTemp[cod] = valor;
                    
                    // Atualizar visual
                    if (valor) {
                        card.classList.add('preenchida');
                        
                        let escolhaDiv = card.querySelector('.escolha-atual');
                        if (escolhaDiv) {
                            escolhaDiv.innerHTML = `
                                <span>‚úÖ</span>
                                <span style="font-weight: 600;">${valor}</span>
                            `;
                        } else {
                            const novaDiv = document.createElement('div');
                            novaDiv.className = 'escolha-atual';
                            novaDiv.innerHTML = `
                                <span>‚úÖ</span>
                                <span style="font-weight: 600;">${valor}</span>
                            `;
                            card.appendChild(novaDiv);
                        }
                    } else {
                        card.classList.remove('preenchida');
                        const escolhaDiv = card.querySelector('.escolha-atual');
                        if (escolhaDiv) escolhaDiv.remove();
                    }
                    
                    atualizarContador();
                    window.escolhasModificadas = true;
                });
            });

            // ============ CONTADOR ============
            function atualizarContador() {
                const selects = document.querySelectorAll('select[data-codigo]');
                let count = 0;
                selects.forEach(select => {
                    if (select.value) count++;
                });
                
                document.getElementById('contador').textContent = `${count}/${categorias.length}`;
                const percent = (count / categorias.length) * 100;
                document.getElementById('barra-progresso').style.width = percent + '%';
            }
            
            atualizarContador();

            // ============ BOT√ÉO SALVAR ============
            const btnSalvar = document.getElementById('btn-salvar');
            
            btnSalvar.onclick = function() {
                const selects = document.querySelectorAll('select[data-codigo]');
                const escolhasArray = [];
                
                selects.forEach(select => {
                    const item = select.dataset.codigo;
                    const time = select.value;
                    
                    if (time && time.trim() !== '') {
                        escolhasArray.push({
                            item: item,
                            time: time.trim()
                        });
                    }
                });
                
                console.log('üì§ Enviando escolhas:', escolhasArray.length);
                
                const payload = JSON.stringify({ escolhas: escolhasArray });
                
                if (Telegram) {
                    Telegram.sendData(payload);
                    Telegram.showAlert(`‚úÖ ${escolhasArray.length} palpites salvos!`);
                } else {
                    alert('Escolhas: ' + payload);
                }
            };
        }

        // ==================== INICIALIZA√á√ÉO ====================
        try {
            // Verificar se pako carregou
            if (typeof pako === 'undefined') {
                throw new Error('Biblioteca pako n√£o carregada');
            }
            
            // Decodificar dados
            const dados = decodeDataFromHash();
            
            // Renderizar
            renderizarDados(dados);
            
        } catch (error) {
            console.error('‚ùå Erro fatal:', error);
            
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'block';
            
            document.getElementById('error-message').innerHTML = error.message;
            
            const details = document.getElementById('error-details');
            details.innerHTML = `
                <strong>Hash:</strong> ${window.location.hash.substring(0, 100)}...<br>
                <strong>Hash length:</strong> ${window.location.hash.length}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Pako:</strong> ${typeof pako !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>
                <strong>Telegram:</strong> ${Telegram ? '‚úÖ' : '‚ùå'}<br>
            `;
        }
    </script>
</body>
</html>
