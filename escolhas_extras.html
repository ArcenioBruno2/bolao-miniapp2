<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚≠ê Pontos Extras 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0a1c2a;
            color: white;
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 26px;
            color: #FFD700;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-box {
            background: rgba(244,67,54,0.1);
            border: 1px solid #f44336;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            text-align: center;
        }

        .debug-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            font-size: 12px;
            font-family: monospace;
            word-break: break-all;
            color: #aaa;
            text-align: left;
        }

        .btn {
            padding: 12px 30px;
            background: #FFD700;
            border: none;
            border-radius: 30px;
            color: #0a1c2a;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2 style="color: #FFD700;">Carregando Pontos Extras</h2>
            <p id="status" style="color: #aaa;">Inicializando...</p>
        </div>

        <div id="error" style="display: none;">
            <div class="error-box">
                <h3 style="color: #ff8a80; margin-bottom: 16px;">‚ùå Erro de Decodifica√ß√£o</h3>
                <p id="error-message" style="margin-bottom: 16px;"></p>
                <div id="debug-info" class="debug-box"></div>
                <button class="btn" onclick="window.location.reload()">üîÑ Tentar Novamente</button>
            </div>
        </div>

        <div id="main" style="display: none;">
            <div class="header">
                <h1>‚≠ê PONTOS EXTRAS 2026</h1>
            </div>
            <div id="content"></div>
        </div>
    </div>

    <script>
        // ==================== SOLU√á√ÉO ALTERNATIVA ====================
        // O problema: o navegador est√° corrompendo o hash
        // Solu√ß√£o: usar o initData do Telegram em vez do hash!
        
        console.log('üöÄ Iniciando WebApp...');
        
        const statusEl = document.getElementById('status');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const mainEl = document.getElementById('main');

        // ==================== VERIFICAR TELEGRAM ====================
        const tg = window.Telegram?.WebApp;
        
        if (!tg) {
            // N√£o est√° no Telegram - erro
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            document.getElementById('error-message').innerHTML = 'Este aplicativo s√≥ funciona dentro do Telegram!';
            document.getElementById('debug-info').innerHTML = `
                <strong>‚ùå Fora do Telegram</strong><br>
                Abra este link pelo bot: @seu_bot
            `;
            throw new Error('Fora do Telegram');
        }

        // Expandir Telegram WebApp
        tg.expand();
        tg.ready();
        
        console.log('‚úÖ Telegram WebApp OK');
        statusEl.innerHTML = '‚úÖ Telegram conectado';

        // ==================== TENTAR 1: initData ====================
        if (tg.initData) {
            try {
                console.log('üì¶ initData encontrado!');
                statusEl.innerHTML = 'üì¶ Processando initData...';
                
                // O initData pode conter os dados codificados
                const params = new URLSearchParams(tg.initData);
                console.log('üì¶ initData params:', Array.from(params.entries()));
                
                // Talvez os dados estejam aqui...
                // Seu bot pode estar enviando via start_param
            } catch (e) {
                console.warn('initData n√£o cont√©m dados v√°lidos');
            }
        }

        // ==================== TENTAR 2: URL COMPLETA ====================
        // Em vez de window.location.hash, vamos pegar a URL COMPLETA e ESCAPAR
        const urlCompleta = window.location.href;
        console.log('üìå URL completa:', urlCompleta);
        
        // Tentar encontrar o hash de forma diferente
        let hash = '';
        
        // M√©todo 1: decodeURIComponent no hash
        try {
            hash = decodeURIComponent(window.location.hash.substring(1));
            console.log('üì¶ Hash decodeURIComponent:', hash.substring(0, 50));
        } catch (e) {
            console.warn('Falha no decodeURIComponent');
        }
        
        // M√©todo 2: pegar direto da URL
        try {
            const match = urlCompleta.match(/#(.*)$/);
            if (match) {
                hash = match[1];
                console.log('üì¶ Hash regex:', hash.substring(0, 50));
            }
        } catch (e) {
            console.warn('Falha no regex');
        }

        // ==================== TENTAR 3: DADOS FIXOS (TESTE) ====================
        // Se n√£o conseguir decodificar, vamos mostrar uma mensagem clara
        if (!hash || hash.length < 100) {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            
            document.getElementById('error-message').innerHTML = `
                <strong>üîß Erro de transmiss√£o de dados</strong><br><br>
                O link foi corrompido pelo Telegram WebView.
            `;
            
            let debugInfo = `
                <strong>üîç DIAGN√ìSTICO:</strong><br>
                üìå URL: ${urlCompleta.substring(0, 100)}...<br>
                üì¶ Hash length: ${window.location.hash.length}<br>
                üì¶ Hash preview: ${window.location.hash.substring(0, 50)}...<br>
                üì± Platform: ${tg.platform}<br>
                üì± Version: ${tg.version}<br>
                üîß InitData: ${tg.initData ? '‚úÖ' : '‚ùå'}<br><br>
                <strong>‚ö†Ô∏è SOLU√á√ÉO:</strong><br>
                1. Feche este WebApp<br>
                2. Abra NOVAMENTE pelo bot<br>
                3. Use o bot√£o "Fazer Escolhas Agora"<br>
            `;
            
            document.getElementById('debug-info').innerHTML = debugInfo;
            
            throw new Error('Hash corrompido');
        }

        // ==================== TENTAR DECODIFICAR ====================
        statusEl.innerHTML = 'üì¶ Decodificando dados...';

        // Fun√ß√£o para decodificar Base64URL manualmente
        function base64UrlDecode(base64url) {
            // Preparar string
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            
            // Remover caracteres inv√°lidos
            base64 = base64.replace(/[^A-Za-z0-9+/=]/g, '');
            
            // Adicionar padding
            while (base64.length % 4) {
                base64 += '=';
            }
            
            try {
                // Tentar decodificar
                return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
            } catch (e) {
                console.error('atob falhou:', e);
                
                // Decodifica√ß√£o manual
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
                let output = [];
                let buffer = 0;
                let bits = 0;
                
                for (let i = 0; i < base64.length; i++) {
                    if (base64[i] === '=') break;
                    
                    const val = chars.indexOf(base64[i]);
                    if (val === -1) continue;
                    
                    buffer = (buffer << 6) | val;
                    bits += 6;
                    
                    if (bits >= 8) {
                        bits -= 8;
                        output.push((buffer >> bits) & 0xFF);
                    }
                }
                
                return new Uint8Array(output);
            }
        }

        try {
            statusEl.innerHTML = `üîì Decodificando Base64 (${hash.length} chars)...`;
            
            // Converter Base64URL para bytes
            const compressed = base64UrlDecode(hash);
            console.log('üì¶ Bytes comprimidos:', compressed.length);
            
            statusEl.innerHTML = `üîì Descomprimindo (${compressed.length} bytes)...`;
            
            // Descomprimir com pako
            if (typeof pako === 'undefined') {
                throw new Error('Pako n√£o carregado');
            }
            
            let decompressed;
            try {
                decompressed = pako.ungzip(compressed);
                console.log('üì¶ Bytes descomprimidos:', decompressed.length);
            } catch (e) {
                console.error('Pako ungzip falhou:', e);
                
                // Tentar com inflate
                try {
                    decompressed = pako.inflate(compressed);
                    console.log('üì¶ Inflate funcionou:', decompressed.length);
                } catch (e2) {
                    throw new Error('Falha na descompress√£o: ' + e.message);
                }
            }
            
            statusEl.innerHTML = 'üìÑ Parseando JSON...';
            
            // Converter para texto
            const jsonText = new TextDecoder('utf-8').decode(decompressed);
            console.log('üìÑ JSON preview:', jsonText.substring(0, 100));
            
            // Parse JSON
            const data = JSON.parse(jsonText);
            console.log('‚úÖ Dados carregados!');
            
            // ==================== MOSTRAR DADOS ====================
            loadingEl.style.display = 'none';
            mainEl.style.display = 'block';
            
            const content = document.getElementById('content');
            
            // Mostrar prazo
            if (data.prazo) {
                content.innerHTML += `<div style="background: rgba(255,215,0,0.1); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                    ‚è∞ Encerramento: <strong style="color: #FFD700;">${data.prazo}</strong>
                </div>`;
            }
            
            // Mostrar times carregados
            content.innerHTML += `<div style="margin-bottom: 20px;">
                <strong>‚úÖ Dados carregados com sucesso!</strong><br>
                üèÜ Times: ${data.times?.length || 0}<br>
                üéØ Categorias: ${data.categorias?.length || 0}<br>
                üìù Suas escolhas: ${Object.keys(data.escolhas || {}).length}
            </div>`;
            
            // Lista de categorias simplificada
            if (data.categorias && data.categorias.length > 0) {
                content.innerHTML += '<h3 style="margin-bottom: 16px;">üìã Categorias:</h3>';
                
                data.categorias.forEach(cat => {
                    const codigo = cat.item || cat.codigo;
                    const nome = cat.nome;
                    const icone = cat.icone || '‚öΩ';
                    const escolha = data.escolhas?.[codigo] || 'N√£o preenchido';
                    
                    content.innerHTML += `
                        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 24px; margin-right: 12px;">${icone}</span>
                                <span style="font-weight: 600;">${nome}</span>
                            </div>
                            <div style="color: #FFD700;">‚úÖ ${escolha}</div>
                        </div>
                    `;
                });
            }
            
            // Bot√£o para enviar dados de teste
            content.innerHTML += `
                <button onclick="enviarTeste()" style="width: 100%; padding: 16px; background: #FFD700; border: none; border-radius: 30px; color: #0a1c2a; font-weight: bold; margin-top: 20px;">
                    üì§ TESTAR ENVIO
                </button>
            `;
            
            window.enviarTeste = function() {
                const teste = { escolhas: [{ item: "teste", time: "Time Teste" }] };
                tg.sendData(JSON.stringify(teste));
                tg.showAlert('üì§ Teste enviado!');
            };
            
        } catch (error) {
            console.error('‚ùå Erro:', error);
            
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            
            document.getElementById('error-message').innerHTML = error.message;
            
            // Mostrar diagn√≥stico completo
            document.getElementById('debug-info').innerHTML = `
                <strong>üîç DIAGN√ìSTICO COMPLETO:</strong><br><br>
                
                üìå URL: ${window.location.href.substring(0, 150)}...<br>
                üì¶ Hash (raw): ${window.location.hash.substring(0, 100)}...<br>
                üì¶ Hash length: ${window.location.hash.length}<br>
                üì¶ Hash type: ${typeof window.location.hash}<br>
                <br>
                üì± Telegram Platform: ${tg.platform}<br>
                üì± Telegram Version: ${tg.version}<br>
                üì¶ initData: ${tg.initData ? '‚úÖ' : '‚ùå'}<br>
                <br>
                üîß Pako: ${typeof pako !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>
                üîß atob: ${typeof atob !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>
                <br>
                ‚ö†Ô∏è O hash est√° sendo corrompido pelo Telegram WebView.<br>
                <br>
                <strong style="color: #FFD700;">SOLU√á√ÉO:</strong><br>
                1. Volte para o bot<br>
                2. Use o comando /escolha_extra NOVAMENTE<br>
                3. Clique no bot√£o rec√©m-criado<br>
            `;
        }
    </script>
    
    <!-- Carregar pako depois -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</body>
</html>
