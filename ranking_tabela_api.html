<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark light">
    <title>üèÜ Ranking - Bol√£o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #ffffff);
            padding: 15px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container { max-width: 100%; }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--tg-theme-button-color, #2481cc);
        }
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
            color: var(--tg-theme-button-color, #2481cc);
        }
        .header .subtitle {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999999);
        }
        .loading-spinner {
            border: 3px solid rgba(36, 129, 204, 0.3);
            border-top: 3px solid var(--tg-theme-button-color, #2481cc);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid #ff3232;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .error button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 10px;
        }
        .select-rodada, .select-view {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #2a2a2a);
            color: var(--tg-theme-text-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #444444);
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .ranking-table th {
            background: var(--tg-theme-secondary-bg-color, #2a2a2a);
            padding: 12px 8px;
            text-align: left;
            font-size: 0.9em;
            border-bottom: 2px solid var(--tg-theme-button-color, #2481cc);
        }
        .ranking-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #333333);
        }
        .ranking-table tr:hover {
            background: var(--tg-theme-secondary-bg-color, #2a2a2a);
        }
        
        .posicao-cell { width: 50px; text-align: center; }
        .nome-cell { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pontos-cell { width: 70px; text-align: center; font-weight: bold; }
        .estat-cell { width: 40px; text-align: center; font-size: 0.85em; color: var(--tg-theme-hint-color, #999999); }
        
        .medalha { display: inline-block; width: 24px; height: 24px; text-align: center; line-height: 24px; border-radius: 50%; margin-right: 8px; }
        .primeiro { background: gold; color: #000; font-weight: bold; }
        .segundo { background: silver; color: #000; font-weight: bold; }
        .terceiro { background: #cd7f32; color: #000; font-weight: bold; }
        .quarto { background: #4a90e2; color: #fff; font-weight: bold; }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: var(--tg-theme-secondary-bg-color, #2a2a2a);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }
        .stat-label {
            font-size: 0.8em;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 5px;
        }
        
        .user-link {
            color: var(--tg-theme-button-color, #2481cc);
            text-decoration: none;
            cursor: pointer;
        }
        .user-link:hover {
            text-decoration: underline;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--tg-theme-hint-color, #333333);
            color: var(--tg-theme-hint-color, #999999);
            font-size: 0.8em;
        }
        
        @media (max-width: 600px) {
            .controls { flex-direction: column; }
            .ranking-table { font-size: 0.9em; }
            .ranking-table th, .ranking-table td { padding: 8px 4px; }
            .stats-bar { flex-wrap: wrap; gap: 10px; }
            .stat-item { flex: 1 0 40%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">üèÜ Carregando Ranking...</h1>
            <div class="subtitle" id="subtitle">Aguarde enquanto buscamos os dados</div>
        </div>
        
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Buscando dados do ranking...</p>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <p id="error-message">Erro ao carregar dados</p>
            <button onclick="carregarDados()">Tentar Novamente</button>
        </div>
        
        <div id="content" style="display: none;">
            <div class="controls">
                <select id="rodadaSelect" class="select-rodada" onchange="mudarRodada(this.value)">
                    <option value="">Carregando rodadas...</option>
                </select>
                <select id="viewSelect" class="select-view" onchange="mudarVisualizacao(this.value)">
                    <option value="completa">Visualiza√ß√£o Completa</option>
                    <option value="simples">Apenas Pontua√ß√£o</option>
                </select>
            </div>
            
            <div class="stats-bar" id="statsBar">
                <!-- Preenchido por JavaScript -->
            </div>
            
            <table class="ranking-table" id="rankingTable">
                <thead>
                    <tr>
                        <th class="posicao-cell">#</th>
                        <th class="nome-cell">Participante</th>
                        <th class="pontos-cell">Pontos</th>
                        <th class="estat-cell">PE</th>
                        <th class="estat-cell">RC</th>
                        <th class="estat-cell">GM</th>
                        <th class="estat-cell">GV</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                    <!-- Preenchido por JavaScript -->
                </tbody>
            </table>
            
            <div class="footer">
                <p>Atualizado em: <span id="updateTime">--:--</span></p>
                <p>Total de participantes: <span id="totalParticipants">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes
        const API_BASE_URL = 'http://localhost:5000/api'; // Altere para sua VPS
        let currentRodada = null;
        let rodadasDisponiveis = [];
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Extrai par√¢metros da URL
            const urlParams = new URLSearchParams(window.location.search);
            const rodadaParam = urlParams.get('rodada');
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                // Modo antigo (com dados na URL) - fallback
                try {
                    const decoded = atob(dataParam);
                    const data = JSON.parse(decoded);
                    renderizarDadosAntigos(data);
                } catch (e) {
                    console.error('Erro ao decodificar dados antigos:', e);
                    carregarDadosViaAPI();
                }
            } else if (rodadaParam) {
                // Novo modo com API
                currentRodada = parseInt(rodadaParam);
                carregarDadosRodada(currentRodada);
            } else {
                // Sem par√¢metros, carrega √∫ltima rodada
                carregarUltimaRodada();
            }
        });
        
        function carregarDadosRodada(rodadaNum) {
            showLoading();
            hideError();
            hideContent();
            
            fetch(`${API_BASE_URL}/ranking/rodada/${rodadaNum}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        renderizarRanking(data);
                        atualizarSelectRodadas(rodadaNum);
                    } else {
                        throw new Error(data.detail || 'Erro na API');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar ranking:', error);
                    showError(`Erro ao carregar rodada ${rodadaNum}: ${error.message}`);
                });
        }
        
        function carregarUltimaRodada() {
            // Primeiro busca rodadas dispon√≠veis
            fetch(`${API_BASE_URL}/ranking/rodada/1`) // Tenta rodada 1
                .then(response => {
                    if (response.ok) return response.json();
                    // Se n√£o tem rodada 1, busca lista de rodadas de outra forma
                    throw new Error('Buscando √∫ltima rodada...');
                })
                .then(data => {
                    if (data.success && data.rodada) {
                        carregarDadosRodada(data.rodada);
                    } else {
                        // Fallback: tenta rodadas comuns
                        tentarRodadasComuns();
                    }
                })
                .catch(() => tentarRodadasComuns());
        }
        
        function tentarRodadasComuns() {
            // Tenta rodadas comuns (1, 2, 3...)
            const rodadasParaTestar = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            
            function testarRodada(index) {
                if (index >= rodadasParaTestar.length) {
                    showError('Nenhuma rodada com ranking dispon√≠vel');
                    return;
                }
                
                const rodada = rodadasParaTestar[index];
                fetch(`${API_BASE_URL}/ranking/rodada/${rodada}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json().then(data => {
                                if (data.success && data.data && data.data.length > 0) {
                                    carregarDadosRodada(rodada);
                                } else {
                                    testarRodada(index + 1);
                                }
                            });
                        } else {
                            testarRodada(index + 1);
                        }
                    })
                    .catch(() => testarRodada(index + 1));
            }
            
            testarRodada(0);
        }
        
        function renderizarRanking(apiData) {
            const data = apiData.data;
            const rodada = apiData.rodada;
            
            // Atualiza t√≠tulo
            document.getElementById('title').textContent = `üèÜ Ranking - Rodada ${rodada}`;
            document.getElementById('subtitle').textContent = `${data.length} participantes`;
            
            // Atualiza estat√≠sticas
            atualizarStatsBar(data);
            
            // Preenche tabela
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Medalha/posi√ß√£o
                const posCell = document.createElement('td');
                posCell.className = 'posicao-cell';
                
                if (item.posicao <= 4) {
                    const medalClass = ['primeiro', 'segundo', 'terceiro', 'quarto'][item.posicao - 1];
                    const medalEmoji = ['ü•á', 'ü•à', 'ü•â', 'üéñÔ∏è'][item.posicao - 1];
                    posCell.innerHTML = `<div class="medalha ${medalClass}">${medalEmoji}</div>`;
                } else {
                    posCell.textContent = item.posicao;
                }
                
                // Nome (com link para palpites)
                const nomeCell = document.createElement('td');
                nomeCell.className = 'nome-cell';
                nomeCell.innerHTML = `
                    <a class="user-link" onclick="verPalpitesUsuario(${item.usuario_id}, ${rodada})">
                        ${item.nome}
                    </a>
                `;
                
                // Pontua√ß√£o
                const pontosCell = document.createElement('td');
                pontosCell.className = 'pontos-cell';
                pontosCell.textContent = item.total;
                
                // Estat√≠sticas
                const peCell = document.createElement('td');
                peCell.className = 'estat-cell';
                peCell.textContent = item.estatisticas.pe || 0;
                peCell.title = 'Placar Exato';
                
                const rcCell = document.createElement('td');
                rcCell.className = 'estat-cell';
                rcCell.textContent = item.estatisticas.rc || 0;
                rcCell.title = 'Resultado Correto';
                
                const gmCell = document.createElement('td');
                gmCell.className = 'estat-cell';
                gmCell.textContent = item.estatisticas.gm || 0;
                gmCell.title = 'Gols Mandante';
                
                const gvCell = document.createElement('td');
                gvCell.className = 'estat-cell';
                gvCell.textContent = item.estatisticas.gv || 0;
                gvCell.title = 'Gols Visitante';
                
                // Monta linha
                row.appendChild(posCell);
                row.appendChild(nomeCell);
                row.appendChild(pontosCell);
                row.appendChild(peCell);
                row.appendChild(rcCell);
                row.appendChild(gmCell);
                row.appendChild(gvCell);
                
                tbody.appendChild(row);
            });
            
            // Atualiza footer
            document.getElementById('totalParticipants').textContent = data.length;
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('pt-BR');
            
            // Mostra conte√∫do
            hideLoading();
            showContent();
        }
        
        function atualizarStatsBar(data) {
            const statsBar = document.getElementById('statsBar');
            
            if (data.length === 0) {
                statsBar.innerHTML = '<div class="stat-item"><div class="stat-value">0</div><div class="stat-label">Sem dados</div></div>';
                return;
            }
            
            // Calcula estat√≠sticas
            const pontos = data.map(item => item.total);
            const media = pontos.reduce((a, b) => a + b, 0) / pontos.length;
            const max = Math.max(...pontos);
            const min = Math.min(...pontos);
            
            const totalPE = data.reduce((sum, item) => sum + (item.estatisticas.pe || 0), 0);
            const totalPD = data.filter(item => item.estatisticas.pd_usada).length;
            
            statsBar.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${data.length}</div>
                    <div class="stat-label">Participantes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${media.toFixed(1)}</div>
                    <div class="stat-label">M√©dia</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${max}</div>
                    <div class="stat-label">Maior</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${totalPE}</div>
                    <div class="stat-label">PE Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${totalPD}</div>
                    <div class="stat-label">PD Usadas</div>
                </div>
            `;
        }
        
        function atualizarSelectRodadas(rodadaAtual) {
            // Aqui voc√™ poderia buscar a lista de rodadas dispon√≠veis
            // Por enquanto, vamos criar um select simples
            const select = document.getElementById('rodadaSelect');
            
            // Se j√° temos rodadas dispon√≠veis, preenche
            if (rodadasDisponiveis.length > 0) {
                select.innerHTML = '';
                rodadasDisponiveis.forEach(rodada => {
                    const option = document.createElement('option');
                    option.value = rodada;
                    option.textContent = `Rodada ${rodada}`;
                    if (rodada === rodadaAtual) option.selected = true;
                    select.appendChild(option);
                });
            } else {
                // Cria op√ß√µes b√°sicas
                select.innerHTML = `
                    <option value="${rodadaAtual}" selected>Rodada ${rodadaAtual}</option>
                    <option value="geral">Ranking Geral</option>
                `;
            }
        }
        
        function mudarRodada(rodada) {
            if (rodada === 'geral') {
                // Carrega ranking geral
                fetch(`${API_BASE_URL}/ranking/geral`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('title').textContent = 'üèÜ Ranking Geral';
                            renderizarRanking({...data, rodada: 'Geral'});
                        }
                    });
            } else if (rodada && rodada !== currentRodada) {
                currentRodada = parseInt(rodada);
                carregarDadosRodada(currentRodada);
            }
        }
        
        function mudarVisualizacao(view) {
            // Implemente mudan√ßa de visualiza√ß√£o se necess√°rio
            console.log('Mudando para visualiza√ß√£o:', view);
        }
        
        function verPalpitesUsuario(usuarioId, rodada) {
            // Abre Web App de palpites do usu√°rio
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.openLink(`https://t.me/${Telegram.WebApp.initDataUnsafe.user?.username || 'bot_bolao_bot'}?start=palpites_${usuarioId}_${rodada}`);
            } else {
                // Fallback para navegador normal
                window.open(`palpites_usuario_api.html?usuario=${usuarioId}&rodada=${rodada}`, '_blank');
            }
        }
        
        function carregarDadosViaAPI() {
            // Tenta detectar rodada atual
            const urlParams = new URLSearchParams(window.location.search);
            const rodada = urlParams.get('rodada') || 1;
            carregarDadosRodada(parseInt(rodada));
        }
        
        // Fun√ß√µes auxiliares de UI
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').style.display = 'block';
            hideLoading();
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function showContent() {
            document.getElementById('content').style.display = 'block';
        }
        
        function hideContent() {
            document.getElementById('content').style.display = 'none';
        }
        
        // Fallback para dados antigos (compatibilidade)
        function renderizarDadosAntigos(data) {
            console.log('Usando dados antigos (fallback)');
            // Implemente se necess√°rio
        }
        
        // Fun√ß√£o global para recarregar
        window.carregarDados = carregarDadosViaAPI;
    </script>
</body>
</html>
