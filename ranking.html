<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Geral</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .header h1 i {
            font-size: 36px;
        }
        
        .header-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #6a11cb;
            margin-bottom: 25px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section h2 i {
            font-size: 28px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #6a11cb;
            border-bottom: 3px solid #6a11cb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }
        
        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a11cb;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .ranking-table th {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            border: none;
        }
        
        .ranking-table th:first-child {
            border-top-left-radius: 10px;
        }
        
        .ranking-table th:last-child {
            border-top-right-radius: 10px;
        }
        
        .ranking-table td {
            padding: 18px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .ranking-table tr:hover {
            background: #f8fbff;
        }
        
        .ranking-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .ranking-table tr:nth-child(even):hover {
            background: #f0f5ff;
        }
        
        .posicao {
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            width: 70px;
        }
        
        .posicao-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFEC8B 100%);
            color: #333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 18px;
        }
        
        .posicao-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #E0E0E0 100%);
            color: #333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 18px;
        }
        
        .posicao-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #E6B87F 100%);
            color: #333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 18px;
        }
        
        .nome-usuario {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .detalhes-usuario {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .pontuacao {
            font-weight: bold;
            color: #00a854;
            font-size: 20px;
        }
        
        .estatisticas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .estatistica-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .estatistica-label {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .estatistica-valor {
            font-weight: bold;
            color: #6a11cb;
            font-size: 14px;
        }
        
        .filtros {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .filtro-group {
            margin-bottom: 15px;
        }
        
        .filtro-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .filtro-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filtro-input:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }
        
        .filtro-botoes {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .filtro-btn {
            flex: 1;
            padding: 12px;
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filtro-btn:hover {
            background: #5a0db3;
            transform: translateY(-2px);
        }
        
        .filtro-btn.reset {
            background: #666;
        }
        
        .filtro-btn.reset:hover {
            background: #555;
        }
        
        .resumo-geral {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .resumo-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .resumo-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .resumo-valor {
            font-size: 24px;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }
        
        .no-data i {
            font-size: 70px;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        .voltar-btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .voltar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .ranking-table {
                display: block;
                overflow-x: auto;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 12px;
                font-size: 14px;
            }
            
            .resumo-grid {
                grid-template-columns: 1fr;
            }
            
            .estatisticas {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .ranking-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .ranking-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .ranking-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 10px 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            background: #e0e0e0;
        }
        
        .action-btn.active {
            background: #6a11cb;
            color: white;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-trophy"></i> Ranking Geral</h1>
            <div class="header-subtitle">Pontuação acumulada de todas as rodadas</div>
        </div>
        
        <div class="content">
            <div class="resumo-geral" id="resumoGeral" style="display: none;">
                <!-- Resumo geral carregado dinamicamente -->
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('ranking')">
                    <i class="fas fa-trophy"></i> Ranking Geral
                </div>
                <div class="tab" onclick="showTab('filtros')">
                    <i class="fas fa-filter"></i> Filtros
                </div>
            </div>
            
            <div class="tab-content active" id="tab-ranking">
                <div class="ranking-actions">
                    <div>
                        <div class="ranking-title" id="rankingTitle">Ranking Geral</div>
                        <div class="ranking-subtitle" id="rankingSubtitle">Carregando dados...</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn" onclick="sortBy('total')" id="sortTotal">
                            <i class="fas fa-sort-amount-down"></i> Pontuação
                        </button>
                        <button class="action-btn" onclick="sortBy('pe')" id="sortPE">
                            <i class="fas fa-star"></i> PE
                        </button>
                        <button class="action-btn" onclick="sortBy('rc')" id="sortRC">
                            <i class="fas fa-check-circle"></i> RC
                        </button>
                    </div>
                </div>
                
                <div id="rankingContainer">
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Carregando ranking geral...</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-filtros">
                <div class="filtros">
                    <div class="filtro-group">
                        <label class="filtro-label">Nome do Usuário</label>
                        <input type="text" class="filtro-input" id="filtroNome" placeholder="Buscar por nome...">
                    </div>
                    
                    <div class="filtro-group">
                        <label class="filtro-label">Pontuação Mínima</label>
                        <input type="number" class="filtro-input" id="filtroPontosMin" placeholder="Ex: 0">
                    </div>
                    
                    <div class="filtro-group">
                        <label class="filtro-label">Pontuação Máxima</label>
                        <input type="number" class="filtro-input" id="filtroPontosMax" placeholder="Ex: 1000">
                    </div>
                    
                    <div class="filtro-botoes">
                        <button class="filtro-btn" onclick="aplicarFiltros()">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button class="filtro-btn reset" onclick="resetarFiltros()">
                            <i class="fas fa-redo"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <div id="filtrosContainer">
                    <!-- Resultados filtrados serão exibidos aqui -->
                </div>
            </div>
            
            <div id="noData" class="no-data" style="display: none;">
                <i class="fas fa-chart-line"></i>
                <h3>Nenhum dado disponível</h3>
                <p>Aguarde o carregamento do ranking geral.</p>
            </div>
            
            <button class="voltar-btn" onclick="Telegram.WebApp.close()">
                <i class="fas fa-arrow-left"></i> Voltar ao Menu
            </button>
        </div>
    </div>

    <script>
        // Dados recebidos do bot
        let dados = null;
        let rankingGeral = [];
        let rankingFiltrado = [];
        let filtroAtivo = false;
        let currentSort = 'total';
        let sortDirection = 'desc';

        // Inicialização
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Obter dados da URL
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    showError('Dados não encontrados');
                    return;
                }
                
                // Decodificar dados
                const jsonData = atob(dataParam);
                dados = JSON.parse(jsonData);
                
                if (!dados || dados.tipo !== 'ranking') {
                    showError('Dados inválidos');
                    return;
                }
                
                // Configurar Telegram WebApp
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.setHeaderColor('#6a11cb');
                Telegram.WebApp.setBackgroundColor('#f0f0f0');
                
                // Carregar ranking geral
                await carregarRankingGeral();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao carregar dados');
            }
        });

        function showTab(tabId) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes(tabId === 'ranking' ? 'Ranking' : 'Filtros')) {
                    tab.classList.add('active');
                }
            });
        }

        async function carregarRankingGeral() {
            try {
                // Buscar ranking geral
                const response = await fetch('/get_ranking_geral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar ranking geral');
                }
                
                const rankingData = await response.json();
                
                if (!rankingData || !rankingData.ranking || rankingData.ranking.length === 0) {
                    document.getElementById('rankingContainer').innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-users"></i>
                            <h3>Nenhum ranking disponível</h3>
                            <p>Ainda não há dados de ranking geral.</p>
                        </div>
                    `;
                    return;
                }
                
                rankingGeral = rankingData.ranking;
                rankingFiltrado = [...rankingGeral];
                
                // Ordenar por pontuação total (descendente)
                sortBy('total');
                
                // Exibir resumo geral
                exibirResumoGeral(rankingData);
                
            } catch (error) {
                console.error('Erro ao carregar ranking geral:', error);
                document.getElementById('rankingContainer').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar ranking</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function exibirResumoGeral(rankingData) {
            const resumoDiv = document.getElementById('resumoGeral');
            
            const totalParticipantes = rankingGeral.length;
            const totalRodadas = rankingData.total_rodadas || 0;
            
            // Calcular estatísticas
            let totalPontos = 0;
            let maiorPontuacao = 0;
            let menorPontuacao = Infinity;
            
            rankingGeral.forEach(participante => {
                totalPontos += participante.total || 0;
                if (participante.total > maiorPontuacao) {
                    maiorPontuacao = participante.total;
                }
                if (participante.total < menorPontuacao) {
                    menorPontuacao = participante.total;
                }
            });
            
            const mediaPontos = totalParticipantes > 0 ? totalPontos / totalParticipantes : 0;
            
            resumoDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 20px; font-size: 22px;">
                    <i class="fas fa-chart-pie"></i> Resumo do Bolão
                </div>
                
                <div class="resumo-grid">
                    <div class="resumo-item">
                        <div class="resumo-label">Total de Participantes</div>
                        <div class="resumo-valor">${totalParticipantes}</div>
                    </div>
                    
                    <div class="resumo-item">
                        <div class="resumo-label">Total de Rodadas</div>
                        <div class="resumo-valor">${totalRodadas}</div>
                    </div>
                    
                    <div class="resumo-item">
                        <div class="resumo-label">Média de Pontos</div>
                        <div class="resumo-valor">${mediaPontos.toFixed(1)} pts</div>
                    </div>
                    
                    <div class="resumo-item">
                        <div class="resumo-label">Maior Pontuação</div>
                        <div class="resumo-valor">${maiorPontuacao} pts</div>
                    </div>
                    
                    <div class="resumo-item">
                        <div class="resumo-label">Menor Pontuação</div>
                        <div class="resumo-valor">${menorPontuacao} pts</div>
                    </div>
                </div>
            `;
            
            resumoDiv.style.display = 'block';
        }

        function sortBy(criteria) {
            currentSort = criteria;
            
            // Atualizar botões ativos
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btnId = `sort${criteria.charAt(0).toUpperCase() + criteria.slice(1)}`;
            document.getElementById(btnId).classList.add('active');
            
            // Alternar direção se clicar no mesmo critério
            if (currentSort === criteria) {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                sortDirection = 'desc';
            }
            
            // Ordenar ranking
            rankingFiltrado.sort((a, b) => {
                let valueA, valueB;
                
                switch (criteria) {
                    case 'total':
                        valueA = a.total || 0;
                        valueB = b.total || 0;
                        break;
                    case 'pe':
                        valueA = a.estatisticas?.pe || 0;
                        valueB = b.estatisticas?.pe || 0;
                        break;
                    case 'rc':
                        valueA = a.estatisticas?.rc || 0;
                        valueB = b.estatisticas?.rc || 0;
                        break;
                    default:
                        valueA = a.total || 0;
                        valueB = b.total || 0;
                }
                
                if (sortDirection === 'desc') {
                    return valueB - valueA;
                } else {
                    return valueA - valueB;
                }
            });
            
            // Exibir ranking ordenado
            exibirRanking();
        }

        function exibirRanking() {
            if (!rankingFiltrado || rankingFiltrado.length === 0) {
                document.getElementById('rankingContainer').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <h3>Nenhum participante encontrado</h3>
                        <p>${filtroAtivo ? 'Nenhum usuário corresponde aos filtros aplicados.' : 'Ainda não há participantes no ranking geral.'}</p>
                    </div>
                `;
                
                document.getElementById('rankingTitle').textContent = filtroAtivo ? 'Resultados Filtrados' : 'Ranking Geral';
                document.getElementById('rankingSubtitle').textContent = filtroAtivo ? 
                    '0 participantes encontrados' : 
                    `${rankingGeral.length} participantes`;
                    
                return;
            }
            
            // Atualizar título e subtítulo
            document.getElementById('rankingTitle').textContent = filtroAtivo ? 'Resultados Filtrados' : 'Ranking Geral';
            document.getElementById('rankingSubtitle').textContent = filtroAtivo ? 
                `${rankingFiltrado.length} de ${rankingGeral.length} participantes` : 
                `${rankingFiltrado.length} participantes`;
            
            // Encontrar maior pontuação para a barra de progresso
            const maiorPontuacao = Math.max(...rankingFiltrado.map(p => p.total || 0));
            
            // Criar tabela de ranking
            let rankingHTML = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Posição</th>
                            <th>Participante</th>
                            <th style="width: 120px;">Pontuação</th>
                            <th>Estatísticas</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rankingFiltrado.forEach((participante, index) => {
                const posicao = filtroAtivo ? index + 1 : getPosicaoReal(participante.usuario_id);
                const estatisticas = participante.estatisticas || {};
                
                // Calcular porcentagem para barra de progresso
                const porcentagem = maiorPontuacao > 0 ? (participante.total / maiorPontuacao) * 100 : 0;
                
                // Formatar estatísticas
                const estatisticasHTML = `
                    <div class="estatisticas">
                        <div class="estatistica-item">
                            <span class="estatistica-label">
                                <i class="fas fa-star"></i> PE
                            </span>
                            <span class="estatistica-valor">${estatisticas.pe || 0}</span>
                        </div>
                        <div class="estatistica-item">
                            <span class="estatistica-label">
                                <i class="fas fa-check-circle"></i> RC
                            </span>
                            <span class="estatistica-valor">${estatisticas.rc || 0}</span>
                        </div>
                        <div class="estatistica-item">
                            <span class="estatistica-label">
                                <i class="fas fa-futbol"></i> GM
                            </span>
                            <span class="estatistica-valor">${estatisticas.gm || 0}</span>
                        </div>
                        <div class="estatistica-item">
                            <span class="estatistica-label">
                                <i class="fas fa-futbol"></i> GV
                            </span>
                            <span class="estatistica-valor">${estatisticas.gv || 0}</span>
                        </div>
                    </div>
                `;
                
                // Determinar classe da posição (apenas para ranking real, não filtrado)
                let posicaoClass = '';
                let posicaoHTML = posicao;
                
                if (!filtroAtivo && posicao === 1) {
                    posicaoClass = 'posicao-1';
                    posicaoHTML = '<i class="fas fa-crown"></i>';
                } else if (!filtroAtivo && posicao === 2) {
                    posicaoClass = 'posicao-2';
                    posicaoHTML = '<i class="fas fa-medal"></i>';
                } else if (!filtroAtivo && posicao === 3) {
                    posicaoClass = 'posicao-3';
                    posicaoHTML = '<i class="fas fa-medal"></i>';
                }
                
                rankingHTML += `
                    <tr>
                        <td class="posicao">
                            ${posicaoClass ? `<div class="${posicaoClass}">${posicaoHTML}</div>` : posicao}
                        </td>
                        <td>
                            <div class="nome-usuario">${participante.nome}</div>
                            <div class="detalhes-usuario">
                                <i class="fas fa-calendar-alt"></i> ${estatisticas.rodadas || 0} rodadas
                            </div>
                        </td>
                        <td>
                            <div class="pontuacao">${participante.total || 0} pts</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${porcentagem}%"></div>
                            </div>
                        </td>
                        <td>${estatisticasHTML}</td>
                    </tr>
                `;
            });
            
            rankingHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('rankingContainer').innerHTML = rankingHTML;
            document.getElementById('noData').style.display = 'none';
        }

        function getPosicaoReal(usuarioId) {
            if (!rankingGeral || rankingGeral.length === 0) return 0;
            
            // Ordenar por pontuação para obter posição real
            const rankingOrdenado = [...rankingGeral].sort((a, b) => (b.total || 0) - (a.total || 0));
            
            for (let i = 0; i < rankingOrdenado.length; i++) {
                if (rankingOrdenado[i].usuario_id === usuarioId) {
                    return i + 1;
                }
            }
            
            return 0;
        }

        function aplicarFiltros() {
            const nomeFiltro = document.getElementById('filtroNome').value.toLowerCase();
            const pontosMin = parseInt(document.getElementById('filtroPontosMin').value) || 0;
            const pontosMax = parseInt(document.getElementById('filtroPontosMax').value) || Infinity;
            
            rankingFiltrado = rankingGeral.filter(participante => {
                // Filtrar por nome
                if (nomeFiltro && !participante.nome.toLowerCase().includes(nomeFiltro)) {
                    return false;
                }
                
                // Filtrar por pontuação
                const pontuacao = participante.total || 0;
                if (pontuacao < pontosMin || pontuacao > pontosMax) {
                    return false;
                }
                
                return true;
            });
            
            filtroAtivo = nomeFiltro || pontosMin > 0 || pontosMax < Infinity;
            
            // Voltar para a tab de ranking
            showTab('ranking');
            
            // Ordenar e exibir resultados filtrados
            sortBy(currentSort);
        }

        function resetarFiltros() {
            document.getElementById('filtroNome').value = '';
            document.getElementById('filtroPontosMin').value = '';
            document.getElementById('filtroPontosMax').value = '';
            
            rankingFiltrado = [...rankingGeral];
            filtroAtivo = false;
            
            // Voltar para a tab de ranking
            showTab('ranking');
            
            // Ordenar e exibir ranking completo
            sortBy(currentSort);
        }

        function showError(message) {
            document.getElementById('rankingContainer').innerHTML = `
                <div class="no-data">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Erro</h3>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
