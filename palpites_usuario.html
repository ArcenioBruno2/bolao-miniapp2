<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpites e Pontua√ß√£o - Sistema Paginado</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Pako.js para descompress√£o Gzip -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f7; color: #333; line-height: 1.6; padding: 20px; 
        }
        .container { 
            max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; 
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        header { 
            background: linear-gradient(135deg, #007aff 0%, #0056cc 100%); 
            color: white; padding: 20px; text-align: center; 
        }
        h1 { font-size: 22px; margin-bottom: 8px; font-weight: 700; }
        .subtitle { font-size: 14px; opacity: 0.9; }
        .user-info { 
            padding: 15px 20px; background: #f8f9fa; 
            border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap;
        }
        .user-name { font-size: 16px; font-weight: 600; }
        .user-id { font-size: 12px; color: #666; }
        .rodada-info { 
            background: #e9f7ef; padding: 15px 20px; border-bottom: 1px solid #d4edda;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rodada-titulo { font-size: 18px; font-weight: 700; color: #28a745; }
        .carregar-btn { 
            background: #007aff; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: background 0.3s;
        }
        .carregar-btn:hover { background: #0056cc; }
        .select-container { padding: 15px 20px; border-bottom: 1px solid #e0e0e0; }
        .custom-select { position: relative; width: 100%; }
        select { 
            width: 100%; padding: 12px 16px; font-size: 15px; border: 2px solid #e0e0e0; 
            border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s;
            appearance: none; -webkit-appearance: none;
        }
        select:focus { border-color: #007aff; outline: none; }
        .resumo-container { 
            padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; 
        }
        .resumo-titulo { 
            font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #333;
        }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
        }
        .stat-card { 
            background: white; padding: 15px; border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center;
        }
        .stat-valor { 
            display: block; font-size: 22px; font-weight: 700; margin-bottom: 5px; 
        }
        .stat-label { 
            font-size: 12px; color: #666; text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .pontos-total { color: #28a745; }
        .palpitados-total { color: #007aff; }
        .jogos-container { padding: 0 20px 20px; }
        .jogos-header { 
            padding: 15px 0; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid #e0e0e0;
        }
        .jogos-titulo { font-size: 16px; font-weight: 600; }
        .contador { font-size: 14px; color: #666; }
        .jogos-lista { margin-top: 15px; }
        .jogo-card { 
            background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 18px; 
            margin-bottom: 15px; position: relative; transition: transform 0.2s, box-shadow 0.2s;
        }
        .jogo-card:hover { 
            transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .jogo-card.pd { border-left: 4px solid #dc3545; }
        .pd-badge { 
            position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; 
            padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; 
            text-transform: uppercase;
        }
        .jogo-header { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; flex-wrap: wrap;
        }
        .jogo-times { font-weight: 600; font-size: 16px; }
        .jogo-data { font-size: 12px; color: #666; }
        .placares-container { 
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; 
            align-items: center; margin-bottom: 15px; 
        }
        .placar-box { text-align: center; }
        .placar-label { font-size: 11px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .placar-valor { font-size: 18px; font-weight: 700; }
        .placar-real { color: #28a745; }
        .placar-palpite { color: #007aff; }
        .pontuacao-container { 
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;
        }
        .pontos { font-size: 18px; font-weight: 700; color: #28a745; }
        .acertos-container { display: flex; gap: 5px; flex-wrap: wrap; }
        .badge { 
            padding: 6px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; 
            text-transform: uppercase; 
        }
        .badge.placar-exato { background: #28a745; color: white; }
        .badge.resultado-correto { background: #007aff; color: white; }
        .badge.gols-mandante, .badge.gols-visitante { background: #6c757d; color: white; }
        .badge.pontuacao-dobrada { background: #dc3545; color: white; }
        .loading { 
            text-align: center; padding: 60px 20px; color: #666; 
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error { 
            text-align: center; padding: 40px 20px; color: #dc3545; background: #f8d7da;
            border-radius: 10px; border: 1px solid #f5c6cb; margin: 20px 0;
        }
        .no-data { 
            text-align: center; padding: 60px 20px; color: #666; 
        }
        .info-note {
            background: #e7f3ff; border-left: 4px solid #007aff;
            padding: 12px 16px; margin: 15px 0; border-radius: 0 8px 8px 0;
            font-size: 14px;
        }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .placares-container { grid-template-columns: 1fr; gap: 12px; }
            .placares-container > div:nth-child(2) { display: none; }
            .jogo-card { padding: 15px; }
            .jogo-header { flex-direction: column; align-items: flex-start; gap: 5px; }
            .user-info { flex-direction: column; align-items: flex-start; gap: 5px; }
            .rodada-info { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Palpites e Pontua√ß√£o</h1>
            <div class="subtitle" id="subtitle">Sistema Paginado</div>
        </header>
        
        <div class="user-info">
            <div>
                <div class="user-name" id="userName">Carregando...</div>
                <div class="user-id" id="userId">ID: -- | Telegram: --</div>
            </div>
        </div>
        
        <div class="rodada-info">
            <div class="rodada-titulo" id="rodadaTitulo">Rodada --</div>
            <button class="carregar-btn" onclick="carregarRodadaAtual()">
                üîÑ Carregar Rodada
            </button>
        </div>
        
        <div class="select-container">
            <div class="custom-select">
                <select id="rodadaSelect" onchange="selecionarRodadaFromSelect()">
                    <option value="">Selecione uma rodada...</option>
                </select>
            </div>
        </div>
        
        <div class="resumo-container">
            <div class="resumo-titulo">Resumo da Rodada</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-valor pontos-total" id="totalPontos">0</span>
                    <span class="stat-label">Pontos Totais</span>
                </div>
                <div class="stat-card">
                    <span class="stat-valor palpitados-total" id="jogosPalpitados">0</span>
                    <span class="stat-label">Jogos Palpitados</span>
                </div>
                <div class="stat-card">
                    <span class="stat-valor" id="totalJogos">0</span>
                    <span class="stat-label">Total de Jogos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-valor" id="jogosComPlacar">0</span>
                    <span class="stat-label">Com Placar Real</span>
                </div>
            </div>
        </div>
        
        <div class="jogos-container">
            <div class="jogos-header">
                <div class="jogos-titulo">Detalhes dos Jogos</div>
                <div class="contador" id="contadorJogos">0/0 jogos</div>
            </div>
            
            <div class="info-note">
                üìù <strong>Legenda dos Acertos:</strong><br>
                ‚Ä¢ <span class="badge placar-exato">Placar Exato</span>: 10 pontos<br>
                ‚Ä¢ <span class="badge resultado-correto">Resultado Correto</span>: 4 pontos<br>
                ‚Ä¢ <span class="badge gols-mandante">Gols Mandante</span>: 2 pontos<br>
                ‚Ä¢ <span class="badge gols-visitante">Gols Visitante</span>: 2 pontos<br>
                ‚Ä¢ <span class="badge pontuacao-dobrada">Pontua√ß√£o Dobrada</span>: Dobra os pontos
            </div>
            
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <div>Carregando dados da rodada...</div>
            </div>
            
            <div id="jogosLista" class="jogos-lista" style="display: none;"></div>
            
            <div id="noData" class="no-data" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">
                    Nenhum palpite nesta rodada
                </div>
                <div style="color: #666; margin-bottom: 20px;">
                    Voc√™ n√£o fez palpites nos jogos desta rodada.
                </div>
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ============================================
        // VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ÉO
        // ============================================
        let appData = null;
        let rodadasDisponiveis = [];
        let rodadasDadosCache = {}; // Cache local de rodadas j√° carregadas
        let rodadaAtual = null;
        let usuarioId = null;
        
        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Configura√ß√£o do Telegram Web App
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                Telegram.WebApp.setBackgroundColor('#f5f5f7');
                Telegram.WebApp.setHeaderColor('#007aff');
            }
            
            console.log('üöÄ Inicializando Web App Paginado...');
            carregarDadosDaURL();
        });
        
        // ============================================
        // FUN√á√ÉO PRINCIPAL: CARREGAR DADOS DA URL
        // ============================================
        function carregarDadosDaURL() {
            try {
                console.log('üîç Analisando URL para dados...');
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    mostrarErro('‚ùå Dados n√£o encontrados na URL');
                    return;
                }
                
                console.log('‚úÖ Dados encontrados na URL:', dataParam.length, 'caracteres');
                
                // Processa os dados (Gzip + Base64)
                appData = processarDadosRecebidos(dataParam);
                
                if (!appData) {
                    mostrarErro('‚ùå Falha ao processar dados');
                    return;
                }
                
                // Inicializa vari√°veis globais
                usuarioId = appData.usuario?.id || appData.u?.id;
                rodadasDisponiveis = appData.rodadas_disponiveis || appData.rd || [];
                
                // Tenta carregar rodada atual dos dados
                const rodadaAtualNum = appData.rodada_atual?.numero || appData.ra;
                const rodadaAtualDados = appData.rodada_atual || appData.rdc;
                
                if (rodadaAtualNum && rodadaAtualDados) {
                    rodadasDadosCache[rodadaAtualNum] = rodadaAtualDados;
                    rodadaAtual = rodadaAtualNum;
                    console.log(`‚úÖ Rodada inicial: ${rodadaAtual}`);
                }
                
                // Configura interface
                configurarInterface();
                
                // Exibe primeira rodada
                if (rodadaAtual) {
                    exibirRodada(rodadaAtual);
                } else if (rodadasDisponiveis.length > 0) {
                    const primeiraRodada = rodadasDisponiveis[0].n || rodadasDisponiveis[0].numero;
                    carregarRodadaDoBot(primeiraRodada);
                }
                
            } catch (error) {
                console.error('‚ùå Erro fatal:', error);
                mostrarErro(`Erro: ${error.message}`);
            }
        }
        
        // ============================================
        // PROCESSAMENTO DE DADOS (GZIP + BASE64)
        // ============================================
        function processarDadosRecebidos(dataParam) {
            console.log('üß© Processando dados recebidos...');
            
            // 1. Tenta descompress√£o Gzip
            try {
                console.log('üîÑ Tentando descompress√£o Gzip...');
                const dados = descomprimirGzip(dataParam);
                console.log('‚úÖ Gzip descomprimido com sucesso');
                console.log('üìä Tipo:', dados.tipo || dados.t);
                return dados;
            } catch (gzipError) {
                console.warn('‚ö†Ô∏è Gzip falhou:', gzipError.message);
            }
            
            // 2. Tenta Base64 URL-safe
            try {
                console.log('üîÑ Tentando Base64 URL-safe...');
                const base64Corrigida = corrigirBase64(dataParam);
                const jsonString = atob(base64Corrigida);
                console.log('‚úÖ Base64 decodificado:', jsonString.length, 'caracteres');
                const dados = JSON.parse(jsonString);
                console.log('‚úÖ JSON parseado com sucesso');
                return dados;
            } catch (base64Error) {
                console.warn('‚ö†Ô∏è Base64 URL-safe falhou:', base64Error.message);
            }
            
            // 3. Tenta Base64 normal
            try {
                console.log('üîÑ Tentando Base64 normal...');
                const jsonString = atob(dataParam);
                const dados = JSON.parse(jsonString);
                console.log('‚úÖ Base64 normal funcionou');
                return dados;
            } catch (finalError) {
                console.error('‚ùå Todos os m√©todos falharam');
                throw new Error('N√£o foi poss√≠vel decodificar os dados');
            }
        }
        
        function corrigirBase64(base64String) {
            // Converte URL-safe Base64 para Base64 padr√£o
            return base64String
                .replace(/\-/g, '+')
                .replace(/\_/g, '/')
                .padEnd(base64String.length + (4 - base64String.length % 4) % 4, '=');
        }
        
        function descomprimirGzip(base64String) {
            try {
                // 1. Corrige Base64
                const base64Corrigida = corrigirBase64(base64String);
                
                // 2. Decodifica Base64 para bytes
                const binaryString = atob(base64Corrigida);
                const bytes = new Uint8Array(binaryString.length);
                
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // 3. Verifica se √© Gzip v√°lido
                if (bytes[0] === 0x1F && bytes[1] === 0x8B) {
                    // 4. Descomprime com Pako
                    const decompressed = pako.inflate(bytes, { to: 'string' });
                    
                    // 5. Parse JSON
                    return JSON.parse(decompressed);
                } else {
                    // N√£o √© Gzip, tenta como JSON direto
                    const jsonString = binaryString;
                    return JSON.parse(jsonString);
                }
            } catch (error) {
                console.error('Erro na descompress√£o Gzip:', error);
                throw error;
            }
        }
        
        // ============================================
        // CONFIGURA√á√ÉO DA INTERFACE
        // ============================================
        function configurarInterface() {
            console.log('üé® Configurando interface...');
            
            // Informa√ß√µes do usu√°rio
            const usuarioNome = appData.usuario?.nome || appData.u?.n || 'Usu√°rio';
            const telegramId = appData.usuario?.telegram_id || appData.u?.tid || '--';
            
            document.getElementById('userName').textContent = usuarioNome;
            document.getElementById('userId').textContent = `ID: ${usuarioId} | Telegram: ${telegramId}`;
            document.getElementById('subtitle').textContent = `Usu√°rio: ${usuarioNome}`;
            
            // Popula select de rodadas
            popularSelectRodadas();
        }
        
        function popularSelectRodadas() {
            const select = document.getElementById('rodadaSelect');
            select.innerHTML = '';
            
            if (rodadasDisponiveis.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma rodada dispon√≠vel';
                select.appendChild(option);
                return;
            }
            
            // Ordena rodadas por n√∫mero
            rodadasDisponiveis.sort((a, b) => {
                const numA = a.numero || a.n || 0;
                const numB = b.numero || b.n || 0;
                return numA - numB;
            });
            
            // Adiciona op√ß√µes
            rodadasDisponiveis.forEach(rodada => {
                const option = document.createElement('option');
                const rodadaNum = rodada.numero || rodada.n;
                const pontos = rodada.pontos || rodada.p || 0;
                const status = rodada.status || rodada.s || '';
                const palpitados = rodada.palpitados || rodada.j || 0;
                const totalJogos = rodada.total_jogos || rodada.jt || 0;
                
                option.value = rodadaNum;
                
                // Texto formatado
                let texto = `Rodada ${rodadaNum}`;
                
                if (pontos > 0) {
                    texto += ` ‚Ä¢ ${pontos} pts`;
                }
                
                if (status === 'fechada') {
                    texto += ' ‚Ä¢ üîí';
                }
                
                if (totalJogos > 0) {
                    texto += ` ‚Ä¢ üìä ${palpitados}/${totalJogos}`;
                }
                
                // Marca como selecionada se for a atual
                if (rodadaNum === rodadaAtual) {
                    texto += ' ‚Ä¢ ‚úÖ';
                    option.selected = true;
                }
                
                option.textContent = texto;
                select.appendChild(option);
            });
        }
        
        // ============================================
        // FUN√á√ïES PARA MANIPULAR RODADAS
        // ============================================
        function selecionarRodadaFromSelect() {
            const select = document.getElementById('rodadaSelect');
            const rodadaNum = parseInt(select.value);
            
            if (!isNaN(rodadaNum)) {
                carregarRodadaDoBot(rodadaNum);
            }
        }
        
        function carregarRodadaAtual() {
            if (rodadaAtual) {
                carregarRodadaDoBot(rodadaAtual);
            } else {
                alert('Selecione uma rodada primeiro');
            }
        }
        
        function carregarRodadaDoBot(numeroRodada) {
            console.log(`üì° Solicitando rodada ${numeroRodada}...`);
            
            // Mostra loading
            mostrarLoading(true);
            
            // Verifica se j√° temos em cache
            if (rodadasDadosCache[numeroRodada]) {
                console.log('‚úÖ Rodada encontrada em cache');
                setTimeout(() => {
                    exibirRodada(numeroRodada);
                }, 300);
                return;
            }
            
            // Para rodadas n√£o carregadas, vamos navegar para nova URL
            // Esta √© a parte que fecha e reabre o WebApp
            console.log('üîÑ Navegando para nova rodada...');
            
            // Constr√≥i URL de navega√ß√£o
            const novaURL = construirURLNavegacao(numeroRodada);
            
            // Fecha o WebApp atual e abre novo
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
                // O bot ir√° reabrir com os novos dados
            }
            
            // Fallback: mostra mensagem
            setTimeout(() => {
                mostrarErro(`Por favor, selecione a rodada ${numeroRodada} novamente no menu do bot.`);
            }, 2000);
        }
        
        function construirURLNavegacao(rodadaNum) {
            // Esta URL seria processada pelo bot via /start command
            return `https://t.me/${Telegram.WebApp.initDataUnsafe.user?.username || 'bot'}?start=palpites_${usuarioId}_${rodadaNum}`;
        }
        
        function exibirRodada(numeroRodada) {
            console.log(`üéØ Exibindo rodada ${numeroRodada}...`);
            
            const rodadaDados = rodadasDadosCache[numeroRodada];
            
            if (!rodadaDados) {
                mostrarErro(`Dados da rodada ${numeroRodada} n√£o encontrados`);
                return;
            }
            
            // Atualiza estado atual
            rodadaAtual = numeroRodada;
            
            // Atualiza t√≠tulo
            document.getElementById('rodadaTitulo').textContent = `Rodada ${numeroRodada}`;
            
            // Atualiza select
            document.getElementById('rodadaSelect').value = numeroRodada;
            
            // Exibe resumo
            exibirResumoRodada(rodadaDados);
            
            // Exibe jogos
            exibirJogosRodada(rodadaDados);
            
            // Esconde loading
            mostrarLoading(false);
        }
        
        function exibirResumoRodada(rodada) {
            console.log('üìä Exibindo resumo da rodada...');
            
            // Extrai dados
            const pontosTotal = rodada.pontuacao_total || rodada.tp || 0;
            const jogosPalpitados = rodada.contagem?.jogos_palpitados || rodada.jp || 0;
            const totalJogos = rodada.contagem?.total_jogos_rodada || rodada.jt || 0;
            const jogosComPlacar = rodada.contagem?.jogos_com_placar || rodada.jcp || 0;
            
            // Estat√≠sticas por extenso
            const estatisticas = rodada.estatisticas || rodada.est || {};
            const placarExato = estatisticas.placar_exato || estatisticas.pe || 0;
            const resultadoCorreto = estatisticas.resultado_correto || estatisticas.rc || 0;
            const golsMandante = estatisticas.gols_mandante || estatisticas.gm || 0;
            const golsVisitante = estatisticas.gols_visitante || estatisticas.gv || 0;
            const temPD = estatisticas.pd_usada || false;
            
            // Atualiza elementos
            document.getElementById('totalPontos').textContent = pontosTotal;
            document.getElementById('jogosPalpitados').textContent = jogosPalpitados;
            document.getElementById('totalJogos').textContent = totalJogos;
            document.getElementById('jogosComPlacar').textContent = jogosComPlacar;
            
            // Atualiza contador
            document.getElementById('contadorJogos').textContent = 
                `${jogosPalpitados}/${totalJogos} jogos palpitados`;
        }
        
        function exibirJogosRodada(rodada) {
            console.log('‚öΩ Exibindo jogos da rodada...');
            
            const jogos = rodada.jogos || [];
            const container = document.getElementById('jogosLista');
            const noDataDiv = document.getElementById('noData');
            const errorDiv = document.getElementById('error');
            
            // Limpa e reseta
            container.innerHTML = '';
            errorDiv.style.display = 'none';
            noDataDiv.style.display = 'none';
            
            if (jogos.length === 0) {
                container.style.display = 'none';
                noDataDiv.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            
            // Ordena jogos pela ordem original (mant√©m ordem do bot)
            // O bot j√° envia na ordem correta
            
            // Cria cards para cada jogo
            jogos.forEach((jogo, index) => {
                const div = document.createElement('div');
                
                // Determina classe CSS
                let classeCSS = 'jogo-card';
                if (jogo.pd || jogo.pontuacao_dobrada) {
                    classeCSS += ' pd';
                }
                
                div.className = classeCSS;
                
                // HTML do card
                div.innerHTML = criarHTMLJogoCard(jogo, index + 1);
                
                container.appendChild(div);
            });
        }
        
        function criarHTMLJogoCard(jogo, numero) {
            // Extrai dados
            const mandante = jogo.mandante || jogo.m || 'Time Mandante';
            const visitante = jogo.visitante || jogo.v || 'Time Visitante';
            const dataHorario = jogo.data_horario || jogo.dh;
            const placarReal = jogo.placar_real || jogo.pr || '?x?';
            const palpite = jogo.palpite || jogo.pal || '0x0';
            const pontos = jogo.pontos || jogo.pts || 0;
            const acertos = jogo.acertos || jogo.ac || [];
            const acertosExtenso = jogo.acertos_extenso || [];
            const temPD = jogo.pd || jogo.pontuacao_dobrada || false;
            const palpitou = jogo.palpitou !== false;
            
            // Formata data/hora
            let dataFormatada = '';
            if (dataHorario) {
                try {
                    const data = new Date(dataHorario);
                    if (!isNaN(data)) {
                        dataFormatada = data.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao formatar data:', e);
                }
            }
            
            // Inicia HTML
            let html = '';
            
            // Badge de PD
            if (temPD) {
                html += '<div class="pd-badge">Pontua√ß√£o Dobrada</div>';
            }
            
            // Cabe√ßalho do jogo
            html += `
                <div class="jogo-header">
                    <div class="jogo-times">
                        ${mandante} vs ${visitante}
                    </div>
                    ${dataFormatada ? `
                        <div class="jogo-data">üìÖ ${dataFormatada}</div>
                    ` : ''}
                </div>
            `;
            
            // Se n√£o palpitou
            if (!palpitou) {
                html += `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-weight: 600;">N√£o palpitou neste jogo</div>
                    </div>
                `;
                return html;
            }
            
            // Placar real vs palpite
            html += `
                <div class="placares-container">
                    <div class="placar-box">
                        <div class="placar-label">Placar Real</div>
                        <div class="placar-valor placar-real">${placarReal}</div>
                    </div>
                    <div style="font-size: 20px; color: #ccc; font-weight: 300;">‚Üí</div>
                    <div class="placar-box">
                        <div class="placar-label">Seu Palpite</div>
                        <div class="placar-valor placar-palpite">${palpite}</div>
                    </div>
                </div>
            `;
            
            // Pontua√ß√£o e acertos
            html += `
                <div class="pontuacao-container">
                    <div class="pontos">${pontos} pontos</div>
                    <div class="acertos-container">
            `;
            
            // Badges de acertos (prefere vers√£o por extenso)
            if (acertosExtenso.length > 0) {
                acertosExtenso.forEach(acerto => {
                    let classeBadge = '';
                    
                    if (acerto.includes('Placar Exato')) classeBadge = 'placar-exato';
                    else if (acerto.includes('Resultado Correto')) classeBadge = 'resultado-correto';
                    else if (acerto.includes('Gols Mandante')) classeBadge = 'gols-mandante';
                    else if (acerto.includes('Gols Visitante')) classeBadge = 'gols-visitante';
                    else if (acerto.includes('Pontua√ß√£o Dobrada')) classeBadge = 'pontuacao-dobrada';
                    
                    html += `<span class="badge ${classeBadge}">${acerto}</span>`;
                });
            } else if (acertos.length > 0) {
                // Fallback para vers√£o abreviada
                acertos.forEach(acerto => {
                    let texto = '';
                    let classeBadge = '';
                    
                    switch(acerto) {
                        case 'PE': 
                            texto = 'Placar Exato'; 
                            classeBadge = 'placar-exato';
                            break;
                        case 'RC': 
                            texto = 'Resultado Correto'; 
                            classeBadge = 'resultado-correto';
                            break;
                        case 'GM': 
                            texto = 'Gols Mandante'; 
                            classeBadge = 'gols-mandante';
                            break;
                        case 'GV': 
                            texto = 'Gols Visitante'; 
                            classeBadge = 'gols-visitante';
                            break;
                        case 'PD': 
                            texto = 'Pontua√ß√£o Dobrada'; 
                            classeBadge = 'pontuacao-dobrada';
                            break;
                        default: 
                            texto = acerto;
                            classeBadge = '';
                    }
                    
                    html += `<span class="badge ${classeBadge}">${texto}</span>`;
                });
            } else {
                html += `<span style="font-size: 12px; color: #666;">Sem acertos</span>`;
            }
            
            html += `</div></div>`;
            
            return html;
        }
        
        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        function mostrarLoading(mostrar) {
            const loadingDiv = document.getElementById('loading');
            const jogosLista = document.getElementById('jogosLista');
            
            if (mostrar) {
                loadingDiv.style.display = 'flex';
                jogosLista.style.display = 'none';
                document.getElementById('noData').style.display = 'none';
                document.getElementById('error').style.display = 'none';
            } else {
                loadingDiv.style.display = 'none';
            }
        }
        
        function mostrarErro(mensagem) {
            console.error('üí• Erro:', mensagem);
            
            mostrarLoading(false);
            
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 15px;">‚ùå</div>
                <div style="font-weight: 600; margin-bottom: 10px;">Erro ao carregar</div>
                <div style="margin-bottom: 15px; font-size: 14px;">${mensagem}</div>
                <div style="font-size: 12px; color: #666;">
                    Tente novamente ou entre em contato com o administrador.
                </div>
            `;
            
            document.getElementById('jogosLista').style.display = 'none';
            document.getElementById('noData').style.display = 'none';
        }
        
        // ============================================
        // FUN√á√ïES DE DEBUG (para desenvolvimento)
        // ============================================
        window.debugDados = function() {
            console.log('=== DEBUG DADOS ===');
            console.log('appData:', appData);
            console.log('rodadasDisponiveis:', rodadasDisponiveis);
            console.log('rodadasDadosCache:', rodadasDadosCache);
            console.log('rodadaAtual:', rodadaAtual);
            console.log('usuarioId:', usuarioId);
            console.log('====================');
            
            // Mostra cache de rodadas
            Object.keys(rodadasDadosCache).forEach(num => {
                const rodada = rodadasDadosCache[num];
                console.log(`Rodada ${num}:`, {
                    jogos: rodada.jogos?.length || 0,
                    pontos: rodada.pontuacao_total || rodada.tp,
                    palpitados: rodada.contagem?.jogos_palpitados || rodada.jp
                });
            });
        };
        
        window.recarregar = function() {
            location.reload();
        };
    </script>
</body>
</html>
