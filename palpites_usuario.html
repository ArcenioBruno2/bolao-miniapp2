<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpites e Pontua√ß√£o</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Pako.js para descompress√£o Gzip -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f7; color: #333; line-height: 1.6; padding: 20px; 
        }
        .container { 
            max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; 
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        header { 
            background: linear-gradient(135deg, #007aff 0%, #0056cc 100%); 
            color: white; padding: 25px; text-align: center; 
        }
        h1 { font-size: 24px; margin-bottom: 8px; font-weight: 700; }
        .user-info { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .select-container { padding: 20px; }
        .custom-select { position: relative; width: 100%; }
        .select-box { 
            width: 100%; padding: 15px 20px; font-size: 16px; border: 2px solid #e0e0e0; 
            border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s; 
        }
        .select-box:focus { border-color: #007aff; }
        .rodada-resumo { 
            padding: 25px; background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); 
            color: white; text-align: center; 
        }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; 
        }
        .jogos-container { padding: 20px; }
        .jogo-card { 
            background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; 
            margin-bottom: 15px; position: relative; 
        }
        .jogo-card.pd { border-left: 4px solid #dc3545; }
        .pd-badge { 
            position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; 
            padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; 
        }
        .placares-container { 
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; 
            margin-bottom: 15px; 
        }
        .pontos { font-size: 20px; font-weight: 700; color: #28a745; }
        .badge { 
            padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; 
            text-transform: uppercase; 
        }
        .badge.pe { background: #28a745; color: white; }
        .badge.rc { background: #007aff; color: white; }
        .loading { text-align: center; padding: 60px 20px; color: #666; }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .placares-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Palpites e Pontua√ß√£o</h1>
            <div class="subtitle" id="subtitle">Carregando...</div>
        </header>
        
        <div class="user-info" id="userInfo">
            <div class="user-name" id="userName">Carregando...</div>
            <div class="user-id" id="userId">ID: --</div>
        </div>
        
        <div class="select-container">
            <div class="custom-select">
                <select class="select-box" id="rodadaSelect" onchange="mudarRodada()">
                    <option value="">Carregando...</option>
                </select>
            </div>
        </div>
        
        <div class="rodada-resumo" id="rodadaResumo" style="display: none;">
            <div class="rodada-titulo" id="rodadaTitulo">Rodada --</div>
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-value" id="totalPontos">0</span><span class="stat-label">Pontos</span></div>
                <div class="stat-card"><span class="stat-value" id="totalJogos">0</span><span class="stat-label">Jogos</span></div>
                <div class="stat-card"><span class="stat-value" id="jogosComPlacar">0</span><span class="stat-label">Com placar</span></div>
                <div class="stat-card"><span class="stat-value" id="totalPE">0</span><span class="stat-label">PE</span></div>
                <div class="stat-card"><span class="stat-value" id="totalRC">0</span><span class="stat-label">RC</span></div>
                <div class="stat-card"><span class="stat-value" id="temPD">N√£o</span><span class="stat-label">PD</span></div>
            </div>
        </div>
        
        <div class="jogos-container">
            <div class="jogos-titulo">
                <span>Jogos da rodada</span>
                <span id="contadorJogos">0 jogos</span>
            </div>
            <div class="jogos-lista" id="jogosLista"></div>
            <div class="loading" id="loading">Carregando...</div>
            <div class="error" id="error" style="display: none;">‚ùå Erro</div>
        </div>
    </div>

    <script>
        let appData = {};
        let rodadasInfo = [];
        let rodadasDados = {};
        let rodadaAtualNum = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            if (Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
            }
            carregarDadosDaURL();
        });
        
        function carregarDadosDaURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    mostrarErro('Dados n√£o encontrados');
                    return;
                }
                
                // Tenta descomprimir com Gzip
                let dados;
                try {
                    dados = descomprimirGzip(dataParam);
                } catch (e) {
                    console.warn('Falha ao descomprimir, tentando Base64 normal...');
                    dados = JSON.parse(atob(dataParam));
                }
                
                appData = dados;
                
                if (!appData || appData.t !== 'palpites_usuario_gzip') {
                    mostrarErro('Formato inv√°lido');
                    return;
                }
                
                // Preenche usu√°rio
                document.getElementById('userName').textContent = appData.u.n;
                document.getElementById('userId').textContent = `ID: ${appData.u.id} | Telegram: ${appData.u.tid}`;
                document.getElementById('subtitle').textContent = `Usu√°rio: ${appData.u.n}`;
                
                // Armazena dados
                rodadasInfo = appData.rd || [];
                rodadasDados = {};
                
                // A primeira rodada j√° vem completa
                if (appData.ra && appData.rdc) {
                    rodadasDados[appData.ra] = appData.rdc;
                    rodadaAtualNum = appData.ra;
                }
                
                // Popula select
                popularSelectRodadas();
                
                // Exibe primeira rodada
                if (rodadaAtualNum) {
                    selecionarRodada(rodadaAtualNum);
                }
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarErro('Erro ao processar: ' + error.message);
            }
        }
        
        function descomprimirGzip(base64Data) {
            // Decodifica Base64
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            // Descomprime Gzip
            const decompressed = pako.inflate(bytes, { to: 'string' });
            
            // Parse JSON
            return JSON.parse(decompressed);
        }
        
        function popularSelectRodadas() {
            const select = document.getElementById('rodadaSelect');
            select.innerHTML = '';
            
            rodadasInfo.forEach(rodada => {
                const option = document.createElement('option');
                option.value = rodada.n;
                
                let texto = `Rodada ${rodada.n}`;
                if (rodada.p > 0) texto += ` ‚Ä¢ ${rodada.p} pts`;
                if (rodada.s === 'fechada') texto += ' ‚Ä¢ üîí';
                if (rodada.jc > 0) texto += ` ‚Ä¢ üìä ${rodada.jc}/${rodada.j}`;
                
                option.textContent = texto;
                select.value = rodadaAtualNum || rodadasInfo[0]?.n;
                select.appendChild(option);
            });
        }
        
        function selecionarRodada(numeroRodada) {
            const rodadaData = rodadasDados[numeroRodada];
            
            if (!rodadaData) {
                // Se n√£o tem dados desta rodada, pede ao bot
                carregarRodadaDoBot(numeroRodada);
                return;
            }
            
            rodadaAtualNum = numeroRodada;
            document.getElementById('rodadaSelect').value = numeroRodada;
            exibirResumoRodada(rodadaData);
            exibirJogosRodada(rodadaData);
        }
        
        function exibirResumoRodada(rodada) {
            const resumo = document.getElementById('rodadaResumo');
            resumo.style.display = 'block';
            
            document.getElementById('rodadaTitulo').textContent = `Rodada ${rodada.num || rodada.n}`;
            document.getElementById('totalPontos').textContent = rodada.tp || rodada.total_pontos || 0;
            document.getElementById('totalJogos').textContent = rodada.tj || rodada.total_jogos || 0;
            document.getElementById('jogosComPlacar').textContent = rodada.jcp || rodada.jogos_com_placar || 0;
            document.getElementById('totalPE').textContent = rodada.est?.pe || rodada.estatisticas?.pe || 0;
            document.getElementById('totalRC').textContent = rodada.est?.rc || rodada.estatisticas?.rc || 0;
            document.getElementById('temPD').textContent = rodada.est?.pd_usada || rodada.estatisticas?.pd_usada ? 'Sim' : 'N√£o';
        }
        
        function exibirJogosRodada(rodada) {
            const container = document.getElementById('jogosLista');
            const jogos = rodada.jogos || [];
            
            container.innerHTML = '';
            document.getElementById('contadorJogos').textContent = `${jogos.length} jogo${jogos.length > 1 ? 's' : ''}`;
            
            jogos.forEach(jogo => {
                const div = document.createElement('div');
                div.className = `jogo-card ${jogo.pd ? 'pd' : ''}`;
                
                let html = `
                    ${jogo.pd ? '<div class="pd-badge">PD</div>' : ''}
                    <div style="font-weight: 600; margin-bottom: 10px;">
                        ${jogo.m || jogo.mandante} vs ${jogo.v || jogo.visitante}
                    </div>
                    <div class="placares-container">
                        <div>
                            <div style="font-size: 11px; color: #666;">PLACAR REAL</div>
                            <div style="font-size: 20px; font-weight: 700; color: #28a745;">
                                ${jogo.pr || jogo.placar_real || '?x?'}
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #666;">‚Üí</div>
                        <div>
                            <div style="font-size: 11px; color: #666;">SEU PALPITE</div>
                            <div style="font-size: 20px; font-weight: 700; color: #007aff;">
                                ${jogo.pal || jogo.palpite}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                        <div class="pontos">${jogo.pts || jogo.pontos || 0} pts</div>
                        <div style="display: flex; gap: 5px;">
                `;
                
                if (jogo.ac && jogo.ac.length > 0) {
                    jogo.ac.forEach(acerto => {
                        html += `<span class="badge ${acerto.toLowerCase()}">${acerto}</span>`;
                    });
                }
                
                html += `</div></div>`;
                div.innerHTML = html;
                container.appendChild(div);
            });
            
            document.getElementById('loading').style.display = 'none';
        }
        
        function mudarRodada() {
            const select = document.getElementById('rodadaSelect');
            const numeroRodada = parseInt(select.value);
            
            if (!isNaN(numeroRodada)) {
                selecionarRodada(numeroRodada);
            }
        }
        
        function carregarRodadaDoBot(numeroRodada) {
            // Implementa√ß√£o futura: pedir rodada espec√≠fica ao bot
            alert(`Rodada ${numeroRodada} ser√° implementada em breve!`);
        }
        
        function mostrarErro(mensagem) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = mensagem;
        }
    </script>
</body>
</html>
