<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpites do Usu√°rio - Bol√£o</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 25px;
        }

        .usuario-info {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .usuario-info h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-item label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .info-item span {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .select-rodada {
            margin-bottom: 25px;
        }

        .select-rodada h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .select-rodada select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: #333;
            transition: border-color 0.3s;
        }

        .select-rodada select:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .rodada-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .rodada-info h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .jogo-container {
            margin-bottom: 30px;
        }

        .jogo-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .jogo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .times {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .time {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
            color: #333;
        }

        .versus {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: bold;
            padding: 0 10px;
        }

        .placar-real {
            background: #28a745;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .palpite-usuario {
            margin-top: 15px;
        }

        .palpite-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .palpite-label {
            color: #666;
            font-size: 0.9rem;
        }

        .palpite-valor {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .pd-badge {
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .pontuacao-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .pontuacao-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .pontuacao-item:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .acerto-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .total-rodada {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 25px;
        }

        .total-rodada h4 {
            font-size: 1rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .total-rodada .valor {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .btn-voltar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            display: block;
            margin: 30px auto 0;
        }

        .btn-voltar:hover {
            background: #5a6268;
        }

        @media (max-width: 600px) {
            .container {
                border-radius: 15px;
            }
            
            .content {
                padding: 15px;
            }
            
            .jogo-card {
                padding: 15px;
            }
            
            .times {
                flex-direction: column;
                gap: 10px;
            }
            
            .versus {
                padding: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë§ Palpites do Usu√°rio</h1>
            <p>Visualize palpites e pontua√ß√£o</p>
        </div>

        <div class="content">
            <div class="usuario-info">
                <h3>Informa√ß√µes do Usu√°rio</h3>
                <div class="info-grid" id="usuarioInfo"></div>
            </div>

            <div class="select-rodada">
                <h3>Selecione uma Rodada</h3>
                <select id="selectRodada">
                    <option value="">Carregando rodadas...</option>
                </select>
            </div>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Carregando informa√ß√µes da rodada...</p>
            </div>

            <div id="rodadaContent" style="display: none;">
                <div class="rodada-info">
                    <h3>Informa√ß√µes da Rodada</h3>
                    <div class="info-grid" id="rodadaInfo"></div>
                </div>

                <div id="jogosContainer" class="jogo-container"></div>

                <div id="totalPontuacao" class="total-rodada" style="display: none;">
                    <h4>Pontua√ß√£o Total na Rodada</h4>
                    <div class="valor">0</div>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i>üì≠</i>
                    <h3>Nenhum palpite encontrado</h3>
                    <p>Este usu√°rio n√£o enviou palpites para esta rodada.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Elementos DOM
        const usuarioInfoEl = document.getElementById('usuarioInfo');
        const selectRodadaEl = document.getElementById('selectRodada');
        const loadingEl = document.getElementById('loading');
        const rodadaContentEl = document.getElementById('rodadaContent');
        const jogosContainerEl = document.getElementById('jogosContainer');
        const totalPontuacaoEl = document.getElementById('totalPontuacao');
        const emptyStateEl = document.getElementById('emptyState');

        // Estado da aplica√ß√£o
        let dadosUsuario = null;
        let rodadasDisponiveis = [];
        let rodadaSelecionada = null;
        let palpitesRodada = null;

        // Inicializa√ß√£o
        async function init() {
            try {
                // Obter dados da URL
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    showError('Dados n√£o encontrados na URL');
                    return;
                }

                // Decodificar dados
                const dadosJson = atob(dataParam);
                const dados = JSON.parse(dadosJson);
                
                if (dados.tipo !== 'palpites_usuario') {
                    showError('Tipo de dados inv√°lido');
                    return;
                }

                dadosUsuario = dados.usuario;
                rodadasDisponiveis = dados.rodadas_disponiveis || [];

                // Preencher informa√ß√µes do usu√°rio
                renderUsuarioInfo();
                
                // Preencher dropdown de rodadas
                renderRodadasDropdown();

                // Esconder loading
                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showError('Erro ao carregar dados');
            }
        }

        // Renderizar informa√ß√µes do usu√°rio
        function renderUsuarioInfo() {
            if (!dadosUsuario) return;
            
            usuarioInfoEl.innerHTML = `
                <div class="info-item">
                    <label>Nome:</label>
                    <span>${escapeHtml(dadosUsuario.nome)}</span>
                </div>
                <div class="info-item">
                    <label>ID:</label>
                    <span>${dadosUsuario.id}</span>
                </div>
                <div class="info-item">
                    <label>Telegram ID:</label>
                    <span>${dadosUsuario.telegram_id}</span>
                </div>
            `;
        }

        // Renderizar dropdown de rodadas
        function renderRodadasDropdown() {
            if (rodadasDisponiveis.length === 0) {
                selectRodadaEl.innerHTML = '<option value="">Nenhuma rodada dispon√≠vel</option>';
                return;
            }

            selectRodadaEl.innerHTML = '<option value="">Selecione uma rodada...</option>';
            
            rodadasDisponiveis.forEach(rodadaNum => {
                const option = document.createElement('option');
                option.value = rodadaNum;
                option.textContent = `Rodada ${rodadaNum}`;
                selectRodadaEl.appendChild(option);
            });

            // Adicionar listener para mudan√ßa
            selectRodadaEl.addEventListener('change', onRodadaSelecionada);
        }

        // Quando uma rodada √© selecionada
        async function onRodadaSelecionada(event) {
            const rodadaNum = parseInt(event.target.value);
            
            if (!rodadaNum) {
                rodadaContentEl.style.display = 'none';
                return;
            }

            rodadaSelecionada = rodadaNum;
            
            // Mostrar loading
            loadingEl.style.display = 'block';
            rodadaContentEl.style.display = 'none';
            emptyStateEl.style.display = 'none';

            try {
                // Buscar informa√ß√µes da rodada
                await carregarPalpitesRodada(rodadaNum);
            } catch (error) {
                console.error('Erro ao carregar rodada:', error);
                showError('Erro ao carregar palpites da rodada');
            }
        }

        // Carregar palpites da rodada
        async function carregarPalpitesRodada(rodadaNum) {
            try {
                // Fazer requisi√ß√£o para o bot
                const response = await fetch(`https://api.telegram.org/bot${getBotToken()}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: dadosUsuario.telegram_id,
                        text: `/get_palpites_usuario ${rodadaNum} ${dadosUsuario.id}`
                    })
                });

                // Em produ√ß√£o, isso seria uma API real
                // Por enquanto, vamos simular dados
                await simularDadosRodada(rodadaNum);

            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                // Carregar dados simulados
                await simularDadosRodada(rodadaNum);
            }
        }

        // Simular dados da rodada (para desenvolvimento)
        async function simularDadosRodada(rodadaNum) {
            // Simular delay de rede
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Dados simulados
            const dadosRodada = {
                numero: rodadaNum,
                data_abertura: '10/01/2026',
                horario_fechamento: '20:00',
                trunfos: ['Jo√£o Silva', 'Maria Santos'],
                usuario_tem_trunfo: false,
                pd_usada: true,
                pd_jogo: 'Cruzeiro x Botafogo',
                jogos: [
                    {
                        id: 1,
                        mandante: 'Cruzeiro',
                        visitante: 'Botafogo',
                        placar_real: { mandante: 3, visitante: 0 },
                        palpite_usuario: { mandante: 2, visitante: 1 },
                        pd: false,
                        pontuacao: {
                            total: 4,
                            acertos: ['RC'],
                            detalhes: [
                                { tipo: 'PE', pontos: 0, descricao: 'Placar Exato' },
                                { tipo: 'RC', pontos: 4, descricao: 'Resultado Correto' },
                                { tipo: 'GM', pontos: 0, descricao: 'Gols Mandante' },
                                { tipo: 'GV', pontos: 0, descricao: 'Gols Visitante' }
                            ]
                        }
                    },
                    {
                        id: 2,
                        mandante: 'Flamengo',
                        visitante: 'S√£o Paulo',
                        placar_real: { mandante: 1, visitante: 1 },
                        palpite_usuario: { mandante: 2, visitante: 2 },
                        pd: false,
                        pontuacao: {
                            total: 2,
                            acertos: ['GM'],
                            detalhes: [
                                { tipo: 'PE', pontos: 0, descricao: 'Placar Exato' },
                                { tipo: 'RC', pontos: 0, descricao: 'Resultado Correto' },
                                { tipo: 'GM', pontos: 2, descricao: 'Gols Mandante' },
                                { tipo: 'GV', pontos: 0, descricao: 'Gols Visitante' }
                            ]
                        }
                    }
                ],
                total_pontos: 6,
                estatisticas: {
                    pe: 0,
                    rc: 1,
                    gm: 1,
                    gv: 0
                }
            };

            palpitesRodada = dadosRodada;
            renderRodadaInfo();
        }

        // Renderizar informa√ß√µes da rodada
        function renderRodadaInfo() {
            if (!palpitesRodada) return;

            // Informa√ß√µes da rodada
            rodadaInfoEl.innerHTML = `
                <div class="info-item">
                    <label>N√∫mero:</label>
                    <span>${palpitesRodada.numero}¬™ Rodada</span>
                </div>
                <div class="info-item">
                    <label>Data de abertura:</label>
                    <span>${palpitesRodada.data_abertura}</span>
                </div>
                <div class="info-item">
                    <label>Hor√°rio limite:</label>
                    <span>${palpitesRodada.horario_fechamento}</span>
                </div>
                <div class="info-item">
                    <label>PD utilizada:</label>
                    <span>${palpitesRodada.pd_usada ? '‚úÖ Sim - ' + palpitesRodada.pd_jogo : '‚ùå N√£o'}</span>
                </div>
                <div class="info-item">
                    <label>Trunfo:</label>
                    <span>${palpitesRodada.usuario_tem_trunfo ? '‚úÖ Sim' : '‚ùå N√£o'}</span>
                </div>
            `;

            // Renderizar jogos
            renderJogos();

            // Renderizar total
            if (palpitesRodada.jogos.length > 0) {
                totalPontuacaoEl.style.display = 'block';
                totalPontuacaoEl.querySelector('.valor').textContent = palpitesRodada.total_pontos;
                
                emptyStateEl.style.display = 'none';
            } else {
                emptyStateEl.style.display = 'block';
                totalPontuacaoEl.style.display = 'none';
            }

            // Esconder loading e mostrar conte√∫do
            loadingEl.style.display = 'none';
            rodadaContentEl.style.display = 'block';
        }

        // Renderizar jogos
        function renderJogos() {
            if (!palpitesRodada || !palpitesRodada.jogos) return;

            jogosContainerEl.innerHTML = '';

            palpitesRodada.jogos.forEach(jogo => {
                const jogoCard = document.createElement('div');
                jogoCard.className = 'jogo-card';
                
                jogoCard.innerHTML = `
                    <div class="jogo-header">
                        <div class="times">
                            <div class="time">${escapeHtml(jogo.mandante)}</div>
                            <div class="versus">X</div>
                            <div class="time">${escapeHtml(jogo.visitante)}</div>
                        </div>
                        <div class="placar-real">
                            ${jogo.placar_real.mandante} - ${jogo.placar_real.visitante}
                        </div>
                    </div>

                    <div class="palpite-usuario">
                        <div class="palpite-info">
                            <span class="palpite-label">Seu palpite:</span>
                            <span class="palpite-valor">
                                ${jogo.palpite_usuario.mandante} x ${jogo.palpite_usuario.visitante}
                            </span>
                            ${jogo.pd ? '<span class="pd-badge">PD</span>' : ''}
                        </div>

                        <div class="pontuacao-container">
                            ${jogo.pontuacao.detalhes.map(detalhe => `
                                <div class="pontuacao-item">
                                    <span>${detalhe.descricao}:</span>
                                    <span>
                                        ${detalhe.pontos} pts
                                        ${jogo.pontuacao.acertos.includes(detalhe.tipo) ? '<span class="acerto-badge">‚úì</span>' : ''}
                                    </span>
                                </div>
                            `).join('')}
                            <div class="pontuacao-item">
                                <span>Pontua√ß√£o total no jogo:</span>
                                <span>${jogo.pontuacao.total} pts</span>
                            </div>
                        </div>
                    </div>
                `;

                jogosContainerEl.appendChild(jogoCard);
            });
        }

        // Fun√ß√µes auxiliares
        function getBotToken() {
            // Em produ√ß√£o, isso viria do servidor
            return 'SEU_BOT_TOKEN_AQUI';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            loadingEl.innerHTML = `
                <div style="color: #dc3545; text-align: center;">
                    <p style="font-size: 2rem;">‚ö†Ô∏è</p>
                    <h3>Erro</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // Inicializar app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
