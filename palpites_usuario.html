<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpites e Pontua√ß√£o</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Pako.js para descompress√£o Gzip -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f7; color: #333; line-height: 1.6; padding: 20px; 
        }
        .container { 
            max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; 
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        header { 
            background: linear-gradient(135deg, #007aff 0%, #0056cc 100%); 
            color: white; padding: 25px; text-align: center; 
        }
        h1 { font-size: 24px; margin-bottom: 8px; font-weight: 700; }
        .subtitle { font-size: 14px; opacity: 0.9; }
        .user-info { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .user-name { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .user-id { font-size: 13px; color: #666; }
        .select-container { padding: 20px; }
        .custom-select { position: relative; width: 100%; }
        select { 
            width: 100%; padding: 15px 20px; font-size: 16px; border: 2px solid #e0e0e0; 
            border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s;
            appearance: none; -webkit-appearance: none;
        }
        select:focus { border-color: #007aff; outline: none; }
        .rodada-resumo { 
            padding: 25px; background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); 
            color: white; text-align: center; 
        }
        .rodada-titulo { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; 
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 10px; 
            backdrop-filter: blur(10px);
        }
        .stat-value { display: block; font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .jogos-container { padding: 20px; }
        .jogos-titulo { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0;
        }
        .jogos-titulo span:first-child { font-size: 18px; font-weight: 600; }
        #contadorJogos { font-size: 14px; color: #666; }
        .jogos-lista { margin-top: 15px; }
        .jogo-card { 
            background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; 
            margin-bottom: 15px; position: relative; transition: transform 0.2s, box-shadow 0.2s;
        }
        .jogo-card:hover { 
            transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .jogo-card.pd { border-left: 4px solid #dc3545; }
        .pd-badge { 
            position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; 
            padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; 
            text-transform: uppercase;
        }
        .placares-container { 
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; 
            margin-bottom: 15px; 
        }
        .placar-box { text-align: center; }
        .placar-label { font-size: 11px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .placar-valor { font-size: 20px; font-weight: 700; }
        .placar-real { color: #28a745; }
        .placar-palpite { color: #007aff; }
        .pontos-container { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;
        }
        .pontos { font-size: 20px; font-weight: 700; color: #28a745; }
        .acertos-container { display: flex; gap: 5px; flex-wrap: wrap; }
        .badge { 
            padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; 
            text-transform: uppercase; 
        }
        .badge.pe { background: #28a745; color: white; }
        .badge.rc { background: #007aff; color: white; }
        .badge.gm, .badge.gv { background: #6c757d; color: white; }
        .badge.pd { background: #dc3545; color: white; }
        .loading { 
            text-align: center; padding: 60px 20px; color: #666; 
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error { 
            text-align: center; padding: 40px 20px; color: #dc3545; background: #f8d7da;
            border-radius: 10px; border: 1px solid #f5c6cb;
        }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .placares-container { grid-template-columns: 1fr; gap: 15px; }
            .placares-container > div:nth-child(2) { display: none; }
            .jogo-card { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Palpites e Pontua√ß√£o</h1>
            <div class="subtitle" id="subtitle">Carregando dados do usu√°rio...</div>
        </header>
        
        <div class="user-info" id="userInfo">
            <div class="user-name" id="userName">Carregando...</div>
            <div class="user-id" id="userId">ID: --</div>
        </div>
        
        <div class="select-container">
            <div class="custom-select">
                <select id="rodadaSelect" onchange="mudarRodada()">
                    <option value="">Carregando rodadas...</option>
                </select>
            </div>
        </div>
        
        <div class="rodada-resumo" id="rodadaResumo" style="display: none;">
            <div class="rodada-titulo" id="rodadaTitulo">Rodada --</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="totalPontos">0</span>
                    <span class="stat-label">Pontos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="jogosPalpitados">0</span>
                    <span class="stat-label">Palpitados</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="totalJogos">0</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="jogosComPlacar">0</span>
                    <span class="stat-label">Com placar</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="totalPE">0</span>
                    <span class="stat-label">PE</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="temPD">N√£o</span>
                    <span class="stat-label">PD</span>
                </div>
            </div>
        </div>
        
        <div class="jogos-container">
            <div class="jogos-titulo">
                <span>Jogos da rodada</span>
                <span id="contadorJogos">0 jogos palpitados</span>
            </div>
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <div>Carregando jogos...</div>
            </div>
            <div id="jogosLista" class="jogos-lista"></div>
            <div id="error" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let appData = {};
        let rodadasDisponiveis = [];
        let rodadasDados = {};
        let rodadaAtualNum = null;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                Telegram.WebApp.setBackgroundColor('#f5f5f7');
                Telegram.WebApp.setHeaderColor('#007aff');
            }
            
            carregarDadosDaURL();
        });
        
        function carregarDadosDaURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    mostrarErro('‚ùå Dados n√£o encontrados na URL');
                    return;
                }
                
                console.log('Dados recebidos (in√≠cio):', dataParam.substring(0, 100) + '...');
                
                // Tenta descomprimir com Gzip
                let dados;
                try {
                    console.log('Tentando descompress√£o Gzip...');
                    dados = descomprimirGzip(dataParam);
                    console.log('‚úÖ Descompress√£o Gzip bem-sucedida');
                } catch (gzipError) {
                    console.warn('‚ö†Ô∏è Falha na descompress√£o Gzip:', gzipError.message);
                    console.log('Tentando Base64 normal...');
                    try {
                        const jsonString = atob(dataParam);
                        console.log('JSON string:', jsonString.substring(0, 200) + '...');
                        dados = JSON.parse(jsonString);
                        console.log('‚úÖ Parse Base64 normal bem-sucedido');
                    } catch (base64Error) {
                        throw new Error('Falha em ambos os m√©todos: ' + base64Error.message);
                    }
                }
                
                console.log('Dados processados:', dados);
                
                // Valida dados
                if (!dados || !dados.t) {
                    throw new Error('Formato de dados inv√°lido');
                }
                
                if (dados.t !== 'palpites_usuario_gzip') {
                    console.warn('Tipo de dados:', dados.t, '- esperado: palpites_usuario_gzip');
                }
                
                appData = dados;
                
                // Preenche informa√ß√µes do usu√°rio
                document.getElementById('userName').textContent = appData.u?.n || 'Usu√°rio desconhecido';
                document.getElementById('userId').textContent = `ID: ${appData.u?.id || '--'} | Telegram: ${appData.u?.tid || '--'}`;
                document.getElementById('subtitle').textContent = `Usu√°rio: ${appData.u?.n || '--'}`;
                
                // Armazena dados das rodadas
                rodadasDisponiveis = appData.rd || [];
                rodadasDados = {};
                
                // Primeira rodada j√° vem completa
                if (appData.ra && appData.rdc) {
                    rodadasDados[appData.ra] = appData.rdc;
                    rodadaAtualNum = appData.ra;
                    console.log(`‚úÖ Rodada atual: ${rodadaAtualNum}`);
                }
                
                // Popula o select com as rodadas
                popularSelectRodadas();
                
                // Exibe a primeira rodada
                if (rodadaAtualNum) {
                    selecionarRodada(rodadaAtualNum);
                } else if (rodadasDisponiveis.length > 0) {
                    selecionarRodada(rodadasDisponiveis[0].n);
                }
                
                // Esconde loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                mostrarErro(`Erro ao processar dados: ${error.message}`);
            }
        }
        
        function descomprimirGzip(base64Data) {
            try {
                // Decodifica Base64
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                console.log('Bytes Gzip:', bytes.length, 'bytes');
                
                // Descomprime Gzip usando Pako
                const decompressed = pako.inflate(bytes, { to: 'string' });
                
                console.log('Descomprimido:', decompressed.length, 'caracteres');
                
                // Parse JSON
                return JSON.parse(decompressed);
                
            } catch (error) {
                throw new Error('Erro na descompress√£o Gzip: ' + error.message);
            }
        }
        
        function popularSelectRodadas() {
            const select = document.getElementById('rodadaSelect');
            select.innerHTML = '';
            
            if (rodadasDisponiveis.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma rodada dispon√≠vel';
                select.appendChild(option);
                return;
            }
            
            rodadasDisponiveis.forEach(rodada => {
                const option = document.createElement('option');
                option.value = rodada.n;
                
                let texto = `Rodada ${rodada.n}`;
                
                // Adiciona informa√ß√µes
                if (rodada.p !== undefined) texto += ` ‚Ä¢ ${rodada.p} pts`;
                if (rodada.s === 'fechada') texto += ' ‚Ä¢ üîí';
                if (rodada.jc !== undefined) {
                    const total = rodada.jt || rodada.j || 0;
                    texto += ` ‚Ä¢ üìä ${rodada.jc}/${total}`;
                }
                
                option.textContent = texto;
                select.appendChild(option);
            });
            
            // Seleciona a rodada atual
            if (rodadaAtualNum) {
                select.value = rodadaAtualNum;
            }
        }
        
        function selecionarRodada(numeroRodada) {
            console.log(`Selecionando rodada ${numeroRodada}...`);
            
            const rodadaData = rodadasDados[numeroRodada];
            
            if (!rodadaData) {
                // Se n√£o temos dados desta rodada, tentamos carregar
                console.log(`Rodada ${numeroRodada} n√£o encontrada em cache`);
                carregarRodadaDoBot(numeroRodada);
                return;
            }
            
            rodadaAtualNum = numeroRodada;
            document.getElementById('rodadaSelect').value = numeroRodada;
            exibirResumoRodada(rodadaData);
            exibirJogosRodada(rodadaData);
        }
        
        function exibirResumoRodada(rodada) {
            const resumo = document.getElementById('rodadaResumo');
            resumo.style.display = 'block';
            
            // Atualiza t√≠tulo
            const rodadaNum = rodada.num || rodadaAtualNum;
            document.getElementById('rodadaTitulo').textContent = `Rodada ${rodadaNum}`;
            
            // Atualiza estat√≠sticas
            document.getElementById('totalPontos').textContent = rodada.tp || 0;
            document.getElementById('jogosPalpitados').textContent = rodada.jp || rodada.j || 0;
            document.getElementById('totalJogos').textContent = rodada.jt || rodada.total_jogos || 0;
            document.getElementById('jogosComPlacar').textContent = rodada.jcp || 0;
            document.getElementById('totalPE').textContent = rodada.est?.pe || 0;
            document.getElementById('temPD').textContent = (rodada.est?.pd_usada || rodada.pd_usada) ? 'Sim' : 'N√£o';
        }
        
        function exibirJogosRodada(rodada) {
            const container = document.getElementById('jogosLista');
            const jogos = rodada.jogos || [];
            
            console.log(`Exibindo ${jogos.length} jogos da rodada ${rodada.num || rodadaAtualNum}`);
            
            // Limpa container
            container.innerHTML = '';
            
            // Atualiza contador
            const totalJogos = rodada.jt || rodada.total_jogos || 0;
            const jogosPalpitados = rodada.jp || jogos.length;
            document.getElementById('contadorJogos').textContent = 
                `${jogosPalpitados}/${totalJogos} jogos palpitados`;
            
            if (jogos.length === 0) {
                container.innerHTML = `
                    <div class="jogo-card" style="text-align: center; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">Nenhum palpite nesta rodada</div>
                        <div style="font-size: 14px;">Voc√™ n√£o fez palpites nos jogos desta rodada</div>
                    </div>
                `;
                return;
            }
            
            // Ordena jogos por data/hora se dispon√≠vel
            jogos.sort((a, b) => {
                if (a.dh && b.dh) {
                    return new Date(a.dh) - new Date(b.dh);
                }
                return 0;
            });
            
            // Cria cards para cada jogo
            jogos.forEach((jogo, index) => {
                const div = document.createElement('div');
                div.className = `jogo-card ${jogo.pd ? 'pd' : ''}`;
                
                // Formata data/hora se dispon√≠vel
                let dataFormatada = '';
                if (jogo.dh) {
                    try {
                        const data = new Date(jogo.dh);
                        if (!isNaN(data)) {
                            dataFormatada = data.toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        console.warn('Erro ao formatar data:', e);
                    }
                }
                
                let html = '';
                
                // Badge de PD
                if (jogo.pd) {
                    html += '<div class="pd-badge">Pontua√ß√£o Dobrada</div>';
                }
                
                // T√≠tulo do jogo e data
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">
                            ${jogo.m || jogo.mandante || 'Time A'} vs ${jogo.v || jogo.visitante || 'Time B'}
                        </div>
                        ${dataFormatada ? `
                            <div style="font-size: 12px; color: #666;">
                                <span>üìÖ</span> ${dataFormatada}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Placar real vs palpite
                html += `
                    <div class="placares-container">
                        <div class="placar-box">
                            <div class="placar-label">Placar Real</div>
                            <div class="placar-valor placar-real">
                                ${jogo.pr || jogo.placar_real || '?x?'}
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #ccc; font-weight: 300;">‚Üí</div>
                        <div class="placar-box">
                            <div class="placar-label">Seu Palpite</div>
                            <div class="placar-valor placar-palpite">
                                ${jogo.pal || jogo.palpite || '0x0'}
                            </div>
                        </div>
                    </div>
                `;
                
                // Pontua√ß√£o e acertos
                html += `
                    <div class="pontos-container">
                        <div class="pontos">${jogo.pts || jogo.pontos || 0} pontos</div>
                        <div class="acertos-container">
                `;
                
                // Badges de acertos
                if (jogo.ac && jogo.ac.length > 0) {
                    jogo.ac.forEach(acerto => {
                        html += `<span class="badge ${acerto.toLowerCase()}">${acerto}</span>`;
                    });
                } else {
                    html += `<span style="font-size: 12px; color: #666;">Sem acertos</span>`;
                }
                
                html += `</div></div>`;
                
                div.innerHTML = html;
                container.appendChild(div);
            });
            
            // Esconde loading
            document.getElementById('loading').style.display = 'none';
        }
        
        function mudarRodada() {
            const select = document.getElementById('rodadaSelect');
            const numeroRodada = parseInt(select.value);
            
            if (!isNaN(numeroRodada)) {
                console.log(`Mudando para rodada ${numeroRodada}`);
                selecionarRodada(numeroRodada);
            }
        }
        
        function carregarRodadaDoBot(numeroRodada) {
            console.log(`Solicitando rodada ${numeroRodada} do bot...`);
            
            // Mostra loading
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('jogosLista').innerHTML = '';
            
            // Em uma vers√£o futura, far√≠amos uma requisi√ß√£o ao bot
            // Por enquanto, apenas mostra mensagem
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('jogosLista').innerHTML = `
                    <div class="jogo-card" style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Rodada ${numeroRodada}</div>
                        <div style="color: #666; margin-bottom: 15px;">
                            Os dados desta rodada ser√£o carregados em uma atualiza√ß√£o futura.
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            No momento, apenas a primeira rodada est√° dispon√≠vel.
                        </div>
                    </div>
                `;
            }, 1000);
        }
        
        function mostrarErro(mensagem) {
            console.error('Mostrando erro:', mensagem);
            
            document.getElementById('loading').style.display = 'none';
            
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                <div style="font-weight: 600; margin-bottom: 10px;">Erro ao carregar</div>
                <div style="margin-bottom: 15px;">${mensagem}</div>
                <div style="font-size: 14px; color: #666;">
                    Tente novamente ou entre em contato com o administrador.
                </div>
            `;
        }
        
        // Fun√ß√£o de debug para testar dados manualmente
        window.debugDados = function() {
            console.log('=== DEBUG ===');
            console.log('appData:', appData);
            console.log('rodadasDisponiveis:', rodadasDisponiveis);
            console.log('rodadasDados:', rodadasDados);
            console.log('rodadaAtualNum:', rodadaAtualNum);
            console.log('=============');
        };
    </script>
</body>
</html>
