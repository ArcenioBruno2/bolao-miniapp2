<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palpites e Pontua√ß√£o</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Cabe√ßalho */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        
        .header .subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        /* Informa√ß√µes do usu√°rio */
        .user-info {
            background: #f8fafc;
            padding: 12px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .user-main {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: bold;
        }
        
        .user-details h2 {
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }
        
        .user-details p {
            font-size: 11px;
            color: #718096;
        }
        
        /* Navega√ß√£o de rodadas - MODIFICADO: SEM NAVEGA√á√ÉO INTERNA */
        .nav-section {
            padding: 15px 20px;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* Sele√ß√£o de rodada - APENAS INFORMATIVO */
        .rodada-info {
            width: 100%;
            text-align: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
        }
        
        /* Bot√£o para voltar e escolher outra rodada */
        .back-button {
            width: 100%;
            padding: 12px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        /* Estat√≠sticas da rodada */
        .stats-section {
            padding: 15px 20px;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px 12px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.95;
            font-weight: 500;
        }
        
        /* Lista de jogos */
        .games-section {
            padding: 20px;
        }
        
        .games-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .games-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .games-counter {
            font-size: 13px;
            color: #718096;
            font-weight: 500;
        }
        
        .games-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Card de jogo - NORMAL */
        .game-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            transition: all 0.3s ease;
        }
        
        /* Card de jogo - COM PD (borda vermelha) */
        .game-card.pd-card {
            border: 2px solid #e74c3c;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.15);
        }
        
        .pd-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Layout 2 linhas */
        .game-grid {
            display: grid;
            grid-template-columns: 40% 30% 30%;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .team-name {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            padding: 6px 0;
        }
        
        .score-box {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            border-radius: 6px;
            margin: 0 auto;
        }
        
        .real-score {
            border: 2px solid #3498db;
            color: #3498db;
        }
        
        .guess-score {
            border: 2px solid #f1c40f;
            color: #d35400;
        }
        
        /* NOVO: Estilo para "c/vim" */
        .guess-score.cvim {
            color: #718096;
            font-style: italic;
            font-weight: normal;
            font-size: 14px;
            border: 2px dashed #cbd5e0;
            background-color: #f7fafc;
        }
        
        /* Legenda dos placares */
        .score-legend {
            display: grid;
            grid-template-columns: 40% 30% 30%;
            text-align: center;
            margin-bottom: 15px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
            font-size: 11px;
            color: #718096;
            font-weight: 500;
        }
        
        /* Pontua√ß√£o detalhada */
        .points-calculation {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            font-size: 12px;
        }
        
        .points-line {
            font-size: 13px;
            color: #2d3748;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .points-total {
            font-size: 14px;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
        }
        
        .points-pd {
            font-size: 13px;
            font-weight: 700;
            color: #e74c3c;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 6px;
            border-left: 3px solid #e74c3c;
        }
        
        /* NOVO: Estilo para jogos sem palpite */
        .sem-palpite-info {
            background: #f8fafc;
            border: 1px dashed #cbd5e0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            color: #718096;
        }
        
        .sem-palpite-info strong {
            color: #4a5568;
        }
        
        /* Loading e Erros */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 40px 20px;
            color: #e74c3c;
            background: #fff5f5;
            border-radius: 10px;
            border: 2px solid #fed7d7;
        }
        
        /* Mensagem de √∫nica rodada */
        .single-rodada-info {
            background: #e8f4fc;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 20px;
            text-align: center;
        }
        
        .single-rodada-info h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .single-rodada-info p {
            color: #4a5568;
            font-size: 13px;
            margin-bottom: 0;
        }
        
        /* BOT√ÉO COMPARTILHAR */
        .share-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .share-button:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .share-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .share-button:active {
            transform: translateY(0);
        }
        
        /* Mensagem de status do compartilhamento */
        .share-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }
        
        .share-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .share-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .share-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .game-grid {
                grid-template-columns: 45% 27.5% 27.5%;
            }
            
            .score-legend {
                grid-template-columns: 45% 27.5% 27.5%;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .stat-value {
                font-size: 22px;
            }
            
            .team-name {
                font-size: 13px;
            }
            
            .score-box {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .back-button {
                padding: 10px;
                font-size: 14px;
            }
            
            .share-button {
                padding: 12px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 12px;
            }
            
            .header, .user-info, .nav-section, .stats-section, .games-section {
                padding: 12px;
            }
            
            .stat-card {
                padding: 10px 8px;
            }
            
            .game-card {
                padding: 12px;
            }
            
            .game-grid {
                grid-template-columns: 50% 25% 25%;
            }
            
            .score-legend {
                grid-template-columns: 50% 25% 25%;
            }
            
            .team-name {
                font-size: 12px;
            }
            
            .points-line {
                font-size: 12px;
            }
            
            .back-button {
                padding: 8px;
                font-size: 13px;
            }
            
            .share-button {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        /* Utilit√°rios */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho -->
        <div class="header">
            <h1>üìä Palpites e Pontua√ß√£o</h1>
            <div class="subtitle" id="subtitle">Carregando dados do usu√°rio...</div>
        </div>
        
        <!-- Informa√ß√µes do usu√°rio -->
        <div class="user-info">
            <div class="user-main">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h2 id="userName">Carregando...</h2>
                    <p id="userId">ID: -- | Telegram: --</p>
                </div>
            </div>
        </div>
        
        <!-- Navega√ß√£o de rodadas (NOVA VERS√ÉO) -->
        <div class="nav-section">
            <!-- Informa√ß√£o da rodada atual -->
            <div class="rodada-info" id="rodadaInfo">
                Carregando rodada...
            </div>
            
            <!-- Bot√£o para escolher outra rodada -->
            <button class="back-button" id="btnEscolherOutraRodada" onclick="escolherOutraRodada()">
                ‚Ü©Ô∏è Escolher Outra Rodada
            </button>
        </div>
        
        <!-- Mensagem de rodada √∫nica -->
        <div class="single-rodada-info" id="singleRodadaInfo" style="display: none;">
            <h3>üìã Rodada Espec√≠fica</h3>
            <p>Esta visualiza√ß√£o cont√©m apenas os dados da rodada selecionada.</p>
            <p style="font-size: 11px; margin-top: 5px; color: #718096;">
                Para ver outra rodada, clique em "Escolher Outra Rodada" acima.
            </p>
        </div>
        
        <!-- Estat√≠sticas da rodada -->
        <div class="stats-section" id="rodadaResumo" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="statTotalRodada">0</span>
                    <span class="stat-label">Total da Rodada</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statUsadosAdm">0</span>
                    <span class="stat-label">Usados pelo ADM</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statMeusPalpites">0</span>
                    <span class="stat-label">Meus Palpites</span>
                </div>
                <!-- ALTERADO: "Com Placar" para "Resultado Correto" -->
                <div class="stat-card">
                    <span class="stat-value" id="statResultadoCorreto">0</span>
                    <span class="stat-label">Resultado Correto</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statPontos">0</span>
                    <span class="stat-label">Pontos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statPE">0</span>
                    <span class="stat-label">Placar Exato</span>
                </div>
            </div>
        </div>
        
        <!-- Lista de jogos -->
        <div class="games-section">
            <div class="games-header">
                <h2 id="gamesTitle">Jogos da Rodada</h2>
                <div class="games-counter" id="contadorJogos">
                    <span id="contadorPalpites">0</span>/<span id="contadorUsados">0</span>/<span id="contadorTotal">0</span>
                    <small style="color: #718096; font-size: 11px; margin-left: 5px;">(meus/usados/total)</small>
                </div>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <div>Carregando jogos e estat√≠sticas...</div>
            </div>
            
            <!-- Lista de jogos -->
            <div id="jogosLista" class="games-list"></div>
            
            <!-- Mensagem de erro -->
            <div id="error" class="error" style="display: none;"></div>
        </div>
        
        <!-- BOT√ÉO PARA COMPARTILHAR NO GRUPO -->
        <div style="padding: 0 20px 20px;">
            <button class="share-button" id="btnCompartilhar" onclick="compartilharNoGrupo()">
                üì§ Compartilhar no Grupo
            </button>
            
            <div class="share-status" id="shareStatus"></div>
        </div>
    </div>

    <script>
        // ==============================================
        // VARI√ÅVEIS GLOBAIS
        // ==============================================
        let appData = {};
        let rodadaAtualNum = null;
        let usuarioId = null;
        let chatId = null;
        let apenasUmaRodada = true;
        
        // ==============================================
        // INICIALIZA√á√ÉO
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Web App iniciado (VERS√ÉO RODADA √öNICA)');
            
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                Telegram.WebApp.setBackgroundColor('#667eea');
                Telegram.WebApp.setHeaderColor('#2c3e50');
                
                const tgUser = Telegram.WebApp.initDataUnsafe?.user;
                if (tgUser) {
                    chatId = tgUser.id;
                    console.log('‚úÖ Chat ID capturado:', chatId);
                }
                
                console.log('‚úÖ Telegram WebApp configurado');
            }
            
            carregarDadosDaURL();
        });
        
        // ==============================================
        // FUN√á√ÉO PRINCIPAL DE CARREGAMENTO
        // ==============================================
        function carregarDadosDaURL() {
            console.log('üîç INICIANDO CARREGAMENTO DE DADOS (Rodada √önica)...');
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    throw new Error('Par√¢metro "data" n√£o encontrado na URL');
                }
                
                console.log('üì¶ Dados recebidos (comprimento):', dataParam.length);
                
                let dados = null;
                let metodoUsado = '';
                
                try {
                    const safeBase64 = dataParam
                        .replace(/\-/g, '+')
                        .replace(/\_/g, '/')
                        .padEnd(dataParam.length + (4 - dataParam.length % 4) % 4, '=');
                    
                    const jsonString = atob(safeBase64);
                    dados = JSON.parse(jsonString);
                    metodoUsado = 'URL-safe Base64';
                    console.log('‚úÖ Sucesso com URL-safe Base64');
                } catch (erro1) {
                    console.log('‚ùå Falha com URL-safe Base64:', erro1.message);
                    
                    if (typeof pako !== 'undefined') {
                        try {
                            const safeBase64 = dataParam
                                .replace(/\-/g, '+')
                                .replace(/\_/g, '/')
                                .padEnd(dataParam.length + (4 - dataParam.length % 4) % 4, '=');
                            
                            const binaryString = atob(safeBase64);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            const decompressed = pako.inflate(bytes, { to: 'string' });
                            dados = JSON.parse(decompressed);
                            metodoUsado = 'Gzip decompress';
                            console.log('‚úÖ Sucesso com Gzip decompress');
                        } catch (erro2) {
                            console.log('‚ùå Falha com Gzip:', erro2.message);
                            
                            try {
                                const jsonString = atob(dataParam);
                                dados = JSON.parse(jsonString);
                                metodoUsado = 'Base64 normal';
                                console.log('‚úÖ Sucesso com Base64 normal');
                            } catch (erro3) {
                                console.log('‚ùå Falha com Base64 normal:', erro3.message);
                            }
                        }
                    }
                }
                
                if (!dados) {
                    throw new Error('N√£o foi poss√≠vel decodificar os dados.');
                }
                
                console.log(`üéØ Dados carregados via: ${metodoUsado}`);
                console.log('üìä Estrutura dos dados:', dados);
                
                if (typeof dados !== 'object') {
                    throw new Error('Dados n√£o s√£o um objeto JSON v√°lido');
                }
                
                let formato = '';
                
                if (dados.tipo || dados.usuario) {
                    formato = 'novo';
                    console.log('üìù Formato detectado: NOVO (nomes completos)');
                } else if (dados.t || dados.u) {
                    formato = 'antigo';
                    console.log('üìù Formato detectado: ANTIGO (abreviado)');
                } else {
                    throw new Error('Formato de dados n√£o reconhecido');
                }
                
                appData = dados;
                
                const usuario = formato === 'novo' ? dados.usuario : dados.u;
                if (!usuario) {
                    throw new Error('Dados n√£o cont√™m informa√ß√µes do usu√°rio');
                }
                
                usuarioId = usuario.id;
                
                const nomeUsuario = usuario.nome || usuario.n || 'Usu√°rio';
                const telegramId = usuario.telegram_id || usuario.tid || '--';
                
                document.getElementById('userName').textContent = nomeUsuario;
                document.getElementById('userId').textContent = `ID: ${usuarioId} | Telegram: ${telegramId}`;
                document.getElementById('subtitle').textContent = `Usu√°rio: ${nomeUsuario}`;
                
                if (nomeUsuario && nomeUsuario !== 'Usu√°rio') {
                    document.getElementById('userAvatar').textContent = nomeUsuario.charAt(0).toUpperCase();
                }
                
                const rodadasDisponiveis = formato === 'novo' ? dados.rodadas : dados.rd;
                
                if (rodadasDisponiveis && Array.isArray(rodadasDisponiveis) && rodadasDisponiveis.length === 1) {
                    apenasUmaRodada = true;
                    console.log('üìå Apenas UMA rodada dispon√≠vel (modo espec√≠fico)');
                    document.getElementById('singleRodadaInfo').style.display = 'block';
                    document.getElementById('btnEscolherOutraRodada').textContent = '‚Ü©Ô∏è Escolher Outra Rodada';
                } else if (rodadasDisponiveis && rodadasDisponiveis.length > 1) {
                    apenasUmaRodada = false;
                    console.log(`üìå M√∫ltiplas rodadas (${rodadasDisponiveis.length}) - modo navega√ß√£o`);
                    document.getElementById('btnEscolherOutraRodada').textContent = '‚Ü©Ô∏è Voltar e Navegar';
                }
                
                if (formato === 'novo') {
                    appData.rdc = dados.rodada_detalhada;
                    rodadaAtualNum = dados.rodada_ativa;
                } else {
                    appData.rdc = dados.rdc;
                    rodadaAtualNum = dados.ra;
                }
                
                if (!rodadaAtualNum && rodadasDisponiveis && rodadasDisponiveis.length > 0) {
                    rodadaAtualNum = rodadasDisponiveis[0].n || rodadasDisponiveis[0].numero;
                }
                
                console.log(`üìç Rodada atual: ${rodadaAtualNum}`);
                document.getElementById('rodadaInfo').textContent = `Rodada ${rodadaAtualNum} - Visualiza√ß√£o`;
                
                carregarRodadaAtual();
                
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO AO CARREGAR DADOS:', error);
                mostrarErro(`Erro ao carregar dados: ${error.message}`);
            }
        }
        
        // ==============================================
        // FUN√á√ïES AUXILIARES
        // ==============================================
        function carregarRodadaAtual() {
            console.log(`üîÑ Carregando rodada ${rodadaAtualNum}...`);
            
            if (appData.rdc) {
                exibirRodada(appData.rdc);
            } else {
                document.getElementById('loading').style.display = 'flex';
                setTimeout(() => {
                    mostrarErro('Dados da rodada n√£o dispon√≠veis');
                }, 2000);
            }
        }
        
        function exibirRodada(rodada) {
            console.log('üìä Exibindo rodada:', rodada);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            const totalRodada = rodada.jtf || rodada.t || 0;
            const usadosAdm = rodada.jub || rodada.u || 0;
            const meusPalpites = rodada.jp || rodada.j || 0;
            // ALTERADO: Usar RC (Resultado Correto) das estat√≠sticas
            const resultadoCorreto = rodada.est?.rc || rodada.est?.rc || 0;
            const pontos = rodada.tp || rodada.p || 0;
            const placarExato = rodada.est?.pe || 0;
            
            console.log('üìà Estat√≠sticas extra√≠das:', {
                totalRodada,
                usadosAdm,
                meusPalpites,
                resultadoCorreto,
                pontos,
                placarExato
            });
            
            document.getElementById('rodadaResumo').style.display = 'block';
            document.getElementById('statTotalRodada').textContent = totalRodada;
            document.getElementById('statUsadosAdm').textContent = usadosAdm;
            document.getElementById('statMeusPalpites').textContent = meusPalpites;
            // ALTERADO: Atualiza o elemento correto
            document.getElementById('statResultadoCorreto').textContent = resultadoCorreto;
            document.getElementById('statPontos').textContent = pontos;
            document.getElementById('statPE').textContent = placarExato;
            
            document.getElementById('contadorPalpites').textContent = meusPalpites;
            document.getElementById('contadorUsados').textContent = usadosAdm;
            document.getElementById('contadorTotal').textContent = totalRodada;
            
            const rodadaNum = rodada.num || rodada.n || rodadaAtualNum;
            document.getElementById('gamesTitle').textContent = `Jogos da Rodada ${rodadaNum}`;
            document.getElementById('rodadaInfo').textContent = `Rodada ${rodadaNum} - Palpites e Pontua√ß√£o`;
            
            exibirJogosRodada(rodada);
        }
        
        function exibirJogosRodada(rodada) {
            const container = document.getElementById('jogosLista');
            const jogos = rodada.jogos || [];
            
            container.innerHTML = '';
            
            if (jogos.length === 0) {
                container.innerHTML = `
                    <div class="game-card" style="text-align: center; padding: 30px 20px;">
                        <div style="font-size: 40px; margin-bottom: 15px;">üì≠</div>
                        <div style="font-size: 16px; font-weight: 600; color: #4a5568; margin-bottom: 8px;">
                            Nenhum jogo nesta rodada
                        </div>
                        <div style="color: #718096; font-size: 13px; line-height: 1.4;">
                            N√£o h√° jogos com placar real nesta rodada.
                        </div>
                    </div>
                `;
                return;
            }
            
            console.log(`üéÆ Exibindo ${jogos.length} jogos`);
            
            // Contadores para estat√≠sticas
            let jogosComPalpite = 0;
            let jogosSemPalpite = 0;
            
            jogos.forEach((jogo, index) => {
                // ‚≠ê‚≠ê VERIFICA√á√ÉO CR√çTICA: Detecta se tem palpite
                const temPalpite = jogo.tem_palpite === true || 
                                 (jogo.pal !== 'c/vim' && jogo.pal !== 'Sem palpite');
                
                if (temPalpite) {
                    jogosComPalpite++;
                } else {
                    jogosSemPalpite++;
                }
                
                const div = document.createElement('div');
                div.className = `game-card ${jogo.pd ? 'pd-card' : ''}`;
                
                const placarReal = jogo.pr || '? x ?';
                const placarPalpite = temPalpite ? (jogo.pal || '0 x 0') : 'c/vim';
                
                let [realMandante, realVisitante] = placarReal.split('x').map(v => v.trim());
                let palpiteMandante, palpiteVisitante;
                
                if (temPalpite) {
                    [palpiteMandante, palpiteVisitante] = placarPalpite.split('x').map(v => v.trim());
                } else {
                    palpiteMandante = palpiteVisitante = 'c/vim';
                }
                
                if (!realMandante || !realVisitante) {
                    realMandante = realVisitante = '?';
                }
                
                if (!palpiteMandante || !palpiteVisitante) {
                    palpiteMandante = palpiteVisitante = '0';
                }
                
                const timeMandante = jogo.m || jogo.mandante || 'Time Casa';
                const timeVisitante = jogo.v || jogo.visitante || 'Time Visitante';
                const pontos = jogo.pts || 0;
                const acertos = jogo.ac || [];
                const pdUsada = jogo.pd || false;
                
                // ‚≠ê‚≠ê DETERMINA SE MOSTRA "c/vim"
                const mostrarCvim = !temPalpite;
                
                div.innerHTML = `
                    ${pdUsada ? '<div class="pd-badge">‚≠ê PONTUA√á√ÉO DOBRADA</div>' : ''}
                    
                    <!-- Layout 2 linhas -->
                    <div class="game-grid">
                        <!-- Linha 1: Mandante -->
                        <div class="team-name">${timeMandante}</div>
                        <div class="score-box real-score">${realMandante}</div>
                        <div class="score-box guess-score ${mostrarCvim ? 'cvim' : ''}">
                            ${mostrarCvim ? 'c/vim' : palpiteMandante}
                        </div>
                        
                        <!-- Separador visual -->
                        <div style="grid-column: 1 / -1; height: 1px;"></div>
                        
                        <!-- Linha 2: Visitante -->
                        <div class="team-name">${timeVisitante}</div>
                        <div class="score-box real-score">${realVisitante}</div>
                        <div class="score-box guess-score ${mostrarCvim ? 'cvim' : ''}">
                            ${mostrarCvim ? 'c/vim' : palpiteVisitante}
                        </div>
                    </div>
                    
                    <!-- Legenda -->
                    <div class="score-legend">
                        <div></div>
                        <div>Real</div>
                        <div>Palpite</div>
                    </div>
                    
                    <!-- Pontua√ß√£o detalhada -->
                    <div class="points-calculation">
                        ${calcularDetalhesPontuacao(temPalpite, acertos, pdUsada, pontosTotais)}
                    </div>
                    
                    <!-- Mensagem de jogo sem palpite -->
                    ${mostrarCvim ? `
                        <div class="sem-palpite-info">
                            <strong>‚ö†Ô∏è Sem palpite:</strong> Voc√™ n√£o palpitou neste jogo
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(div);
            });
            
            console.log(`üìä Resumo: ${jogosComPalpite} com palpite, ${jogosSemPalpite} sem palpite`);
        }
        
        function calcularDetalhesPontuacao(temPalpite, acertos, pdUsada, pontosTotais) {
            if (!temPalpite) {
                return `
                    <div class="points-line" style="color: #718096; font-style: italic;">
                        Sem palpite para calcular pontos
                    </div>
                    <div class="points-total">Total do jogo: 0 pontos</div>
                `;
            }
            
            let html = '';
            
            const contadores = {
                'PE': acertos.filter(a => a === 'PE').length,
                'RC': acertos.filter(a => a === 'RC').length,
                'GM': acertos.filter(a => a === 'GM').length,
                'GV': acertos.filter(a => a === 'GV').length
            };
            
            const itensPontos = [];
            let totalCalculado = 0;
            
            if (contadores.PE > 0) {
                itensPontos.push('Placar Exato (10)');
                itensPontos.push('Acerto GM (2)');
                itensPontos.push('Acerto GV (2)');
                totalCalculado = 14;
            }
            else if (contadores.RC > 0) {
                itensPontos.push('Resultado Correto (4)');
                totalCalculado = 4;
                
                if (contadores.GM > 0) {
                    itensPontos.push('Acerto GM (2)');
                    totalCalculado += 2;
                }
                
                if (contadores.GV > 0) {
                    itensPontos.push('Acerto GV (2)');
                    totalCalculado += 2;
                }
            }
            else {
                if (contadores.GM > 0) {
                    itensPontos.push('Acerto GM (2)');
                    totalCalculado += 2;
                }
                
                if (contadores.GV > 0) {
                    itensPontos.push('Acerto GV (2)');
                    totalCalculado += 2;
                }
                
                if (contadores.GM === 0 && contadores.GV === 0) {
                    itensPontos.push('Sem acertos (0)');
                    totalCalculado = 0;
                }
            }
            
            if (itensPontos.length > 0) {
                const linhaPontos = itensPontos.join(' + ');
                html += `<div class="points-line">${linhaPontos}</div>`;
            }
            
            html += `<div class="points-total">Total do jogo: ${totalCalculado} pontos</div>`;
            
            if (pdUsada) {
                const totalFinal = totalCalculado * 2;
                html += `<div class="points-pd">[PD 2x] ‚Üí ${totalFinal} pontos</div>`;
            }
            
            return html;
        }
        
        // ==============================================
        // FUN√á√ÉO PARA COMPARTILHAR NO GRUPO
        // ==============================================
        async function compartilharNoGrupo() {
            const btn = document.getElementById('btnCompartilhar');
            const status = document.getElementById('shareStatus');
            
            try {
                // Desabilita o bot√£o e mostra status
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Gerando imagem...';
                status.className = 'share-status loading';
                status.innerHTML = 'Capturando tela e preparando para compartilhar...';
                status.style.display = 'block';
                
                // 1. CAPTURA A TELA COM html2canvas
                console.log('üì∏ Iniciando captura de tela...');
                
                // Captura apenas o container principal (exclui bot√µes de navega√ß√£o)
                const container = document.querySelector('.container');
                
                // Op√ß√µes para melhor qualidade
                const canvas = await html2canvas(container, {
                    scale: 2, // Maior qualidade
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#667eea', // Cor do fundo do body
                    onclone: function(clonedDoc) {
                        // Garante que elementos din√¢micos sejam capturados
                        const clonedContainer = clonedDoc.querySelector('.container');
                        if (clonedContainer) {
                            // Remove sombras e ajustes visuais para imagem
                            clonedContainer.style.boxShadow = 'none';
                            clonedContainer.style.marginTop = '0';
                            clonedContainer.style.marginBottom = '0';
                            
                            // Remove o bot√£o de compartilhar da captura
                            const shareBtn = clonedContainer.querySelector('.share-button');
                            if (shareBtn) {
                                shareBtn.style.display = 'none';
                            }
                            
                            // Remove o status
                            const shareStatus = clonedContainer.querySelector('.share-status');
                            if (shareStatus) {
                                shareStatus.style.display = 'none';
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Captura de tela conclu√≠da');
                
                // 2. CONVERTE PARA BASE64
                const imagemBase64 = canvas.toDataURL('image/jpeg', 0.95); // JPEG com 95% qualidade
                console.log(`üìä Tamanho da imagem: ${Math.round(imagemBase64.length / 1024)}KB`);
                
                // 3. PREPARA DADOS PARA ENVIAR
                const dadosCompartilhamento = {
                    tipo: 'compartilhar_resultados',
                    usuario_id: usuarioId,
                    usuario_nome: document.getElementById('userName').textContent,
                    rodada_num: rodadaAtualNum,
                    imagem_base64: imagemBase64,
                    timestamp: Date.now()
                };
                
                console.log('üì§ Dados preparados para envio:', {
                    usuario_id: usuarioId,
                    usuario_nome: document.getElementById('userName').textContent,
                    rodada_num: rodadaAtualNum
                });
                
                // 4. ENVIA VIA TELEGRAM WEB APP
                if (window.Telegram && Telegram.WebApp) {
                    console.log('üì§ Enviando imagem para o bot...');
                    status.className = 'share-status loading';
                    status.innerHTML = 'Enviando para o grupo...';
                    
                    // Envia os dados para o bot
                    Telegram.WebApp.sendData(JSON.stringify(dadosCompartilhamento));
                    
                    // Atualiza status
                    setTimeout(() => {
                        status.className = 'share-status success';
                        status.innerHTML = `
                            ‚úÖ <strong>Resultados compartilhados com sucesso!</strong><br>
                            Sua imagem foi enviada para o grupo do bol√£o.
                        `;
                        
                        btn.innerHTML = '‚úÖ Compartilhado!';
                        
                        // Fecha o WebApp ap√≥s 3 segundos
                        setTimeout(() => {
                            if (window.Telegram && Telegram.WebApp) {
                                Telegram.WebApp.close();
                            }
                        }, 3000);
                        
                    }, 2000);
                    
                } else {
                    // Modo de desenvolvimento - simula envio
                    console.log('‚ö†Ô∏è Ambiente de desenvolvimento - simulando envio');
                    console.log('üì¶ Dados:', dadosCompartilhamento);
                    
                    // Mostra a imagem em uma nova janela para teste
                    const novaJanela = window.open();
                    novaJanela.document.write(`
                        <html>
                        <head><title>Preview - Compartilhamento</title></head>
                        <body style="margin: 0; padding: 20px; background: #f0f0f0;">
                            <h2>Preview do Compartilhamento</h2>
                            <p><strong>Usu√°rio:</strong> ${document.getElementById('userName').textContent}</p>
                            <p><strong>Rodada:</strong> ${rodadaAtualNum}</p>
                            <img src="${imagemBase64}" style="max-width: 100%; border: 1px solid #ccc; border-radius: 10px;">
                            <p style="margin-top: 20px; color: #666;">Em produ√ß√£o, esta imagem seria enviada automaticamente ao grupo.</p>
                        </body>
                        </html>
                    `);
                    
                    status.className = 'share-status success';
                    status.innerHTML = `
                        ‚úÖ <strong>Modo de teste:</strong> Imagem gerada!<br>
                        Em produ√ß√£o, isto seria enviado ao grupo automaticamente.
                    `;
                    
                    btn.innerHTML = 'üì§ Teste Conclu√≠do';
                    btn.disabled = true;
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao compartilhar:', error);
                
                status.className = 'share-status error';
                status.innerHTML = `
                    ‚ùå <strong>Erro ao compartilhar:</strong> ${error.message}<br>
                    Tente novamente ou entre em contato com o administrador.
                `;
                
                btn.disabled = false;
                btn.innerHTML = 'üì§ Compartilhar no Grupo';
            }
        }
        
        // ==============================================
        // FUN√á√ïES DE NAVEGA√á√ÉO
        // ==============================================
        function escolherOutraRodada() {
            console.log('üîÑ Solicitando para escolher outra rodada...');
            
            if (window.Telegram && Telegram.WebApp) {
                const dataToSend = {
                    'tipo': 'fechar_para_escolher_nova_rodada',
                    'usuario_id': usuarioId,
                    'rodada_atual': rodadaAtualNum,
                    'timestamp': Date.now()
                };
                
                console.log('üì§ Enviando solicita√ß√£o para fechar:', dataToSend);
                
                Telegram.WebApp.sendData(JSON.stringify(dataToSend));
                
                setTimeout(() => {
                    Telegram.WebApp.close();
                }, 300);
            } else {
                console.log('‚ö†Ô∏è Ambiente de desenvolvimento - simulando fechamento');
                alert('Para escolher outra rodada, feche esta janela e clique novamente no bot√£o "Ver meus palpites".');
            }
        }
        
        function mostrarErro(mensagem) {
            console.error('‚ùå ERRO:', mensagem);
            
            document.getElementById('loading').style.display = 'none';
            
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 15px;">‚ùå</div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #c53030;">
                    Erro ao carregar
                </div>
                <div style="margin-bottom: 15px; color: #4a5568; font-size: 14px; line-height: 1.4;">
                    ${mensagem}
                </div>
                <div style="font-size: 12px; color: #718096; border-top: 1px solid #fed7d7; padding-top: 10px;">
                    Tente novamente ou entre em contato com o administrador.
                </div>
            `;
        }
        
        // ==============================================
        // FUN√á√ïES DE DEBUG
        // ==============================================
        window.debugDados = function() {
            console.clear();
            console.log('=== DEBUG COMPLETO ===');
            console.log('üìä appData:', appData);
            console.log('üìç rodadaAtualNum:', rodadaAtualNum);
            console.log('üë§ usuarioId:', usuarioId);
            console.log('üí¨ chatId:', chatId);
            console.log('üìå apenasUmaRodada:', apenasUmaRodada);
            console.log('üåê URL completa:', window.location.href);
            console.log('üìè Par√¢metro data length:', window.location.search ? new URLSearchParams(window.location.search).get('data')?.length : 'N/A');
            console.log('=======================');
        };
        
        window.testarComDadosExemplo = function() {
            const dadosExemplo = {
                tipo: 'palpites_usuario_gzip',
                usuario: {
                    id: 123,
                    nome: 'Jo√£o Silva',
                    telegram_id: 456789
                },
                rodadas: [
                    {
                        'n': 1,
                        'p': 24,
                        'j': 6,
                        'u': 7,
                        't': 10,
                        'c': 6,
                        's': 'ativa'
                    }
                ],
                rodada_ativa: 1,
                rodada_detalhada: {
                    num: 1,
                    tp: 24,
                    jp: 6,
                    jub: 7,
                    jtf: 10,
                    jcp: 6,
                    est: { pe: 2, rc: 3, gm: 3, gv: 2, pd_usada: true }, // ALTERADO: RC = 3
                    jogos: [
                        {
                            id: 1,
                            m: 'Flamengo',
                            v: 'Vasco',
                            pal: '2x1',
                            pr: '2x1',
                            pts: 14,
                            ac: ['PE', 'GM', 'GV', 'PD'],
                            pd: true,
                            tem_palpite: true
                        },
                        {
                            id: 2,
                            m: 'S√£o Paulo',
                            v: 'Corinthians',
                            pal: 'c/vim',
                            pr: '1x0',
                            pts: 0,
                            ac: [],
                            pd: false,
                            tem_palpite: false
                        },
                        {
                            id: 3,
                            m: 'Palmeiras',
                            v: 'Santos',
                            pal: 'Sem palpite',
                            pr: '3x2',
                            pts: 0,
                            ac: [],
                            pd: false,
                            tem_palpite: false
                        }
                    ]
                }
            };
            
            appData = dadosExemplo;
            rodadaAtualNum = 1;
            usuarioId = 123;
            apenasUmaRodada = true;
            
            exibirRodada(dadosExemplo.rodada_detalhada);
            document.getElementById('singleRodadaInfo').style.display = 'block';
            
            console.log('‚úÖ Teste com dados de exemplo executado (com jogos sem palpite)');
        };
    </script>
</body>
</html>
