<script>
    // ========== VARIÁVEIS GLOBAIS ==========
    let rodadasSelecionadas = [];
    let modoUnica = false;
    let adminId = null;
    let originalMessageId = null;
    let jogosDisponiveis = [];
    let jogosSelecionados = new Set();
    let trunfosSelecionados = new Set();
    let pdSelecionados = new Set();
    let usuariosAtivos = [];

    // ========== INICIALIZAÇÃO ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Ler parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        adminId = urlParams.get('admin_id');
        const rodadaParam = urlParams.get('rodada'); // Para única: "5"
        const rodadasParam = urlParams.get('rodadas'); // Para múltiplas: "5,6,7"
        originalMessageId = urlParams.get('message_id');

        // Determinar modo
        if (rodadaParam) {
            rodadasSelecionadas = [parseInt(rodadaParam)];
            modoUnica = true;
            atualizarTitulo(`Configurar Rodada ${rodadaParam}`);
        } else if (rodadasParam) {
            rodadasSelecionadas = rodadasParam.split(',').map(Number);
            modoUnica = false;
            atualizarTitulo(`Configurar Rodadas ${rodadasParam}`);
        } else {
            mostrarErro('Nenhuma rodada especificada na URL!');
            return;
        }

        // Verificar se está no Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // Configurar botão de fechar
            Telegram.WebApp.MainButton.setText('FECHAR').show().onClick(function() {
                Telegram.WebApp.close();
            });
        }

        // Forçar tela cheia
        requestFullscreen();

        // Solicitar jogos ao bot
        solicitarJogosAoBot();
        
        // Configurar eventos
        configurarEventos();
    });

    // ========== FUNÇÕES DE TELA CHEIA ==========
    function requestFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }
    }

    // ========== ATUALIZAR INTERFACE ==========
    function atualizarTitulo(texto) {
        const titleElement = document.querySelector('.header h1');
        if (titleElement) {
            titleElement.innerHTML = `<i class="fas fa-plus-circle"></i> ${texto}`;
        }
        document.title = texto;
    }

    function mostrarErro(mensagem) {
        const container = document.getElementById('jogosContainer');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h3>${mensagem}</h3>
                    <p>Feche e tente novamente.</p>
                </div>
            `;
        }
    }

    function mostrarLoading(mostrar, texto = 'Carregando...') {
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        
        if (loadingText) {
            loadingText.textContent = texto;
        }
        
        if (loading) {
            loading.classList.toggle('show', mostrar);
        }
    }

    function mostrarNotificacao(mensagem, tipo = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = mensagem;
        notification.className = `notification ${tipo}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // ========== COMUNICAÇÃO COM O BOT ==========
    function solicitarJogosAoBot() {
        mostrarLoading(true, 'Buscando jogos disponíveis...');
        
        // Simular requisição ao bot
        setTimeout(() => {
            // EM PRODUÇÃO: Aqui você faria uma requisição ao seu backend/bot
            // Por enquanto, vamos mostrar mensagem informativa
            
            const container = document.getElementById('jogosContainer');
            if (container) {
                if (modoUnica) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-futbol" style="font-size: 48px; color: #3b82f6; margin-bottom: 20px;"></i>
                            <h3>Rodada ${rodadasSelecionadas[0]} Selecionada</h3>
                            <p>Esta rodada ainda não tem jogos cadastrados.</p>
                            <p>Você pode:</p>
                            <ol style="text-align: left; display: inline-block; margin-top: 15px;">
                                <li>Adicionar jogos manualmente</li>
                                <li>Importar de uma planilha</li>
                                <li>Buscar automaticamente</li>
                            </ol>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-layer-group" style="font-size: 48px; color: #3b82f6; margin-bottom: 20px;"></i>
                            <h3>Múltiplas Rodadas Selecionadas</h3>
                            <p>Rodadas: ${rodadasSelecionadas.join(', ')}</p>
                            <p>Estas rodadas ainda não têm jogos cadastrados.</p>
                        </div>
                    `;
                }
            }
            
            // Carregar usuários ativos (simulação)
            carregarUsuariosSimulados();
            
            // Configurar horário padrão
            configurarHorarioPadrao();
            
            mostrarLoading(false);
            
        }, 1500);
    }

    function carregarUsuariosSimulados() {
        // EM PRODUÇÃO: Buscar usuários do bot
        // Por enquanto, mensagem informativa
        
        const trunfosContainer = document.getElementById('trunfosContainer');
        const dobradaContainer = document.getElementById('dobradaContainer');
        
        if (trunfosContainer) {
            trunfosContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    <i class="fas fa-users" style="font-size: 32px; margin-bottom: 10px;"></i>
                    <p>Usuários serão carregados do banco de dados</p>
                    <p style="font-size: 12px;">(Implementação em andamento)</p>
                </div>
            `;
        }
        
        if (dobradaContainer) {
            dobradaContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    <i class="fas fa-star" style="font-size: 32px; margin-bottom: 10px;"></i>
                    <p>Selecione usuários para Pontuação Dobrada</p>
                    <p style="font-size: 12px;">(Lista de usuários em desenvolvimento)</p>
                </div>
            `;
        }
    }

    // ========== CONFIGURAÇÕES DE HORÁRIO ==========
    function configurarHorarioPadrao() {
        // Amanhã às 20:00
        const amanha = new Date();
        amanha.setDate(amanha.getDate() + 1);
        amanha.setHours(20, 0, 0, 0);
        
        // Formatar para input datetime-local
        const ano = amanha.getFullYear();
        const mes = String(amanha.getMonth() + 1).padStart(2, '0');
        const dia = String(amanha.getDate()).padStart(2, '0');
        const horas = String(amanha.getHours()).padStart(2, '0');
        const minutos = String(amanha.getMinutes()).padStart(2, '0');
        
        const horarioFormatado = `${ano}-${mes}-${dia}T${horas}:${minutos}`;
        
        const horarioInput = document.getElementById('horarioFechamento');
        if (horarioInput) {
            horarioInput.value = horarioFormatado;
            atualizarHorarioTrunfo();
        }
    }

    function atualizarHorarioTrunfo() {
        const horarioInput = document.getElementById('horarioFechamento');
        const trunfoInput = document.getElementById('horarioTrunfo');
        
        if (horarioInput && trunfoInput && horarioInput.value) {
            const horario = new Date(horarioInput.value);
            horario.setMinutes(horario.getMinutes() + 30);
            
            const horas = String(horario.getHours()).padStart(2, '0');
            const minutos = String(horario.getMinutes()).padStart(2, '0');
            
            trunfoInput.value = `${horas}:${minutos}`;
        }
        
        atualizarResumo();
    }

    // ========== MANIPULAÇÃO DE DADOS ==========
    function selecionarJogo(jogoId) {
        if (jogosSelecionados.has(jogoId)) {
            jogosSelecionados.delete(jogoId);
        } else {
            jogosSelecionados.add(jogoId);
        }
        atualizarResumo();
    }

    function selecionarUsuario(usuarioId, tipo) {
        if (tipo === 'trunfo') {
            if (trunfosSelecionados.has(usuarioId)) {
                trunfosSelecionados.delete(usuarioId);
            } else {
                trunfosSelecionados.add(usuarioId);
            }
        } else if (tipo === 'dobrada') {
            if (pdSelecionados.has(usuarioId)) {
                pdSelecionados.delete(usuarioId);
            } else {
                pdSelecionados.add(usuarioId);
            }
        }
        atualizarResumo();
    }

    // ========== RESUMO E VALIDAÇÃO ==========
    function atualizarResumo() {
        // Atualizar contadores
        document.getElementById('summaryRodadas').textContent = rodadasSelecionadas.length;
        document.getElementById('summaryJogos').textContent = jogosSelecionados.size;
        document.getElementById('summaryTrunfos').textContent = trunfosSelecionados.size;
        document.getElementById('summaryDobrada').textContent = pdSelecionados.size;
        
        // Atualizar horário
        const horarioInput = document.getElementById('horarioFechamento');
        if (horarioInput && horarioInput.value) {
            const horario = new Date(horarioInput.value);
            const horas = String(horario.getHours()).padStart(2, '0');
            const minutos = String(horario.getMinutes()).padStart(2, '0');
            document.getElementById('summaryHorario').textContent = `${horas}:${minutos}`;
        }
    }

    function validarDados() {
        const horarioInput = document.getElementById('horarioFechamento');
        
        if (!horarioInput || !horarioInput.value) {
            mostrarNotificacao('Defina um horário de fechamento!', 'error');
            return false;
        }
        
        if (jogosSelecionados.size === 0) {
            mostrarNotificacao('Selecione pelo menos um jogo!', 'error');
            return false;
        }
        
        return true;
    }

    // ========== ENVIAR DADOS PARA O BOT ==========
    function enviarRodada() {
        if (!validarDados()) {
            return;
        }
        
        const horarioInput = document.getElementById('horarioFechamento');
        
        const dados = {
            action: 'create_round',
            admin_id: adminId,
            original_message_id: originalMessageId,
            rodadas: rodadasSelecionadas,
            jogos_selecionados: Array.from(jogosSelecionados),
            horario_fechamento: horarioInput.value,
            trunfos: Array.from(trunfosSelecionados),
            pd_usuarios: Array.from(pdSelecionados)
        };
        
        console.log('Dados a enviar:', dados);
        
        mostrarLoading(true, 'Enviando rodada...');
        
        // Enviar para o bot via Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.sendData(JSON.stringify(dados));
            
            // Fechar após 2 segundos
            setTimeout(() => {
                Telegram.WebApp.close();
            }, 2000);
        } else {
            // Modo desenvolvimento
            mostrarNotificacao('Rodada enviada (modo desenvolvimento)', 'success');
            setTimeout(() => {
                mostrarLoading(false);
            }, 2000);
        }
    }

    // ========== CONFIGURAR EVENTOS ==========
    function configurarEventos() {
        // Horário de fechamento
        const horarioInput = document.getElementById('horarioFechamento');
        if (horarioInput) {
            horarioInput.addEventListener('change', atualizarHorarioTrunfo);
        }
        
        // Botão enviar
        const btnEnviar = document.querySelector('.btn-primary');
        if (btnEnviar) {
            btnEnviar.addEventListener('click', enviarRodada);
        }
        
        // Botão cancelar
        const btnCancelar = document.querySelector('.btn-secondary');
        if (btnCancelar) {
            btnCancelar.addEventListener('click', function() {
                if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                    Telegram.WebApp.close();
                } else {
                    mostrarNotificacao('Operação cancelada', 'warning');
                }
            });
        }
        
        // Botão tela cheia
        const fullscreenBtn = document.querySelector('.fullscreen-btn');
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }
    }

    // ========== FUNÇÕES DE APOIO (para compatibilidade) ==========
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            requestFullscreen();
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function showLoading(show, texto = 'Carregando...') {
        mostrarLoading(show, texto);
    }

    function showNotification(mensagem, tipo = 'success') {
        mostrarNotificacao(mensagem, tipo);
    }
</script>
