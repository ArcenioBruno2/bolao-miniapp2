<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚öôÔ∏è Configurar Encerramento (Bras√≠lia)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --tg-theme-bg-color: #1e2a36;
            --tg-theme-text-color: #ffffff;
            --accent-color: #3390ec;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 400px; margin: 0 auto; }
        .card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--accent-color);
            background: #2c3b4a;
            color: white;
            font-size: 16px;
            margin: 15px 0;
            outline: none;
        }
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
        }
        .info { font-size: 13px; color: #aaa; margin-bottom: 10px; }
        #preview { color: #3390ec; font-weight: 600; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Definir Prazo</h3>
        <p class="info">Os hor√°rios abaixo s√£o referentes ao <b>Hor√°rio de Bras√≠lia</b></p>
        
        <div class="card">
            <label>Data e Hora de Encerramento:</label>
            <input type="datetime-local" id="data_encerramento">
            <div id="preview">Selecione uma data</div>
        </div>

        <button class="btn" id="btnSalvar" style="margin-top: 20px;">ATIVAR PONTOS EXTRAS</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const inputData = document.getElementById('data_encerramento');
        const preview = document.getElementById('preview');
        const btnSalvar = document.getElementById('btnSalvar');

        // Fun√ß√£o crucial: Transforma o que voc√™ digitou em um objeto de tempo real (UTC)
        // considerando que o que voc√™ digitou √â Hor√°rio de Bras√≠lia (-03:00)
        function obterDataComoBrasilia(valorInput) {
            if (!valorInput) return null;
            // Pegamos o valor YYYY-MM-DDTHH:MM e for√ßamos o fuso -03:00
            // Isso ignora o fuso hor√°rio do seu computador atual
            return new Date(valorInput + ":00-03:00");
        }

        inputData.addEventListener('change', function() {
            if (this.value) {
                // Formata apenas para exibi√ß√£o visual bonitinha
                const partes = this.value.split('T');
                const data = partes[0].split('-').reverse().join('/');
                const hora = partes[1];
                preview.innerHTML = `üìÖ Encerra em: ${data} √†s ${hora} (Bras√≠lia)`;
            }
        });

        btnSalvar.addEventListener('click', function() {
            const valorInput = inputData.value;
            
            if (!valorInput) {
                tg.showAlert('‚ùå Selecione a data!');
                return;
            }

            const dataSelecionada = obterDataComoBrasilia(valorInput);
            const agoraReal = new Date(); // O momento absoluto atual no mundo

            // Valida√ß√£o: Se o momento escolhido (em Bras√≠lia) j√° passou do momento agora (UTC)
            if (dataSelecionada <= agoraReal) {
                tg.showAlert('‚ùå Este hor√°rio j√° passou em Bras√≠lia!\nEscolha uma hora futura.');
                return;
            }

            tg.showConfirm(`Confirmar encerramento para √†s ${valorInput.split('T')[1]} (Bras√≠lia)?`, (confirmed) => {
                if (confirmed) {
                    // Enviamos para o Python a string pura "YYYY-MM-DD HH:MM:00"
                    const dataFormatada = valorInput.replace('T', ' ') + ":00";
                    tg.sendData(JSON.stringify({
                        data_encerramento: dataFormatada
                    }));
                    tg.close();
                }
            });
        });

        // Configurar valor m√≠nimo inicial no input (apenas para facilitar)
        const agoraBr = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
        agoraBr.setMinutes(agoraBr.getMinutes() + 5); // Sugere 5 min no futuro
        const isoStr = agoraBr.getFullYear() + '-' + 
                      String(agoraBr.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(agoraBr.getDate()).padStart(2, '0') + 'T' + 
                      String(agoraBr.getHours()).padStart(2, '0') + ':' + 
                      String(agoraBr.getMinutes()).padStart(2, '0');
        inputData.min = isoStr;
    </script>
</body>
</html>
