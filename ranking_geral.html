<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Ranking Geral - Bol√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .debug-panel {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            font-size: 12px;
            color: #2c3e50;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        
        .debug-line {
            margin-bottom: 5px;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
        
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        
        .states-container {
            padding: 20px;
        }
        
        .loading-state, .error-state, .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .retry-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ RANKING GERAL</h1>
            <div>Classifica√ß√£o completa de todos os participantes</div>
        </div>
        
        <div class="debug-panel" id="debug-panel">
            <div class="debug-line info">üîç Inicializando Web App de Ranking...</div>
        </div>
        
        <div class="states-container">
            <!-- Estado de carregamento -->
            <div id="loading-state" class="loading-state">
                <div class="spinner"></div>
                <h3>Carregando ranking...</h3>
                <p>Por favor, aguarde enquanto carregamos os dados.</p>
            </div>
            
            <!-- Estado de erro -->
            <div id="error-state" class="error-state" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                <h3 id="error-title">Erro ao carregar ranking</h3>
                <p id="error-message" style="margin: 10px 0; color: #7f8c8d;"></p>
                <button onclick="retryWithDifferentMethods()" class="retry-btn">
                    üîÑ Tentar diferentes m√©todos
                </button>
                <button onclick="window.location.href = window.location.href.split('?')[0]" 
                        style="background: #95a5a6; margin-left: 10px;" class="retry-btn">
                    üîÑ Recarregar sem dados
                </button>
            </div>
            
            <!-- Estado vazio -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                <h3>Nenhum dado de ranking dispon√≠vel</h3>
                <p>Aguarde os administradores atualizarem as rodadas.</p>
            </div>
            
            <!-- Conte√∫do real (ser√° preenchido) -->
            <div id="content" style="display: none;">
                <!-- Aqui ser√° renderizado o ranking -->
            </div>
        </div>
    </div>

    <script>
        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let debugLog = [];
        let currentDataParam = '';
        
        // ==================== FUN√á√ïES DE DEBUG ====================
        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}`;
            
            debugLog.push({message: logLine, type});
            console.log(`üîç ${message}`);
            
            // Atualiza painel de debug
            const debugPanel = document.getElementById('debug-panel');
            if (debugPanel) {
                const line = document.createElement('div');
                line.className = `debug-line ${type}`;
                line.textContent = logLine;
                debugPanel.appendChild(line);
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
        }
        
        // ==================== FUN√á√ïES DE UTILIDADE ====================
        function showState(stateId) {
            ['loading-state', 'error-state', 'empty-state', 'content'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(stateId).style.display = 'block';
        }
        
        function showError(title, message) {
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
            showState('error-state');
        }
        
        // ==================== FUN√á√ïES DE DECODIFICA√á√ÉO ====================
        function extractDataFromURL() {
            logDebug('Extraindo dados da URL...', 'info');
            
            const url = window.location.href;
            logDebug(`URL completa: ${url}`, 'info');
            
            // Tenta diferentes m√©todos para extrair o par√¢metro 'data'
            let dataParam = '';
            
            // M√©todo 1: URLSearchParams (padr√£o)
            try {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                dataParam = params.get('data');
                if (dataParam) {
                    logDebug(`M√©todo 1 (URLSearchParams) - Encontrado: ${dataParam.length} chars`, 'success');
                    return dataParam;
                }
            } catch (e) {
                logDebug(`M√©todo 1 falhou: ${e.message}`, 'warning');
            }
            
            // M√©todo 2: Regex simples
            try {
                const match = url.match(/[?&]data=([^&]+)/);
                if (match && match[1]) {
                    dataParam = match[1];
                    logDebug(`M√©todo 2 (Regex) - Encontrado: ${dataParam.length} chars`, 'success');
                    return dataParam;
                }
            } catch (e) {
                logDebug(`M√©todo 2 falhou: ${e.message}`, 'warning');
            }
            
            // M√©todo 3: Split manual
            try {
                const parts = url.split('?');
                if (parts.length > 1) {
                    const query = parts[1];
                    const params = query.split('&');
                    for (const param of params) {
                        if (param.startsWith('data=')) {
                            dataParam = param.substring(5);
                            logDebug(`M√©todo 3 (Split) - Encontrado: ${dataParam.length} chars`, 'success');
                            return dataParam;
                        }
                    }
                }
            } catch (e) {
                logDebug(`M√©todo 3 falhou: ${e.message}`, 'warning');
            }
            
            logDebug('Nenhum par√¢metro "data" encontrado na URL', 'error');
            return null;
        }
        
        function safeAtob(str) {
            // Fun√ß√£o segura para atob que lida com URL encoding
            try {
                // Remove poss√≠veis fragmentos de URL
                let cleaned = str
                    .replace(/-/g, '+')
                    .replace(/_/g, '/')
                    .replace(/%2B/g, '+')
                    .replace(/%2F/g, '/')
                    .replace(/%3D/g, '=')
                    .trim();
                
                // Remove tudo ap√≥s # se existir
                if (cleaned.includes('#')) {
                    cleaned = cleaned.split('#')[0];
                }
                
                // Remove poss√≠veis quebras de linha e espa√ßos
                cleaned = cleaned.replace(/\s/g, '');
                
                // Adiciona padding se necess√°rio
                const pad = cleaned.length % 4;
                if (pad) {
                    if (pad === 1) {
                        throw new Error('Comprimento inv√°lido para Base64');
                    }
                    cleaned += '='.repeat(4 - pad);
                }
                
                logDebug(`Base64 limpo: ${cleaned.substring(0, 50)}...`, 'info');
                return atob(cleaned);
            } catch (error) {
                throw new Error(`Base64 inv√°lido: ${error.message}`);
            }
        }
        
        async function decompressGzip(base64Data) {
            try {
                logDebug('Tentando descompress√£o GZIP...', 'info');
                
                const binaryString = safeAtob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Verifica se √© GZIP (magic bytes: 0x1F 0x8B)
                if (bytes.length < 2 || bytes[0] !== 0x1F || bytes[1] !== 0x8B) {
                    logDebug('Dados n√£o s√£o GZIP (magic bytes n√£o encontrados)', 'warning');
                    return null;
                }
                
                const decompressedStream = new DecompressionStream('gzip');
                const writer = decompressedStream.writable.getWriter();
                writer.write(bytes);
                writer.close();
                
                const decompressedArrayBuffer = await new Response(decompressedStream.readable).arrayBuffer();
                const decompressedString = new TextDecoder().decode(decompressedArrayBuffer);
                
                logDebug('‚úÖ Descompress√£o GZIP bem-sucedida!', 'success');
                logDebug(`Dados descomprimidos: ${decompressedString.substring(0, 100)}...`, 'info');
                
                return JSON.parse(decompressedString);
            } catch (error) {
                logDebug(`‚ùå Falha na descompress√£o GZIP: ${error.message}`, 'error');
                return null;
            }
        }
        
        function decodeSimpleBase64(base64Data) {
            try {
                logDebug('Tentando decodifica√ß√£o Base64 simples...', 'info');
                
                const jsonString = safeAtob(base64Data);
                logDebug(`JSON decodificado: ${jsonString.substring(0, 100)}...`, 'info');
                
                const parsed = JSON.parse(jsonString);
                logDebug('‚úÖ Decodifica√ß√£o Base64 simples bem-sucedida!', 'success');
                return parsed;
            } catch (error) {
                logDebug(`‚ùå Falha na decodifica√ß√£o Base64 simples: ${error.message}`, 'error');
                return null;
            }
        }
        
        function decodeDirectJson(str) {
            try {
                logDebug('Tentando parse como JSON direto...', 'info');
                
                // Remove fragmentos de URL se existirem
                let cleaned = str;
                if (cleaned.includes('#')) {
                    cleaned = cleaned.split('#')[0];
                }
                
                const parsed = JSON.parse(cleaned);
                logDebug('‚úÖ Parse JSON direto bem-sucedido!', 'success');
                return parsed;
            } catch (error) {
                logDebug(`‚ùå Falha no parse JSON direto: ${error.message}`, 'error');
                return null;
            }
        }
        
        // ==================== FUN√á√ÉO PRINCIPAL ====================
        async function processData(dataParam) {
            logDebug(`=== PROCESSANDO DADOS (${dataParam.length} caracteres) ===`, 'info');
            logDebug(`Primeiros 100 chars: ${dataParam.substring(0, 100)}...`, 'info');
            
            // M√©todo 1: Tenta GZIP primeiro
            const gzipResult = await decompressGzip(dataParam);
            if (gzipResult) return gzipResult;
            
            // M√©todo 2: Tenta Base64 simples
            const base64Result = decodeSimpleBase64(dataParam);
            if (base64Result) return base64Result;
            
            // M√©todo 3: Tenta como JSON direto (raramente funciona)
            const jsonResult = decodeDirectJson(dataParam);
            if (jsonResult) return jsonResult;
            
            throw new Error('Todos os m√©todos de decodifica√ß√£o falharam');
        }
        
        // ==================== RENDERIZA√á√ÉO ====================
        function renderRanking(data) {
            logDebug('Renderizando ranking...', 'info');
            
            showState('content');
            
            const contentDiv = document.getElementById('content');
            
            // Verifica estrutura dos dados
            if (!data || typeof data !== 'object') {
                showError('Dados inv√°lidos', 'Os dados recebidos n√£o est√£o no formato esperado');
                return;
            }
            
            if (!data.k || !Array.isArray(data.k)) {
                showError('Estrutura inv√°lida', 'Os dados n√£o cont√™m a lista de participantes (campo "k")');
                return;
            }
            
            // Cria HTML do ranking
            let html = `
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${data.info?.total_participantes || data.k.length}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Participantes</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${data.info?.total_rodadas || '?'}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Rodadas</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${data.info?.lider_atual || data.k[0]?.n || '?'}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">L√≠der</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${data.info?.maior_pontuacao || data.k[0]?.t || 0}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">Pontos m√°x.</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 150px 200px; font-weight: bold; padding: 10px;">
                            <div>Posi√ß√£o</div>
                            <div>Participante</div>
                            <div>Pontos</div>
                            <div>Estat√≠sticas</div>
                        </div>
                    </div>
            `;
            
            // Adiciona cada participante
            data.k.forEach((participante, index) => {
                const position = participante.p || index + 1;
                let medal = '';
                
                if (position === 1) medal = 'ü•á';
                else if (position === 2) medal = 'ü•à';
                else if (position === 3) medal = 'ü•â';
                
                html += `
                    <div style="display: grid; grid-template-columns: 100px 1fr 150px 200px; padding: 15px; border-bottom: 1px solid #eee; align-items: center;">
                        <div style="font-size: 20px; font-weight: bold;">
                            ${medal} ${position}¬∫
                        </div>
                        <div>
                            <div style="font-weight: bold;">${participante.n || 'Participante'}</div>
                            <button onclick="viewPlayerBets(${participante.u || 0})" 
                                    style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-top: 5px; cursor: pointer;">
                                üìä Ver palpites
                            </button>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;">
                            ${participante.t ? participante.t.toLocaleString('pt-BR') : 0}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">${participante.e?.pe || 0}</div>
                                <div style="font-size: 10px; color: #7f8c8d;">PE</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #2ecc71;">${participante.e?.rc || 0}</div>
                                <div style="font-size: 10px; color: #7f8c8d;">RC</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #f39c12;">${participante.e?.gm || 0}</div>
                                <div style="font-size: 10px; color: #7f8c8d;">GM</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #9b59b6;">${participante.e?.gv || 0}</div>
                                <div style="font-size: 10px; color: #7f8c8d;">GV</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            contentDiv.innerHTML = html;
            logDebug(`‚úÖ Ranking renderizado com ${data.k.length} participantes`, 'success');
        }
        
        // ==================== FUN√á√ïES AUXILIARES ====================
        function viewPlayerBets(userId) {
            logDebug(`Clicou em ver palpites do usu√°rio ${userId}`, 'info');
            alert(`Esta funcionalidade abriria os palpites do usu√°rio ${userId}\nem um Web App separado.`);
        }
        
        function retryWithDifferentMethods() {
            logDebug('Tentando m√©todos alternativos...', 'info');
            loadRankingData();
        }
        
        // ==================== FLUXO PRINCIPAL ====================
        async function loadRankingData() {
            try {
                showState('loading-state');
                logDebug('=== INICIANDO CARREGAMENTO ===', 'info');
                
                // Extrai dados da URL
                currentDataParam = extractDataFromURL();
                
                if (!currentDataParam) {
                    showError('Dados n√£o encontrados', 'O par√¢metro "data" n√£o foi encontrado na URL');
                    return;
                }
                
                // Processa os dados
                const data = await processData(currentDataParam);
                
                // Renderiza o ranking
                renderRanking(data);
                
            } catch (error) {
                console.error('‚ùå Erro fatal:', error);
                showError('Erro ao processar dados', error.message);
            }
        }
        
        // ==================== TESTE COM DADOS FIXOS ====================
        async function testWithFixedData() {
            logDebug('=== TESTE COM DADOS FIXOS ===', 'info');
            
            // Dados de teste em Base64 (GZIP)
            const testDataBase64 = 'H4sIAAAAAAAAA6tWKkpNTEksSUxPLE4tLklMSq1QqgUAAAD//wMAtgtPvBAAAA==';
            
            try {
                const data = await processData(testDataBase64);
                if (data) {
                    logDebug('‚úÖ Teste com dados fixos bem-sucedido!', 'success');
                    renderRanking(data);
                }
            } catch (error) {
                logDebug(`‚ùå Teste falhou: ${error.message}`, 'error');
            }
        }
        
        // ==================== INICIALIZA√á√ÉO ====================
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('DOM carregado', 'success');
            
            // Configura Telegram WebApp se dispon√≠vel
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.BackButton.show();
                Telegram.WebApp.BackButton.onClick(() => {
                    Telegram.WebApp.close();
                });
                Telegram.WebApp.expand();
                logDebug('Telegram WebApp configurado', 'success');
            }
            
            // Carrega dados
            loadRankingData();
            
            // Adiciona bot√£o de teste (apenas para desenvolvimento)
            const testBtn = document.createElement('button');
            testBtn.textContent = 'üß™ Teste com dados fixos';
            testBtn.style.cssText = `
                position: fixed;
                bottom: 10px;
                right: 10px;
                background: #f39c12;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                z-index: 1000;
            `;
            testBtn.onclick = testWithFixedData;
            document.body.appendChild(testBtn);
        });
    </script>
</body>
</html>
