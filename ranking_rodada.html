<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking por Rodada - Bol√£o</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 25px;
        }

        .select-rodada {
            margin-bottom: 25px;
        }

        .select-rodada h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .select-rodada select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: #333;
            transition: border-color 0.3s;
        }

        .select-rodada select:focus {
            outline: none;
            border-color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c3e50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .rodada-info {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #2c3e50;
        }

        .rodada-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-item label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .info-item span {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .ranking-container {
            margin-top: 25px;
        }

        .ranking-header {
            display: grid;
            grid-template-columns: 50px 1fr 100px 100px 100px 100px 100px;
            gap: 15px;
            padding: 15px;
            background: #2c3e50;
            color: white;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 50px 1fr 100px 100px 100px 100px 100px;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
            transition: background 0.3s;
        }

        .ranking-item:hover {
            background: #f8f9fa;
        }

        .ranking-item.posicao-1 {
            background: linear-gradient(135deg, #ffd700 0%, #fff8e1 100%);
            font-weight: bold;
        }

        .ranking-item.posicao-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #f5f5f5 100%);
        }

        .ranking-item.posicao-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #f8ecd8 100%);
        }

        .posicao {
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: #2c3e50;
        }

        .nome-usuario {
            font-weight: 600;
            color: #333;
        }

        .pontuacao {
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .estatistica {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }

        .ranking-geral {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid #e0e0e0;
        }

        .ranking-geral h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .legenda {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .legenda h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .legenda-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }

        .legenda-cor {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .legenda-cor.ouro { background: #ffd700; }
        .legenda-cor.prata { background: #c0c0c0; }
        .legenda-cor.bronze { background: #cd7f32; }

        .btn-voltar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            display: block;
            margin: 30px auto 0;
        }

        .btn-voltar:hover {
            background: #5a6268;
        }

        @media (max-width: 768px) {
            .ranking-header, .ranking-item {
                grid-template-columns: 40px 1fr 80px;
                font-size: 0.8rem;
                gap: 10px;
            }
            
            .ranking-header div:nth-child(4),
            .ranking-header div:nth-child(5),
            .ranking-header div:nth-child(6),
            .ranking-header div:nth-child(7),
            .ranking-item div:nth-child(4),
            .ranking-item div:nth-child(5),
            .ranking-item div:nth-child(6),
            .ranking-item div:nth-child(7) {
                display: none;
            }
            
            .estatisticas-mobile {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-top: 10px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 600px) {
            .container {
                border-radius: 15px;
            }
            
            .content {
                padding: 15px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Ranking por Rodada</h1>
            <p>Classifica√ß√£o dos participantes</p>
        </div>

        <div class="content">
            <div class="select-rodada">
                <h3>Selecione uma Rodada</h3>
                <select id="selectRodada">
                    <option value="">Carregando rodadas...</option>
                </select>
            </div>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Carregando ranking da rodada...</p>
            </div>

            <div id="rodadaContent" style="display: none;">
                <div class="rodada-info">
                    <h3>Informa√ß√µes da Rodada</h3>
                    <div class="info-grid" id="rodadaInfo"></div>
                </div>

                <div id="rankingContainer" class="ranking-container">
                    <div class="ranking-header">
                        <div>#</div>
                        <div>Participante</div>
                        <div>Pontos</div>
                        <div>PE</div>
                        <div>RC</div>
                        <div>GM</div>
                        <div>GV</div>
                    </div>
                    <div id="rankingList"></div>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i>üì≠</i>
                    <h3>Nenhum participante encontrado</h3>
                    <p>N√£o h√° palpites registrados para esta rodada.</p>
                </div>

                <div class="legenda">
                    <h4>Legenda:</h4>
                    <div class="legenda-item">
                        <div class="legenda-cor ouro"></div>
                        <span>1¬∫ Lugar</span>
                    </div>
                    <div class="legenda-item">
                        <div class="legenda-cor prata"></div>
                        <span>2¬∫ Lugar</span>
                    </div>
                    <div class="legenda-item">
                        <div class="legenda-cor bronze"></div>
                        <span>3¬∫ Lugar</span>
                    </div>
                    <div class="legenda-item">
                        <span>PE = Placar Exato</span>
                    </div>
                    <div class="legenda-item">
                        <span>RC = Resultado Correto</span>
                    </div>
                    <div class="legenda-item">
                        <span>GM = Gols Mandante</span>
                    </div>
                    <div class="legenda-item">
                        <span>GV = Gols Visitante</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Elementos DOM
        const selectRodadaEl = document.getElementById('selectRodada');
        const loadingEl = document.getElementById('loading');
        const rodadaContentEl = document.getElementById('rodadaContent');
        const rodadaInfoEl = document.getElementById('rodadaInfo');
        const rankingListEl = document.getElementById('rankingList');
        const emptyStateEl = document.getElementById('emptyState');

        // Estado da aplica√ß√£o
        let rodadasDisponiveis = [];
        let rodadaSelecionada = null;
        let rankingRodada = null;

        // Inicializa√ß√£o
        async function init() {
            try {
                // Obter dados da URL
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (!dataParam) {
                    showError('Dados n√£o encontrados na URL');
                    return;
                }

                // Decodificar dados
                const dadosJson = atob(dataParam);
                const dados = JSON.parse(dadosJson);
                
                if (dados.tipo !== 'ranking_rodada') {
                    showError('Tipo de dados inv√°lido');
                    return;
                }

                rodadasDisponiveis = dados.rodadas_disponiveis || [];
                rodadaSelecionada = dados.rodada_numero;

                // Preencher dropdown de rodadas
                renderRodadasDropdown();

                // Selecionar rodada inicial se especificada
                if (rodadaSelecionada) {
                    selectRodadaEl.value = rodadaSelecionada;
                    await carregarRankingRodada(rodadaSelecionada);
                }

                // Esconder loading
                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showError('Erro ao carregar dados');
            }
        }

        // Renderizar dropdown de rodadas
        function renderRodadasDropdown() {
            if (rodadasDisponiveis.length === 0) {
                selectRodadaEl.innerHTML = '<option value="">Nenhuma rodada dispon√≠vel</option>';
                return;
            }

            selectRodadaEl.innerHTML = '<option value="">Selecione uma rodada...</option>';
            
            rodadasDisponiveis.forEach(rodadaNum => {
                const option = document.createElement('option');
                option.value = rodadaNum;
                option.textContent = `Rodada ${rodadaNum}`;
                selectRodadaEl.appendChild(option);
            });

            // Adicionar listener para mudan√ßa
            selectRodadaEl.addEventListener('change', onRodadaSelecionada);
        }

        // Quando uma rodada √© selecionada
        async function onRodadaSelecionada(event) {
            const rodadaNum = parseInt(event.target.value);
            
            if (!rodadaNum) {
                rodadaContentEl.style.display = 'none';
                return;
            }

            rodadaSelecionada = rodadaNum;
            
            // Mostrar loading
            loadingEl.style.display = 'block';
            rodadaContentEl.style.display = 'none';
            emptyStateEl.style.display = 'none';

            try {
                // Carregar ranking da rodada
                await carregarRankingRodada(rodadaNum);
            } catch (error) {
                console.error('Erro ao carregar rodada:', error);
                showError('Erro ao carregar ranking da rodada');
            }
        }

        // Carregar ranking da rodada
        async function carregarRankingRodada(rodadaNum) {
            try {
                // Em produ√ß√£o, isso seria uma API real
                // Por enquanto, vamos simular dados
                await simularRankingRodada(rodadaNum);

            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                // Carregar dados simulados
                await simularRankingRodada(rodadaNum);
            }
        }

        // Simular dados do ranking (para desenvolvimento)
        async function simularRankingRodada(rodadaNum) {
            // Simular delay de rede
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Dados simulados
            const dadosRanking = {
                rodada_numero: rodadaNum,
                data_abertura: '10/01/2026',
                horario_fechamento: '20:00',
                total_participantes: 8,
                ranking: [
                    {
                        posicao: 1,
                        usuario_id: 1,
                        nome: 'Jo√£o Silva',
                        total_pontos: 42,
                        estatisticas: { pe: 2, rc: 3, gm: 5, gv: 4 },
                        pd_usada: true,
                        trunfo: true
                    },
                    {
                        posicao: 2,
                        usuario_id: 3,
                        nome: 'Maria Santos',
                        total_pontos: 38,
                        estatisticas: { pe: 1, rc: 4, gm: 6, gv: 3 },
                        pd_usada: false,
                        trunfo: false
                    },
                    {
                        posicao: 3,
                        usuario_id: 5,
                        nome: 'Pedro Oliveira',
                        total_pontos: 36,
                        estatisticas: { pe: 2, rc: 2, gm: 4, gv: 4 },
                        pd_usada: true,
                        trunfo: true
                    },
                    {
                        posicao: 4,
                        usuario_id: 2,
                        nome: 'Ana Costa',
                        total_pontos: 32,
                        estatisticas: { pe: 1, rc: 3, gm: 3, gv: 3 },
                        pd_usada: false,
                        trunfo: false
                    },
                    {
                        posicao: 5,
                        usuario_id: 4,
                        nome: 'Carlos Souza',
                        total_pontos: 28,
                        estatisticas: { pe: 0, rc: 4, gm: 4, gv: 2 },
                        pd_usada: false,
                        trunfo: true
                    },
                    {
                        posicao: 6,
                        usuario_id: 6,
                        nome: 'Fernanda Lima',
                        total_pontos: 24,
                        estatisticas: { pe: 1, rc: 2, gm: 3, gv: 1 },
                        pd_usada: true,
                        trunfo: false
                    },
                    {
                        posicao: 7,
                        usuario_id: 7,
                        nome: 'Roberto Alves',
                        total_pontos: 20,
                        estatisticas: { pe: 0, rc: 3, gm: 2, gv: 2 },
                        pd_usada: false,
                        trunfo: false
                    },
                    {
                        posicao: 8,
                        usuario_id: 8,
                        nome: 'Juliana Rocha',
                        total_pontos: 18,
                        estatisticas: { pe: 0, rc: 2, gm: 2, gv: 1 },
                        pd_usada: false,
                        trunfo: false
                    }
                ]
            };

            rankingRodada = dadosRanking;
            renderRankingInfo();
        }

        // Renderizar informa√ß√µes do ranking
        function renderRankingInfo() {
            if (!rankingRodada) return;

            // Informa√ß√µes da rodada
            rodadaInfoEl.innerHTML = `
                <div class="info-item">
                    <label>Rodada:</label>
                    <span>${rankingRodada.rodada_numero}¬™</span>
                </div>
                <div class="info-item">
                    <label>Data:</label>
                    <span>${rankingRodada.data_abertura}</span>
                </div>
                <div class="info-item">
                    <label>Participantes:</label>
                    <span>${rankingRodada.total_participantes}</span>
                </div>
                <div class="info-item">
                    <label>Hor√°rio limite:</label>
                    <span>${rankingRodada.horario_fechamento}</span>
                </div>
            `;

            // Renderizar ranking
            renderRankingList();

            // Mostrar/ocultar estados
            if (rankingRodada.ranking.length > 0) {
                emptyStateEl.style.display = 'none';
            } else {
                emptyStateEl.style.display = 'block';
            }

            // Esconder loading e mostrar conte√∫do
            loadingEl.style.display = 'none';
            rodadaContentEl.style.display = 'block';
        }

        // Renderizar lista de ranking
        function renderRankingList() {
            if (!rankingRodada || !rankingRodada.ranking) return;

            rankingListEl.innerHTML = '';

            rankingRodada.ranking.forEach(participante => {
                const rankingItem = document.createElement('div');
                rankingItem.className = `ranking-item posicao-${participante.posicao}`;
                
                // Verificar se √© mobile
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    rankingItem.innerHTML = `
                        <div class="posicao">${participante.posicao}¬∫</div>
                        <div class="nome-usuario">
                            ${escapeHtml(participante.nome)}
                            ${participante.trunfo ? ' üëë' : ''}
                            ${participante.pd_usada ? ' ‚≠ê' : ''}
                        </div>
                        <div class="pontuacao">${participante.total_pontos}</div>
                        <div class="estatisticas-mobile">
                            <div>PE: ${participante.estatisticas.pe}</div>
                            <div>RC: ${participante.estatisticas.rc}</div>
                            <div>GM: ${participante.estatisticas.gm}</div>
                            <div>GV: ${participante.estatisticas.gv}</div>
                        </div>
                    `;
                } else {
                    rankingItem.innerHTML = `
                        <div class="posicao">${participante.posicao}¬∫</div>
                        <div class="nome-usuario">
                            ${escapeHtml(participante.nome)}
                            ${participante.trunfo ? ' üëë' : ''}
                            ${participante.pd_usada ? ' ‚≠ê' : ''}
                        </div>
                        <div class="pontuacao">${participante.total_pontos}</div>
                        <div class="estatistica">${participante.estatisticas.pe}</div>
                        <div class="estatistica">${participante.estatisticas.rc}</div>
                        <div class="estatistica">${participante.estatisticas.gm}</div>
                        <div class="estatistica">${participante.estatisticas.gv}</div>
                    `;
                }

                rankingListEl.appendChild(rankingItem);
            });
        }

        // Fun√ß√µes auxiliares
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            loadingEl.innerHTML = `
                <div style="color: #dc3545; text-align: center;">
                    <p style="font-size: 2rem;">‚ö†Ô∏è</p>
                    <h3>Erro</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // Lidar com redimensionamento da tela
        window.addEventListener('resize', () => {
            if (rankingRodada) {
                renderRankingList();
            }
        });

        // Inicializar app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
